function CrudE(o){this._init=function(){this.divEdit=$("#divEdit");var t=0<this.divEdit.length;if(t){var e=_edit.Childs,i=null;if(null==o)i=new EditOne;else if(i=null===o[0]?new EditOne:o[0],1<o.length){i[e]=[];for(var n=1;n<o.length;n++)i[e][n-1]=o[n]}null!=(this.edit0=i).eform&&(this.eform0=i.eform),this.hasChild=_fun.hasValue(this.edit0[e])&&0<this.edit0[e].length,this._initForm(this.edit0)}this._nowFun="",this.modal=null,_me.crudE=this,_me.edit0=this.edit0,_me.eform0=this.eform0,_me.hasEdit=t,_me.divEdit=this.divEdit},this._initForm=function(t){if(null!=t.eform){_idate.init(t.eform),t.validator=_valid.init(t.eform);for(var e=this._getEditChildLen(t),i=0;i<e;i++)this._initForm(this._getEditChild(t,i))}},this.getEform0=function(){return this.edit0.eform},this.loadJson=function(t){for(var e=this.edit0,i=(e.loadRow(t),e.dataJson=t,this._getEditChildLen(e)),n=0;n<i;n++){var o=this._getEditChild(e,n);o.dataJson=this.getChildJson(t,n),o.loadRows(this.jsonGetRows(o.dataJson))}},this.afterOpen=function(t,e){_me.fnAfterOpenEdit&&_me.fnAfterOpenEdit(t,e)},this.setEditStatus=function(t){this._nowFun=t;var e,i=this.divEdit,n=this.edit0.eform,o=i.find("input, textarea, select, button");t==FunEstr.View?(_edit.removeIsNew(n),o.prop("disabled",!0),i.find("#btnToRead").prop("disabled",!1),_ihtml.setEdits(i,"",!1)):t==FunEstr.Create?(_edit.addIsNew(n),o.prop("disabled",!(e="[data-edit=U]")),o.filter(e).prop("disabled",!0),_ihtml.setEdits(i,"",!0),_ihtml.setEdits(i,e,!1)):t==FunEstr.Update&&(_edit.removeIsNew(n),o.prop("disabled",!(e="[data-edit=C]")),o.filter(e).prop("disabled",!0),_ihtml.setEdits(i,"",!0),_ihtml.setEdits(i,e,!1)),this.divEdit.find("span.error").remove()},this._hasFile=function(){var t=this.edit0;if(t.hasFile)return!0;for(var e=this._getEditChildLen(t),i=0;i<e;i++)if(this._getEditChild(t,i).hasFile)return!0;return!1},this._getUpdJson=function(t){for(var e=this.edit0,i=e.getUpdRow(),n=e.getKey(),o={},s=(e.hasFile&&(o=e.dataAddFiles("0",t)),!1),r=[],a=this._getEditChildLen(e),d=0;d<a;d++){var l=this._getEditChild(e,d),u=(l.hasFile&&(u=l.dataAddFiles("0"+d,t,l.rowsBox),_json.copy(u,o)),l.getUpdJson(n));null!=u&&(s=!0,r[d]=u)}var h={},f=!1;return null!=i&&(f=!0,h[_edit.Rows]=[i]),s&&(f=!0,h[_edit.Childs]=r),_json.isEmpty(o)||(f=!0,h[_edit.FileJson]=o),f?(_json.removeNull(h),h):null},this.validAll=function(){var t=this.edit0;if(_str.notEmpty(t.systemError))return _tool.msg(t.systemError),!1;if(!t.eform.valid())return!1;for(var e=this._getEditChildLen(t),i=0;i<e;i++){var n=this._getEditChild(t,i);if(_str.notEmpty(n.systemError))return _tool.msg(n.systemError),!1;if(!n.valid())return!1}return!0},this.afterSave=function(t){_fun.hasValue(this.edit0.fnAfterSave)&&this.edit0.fnAfterSave(),"0"===t.Value?_tool.msg(_BR.SaveNone):(_tool.alert(_BR.SaveOk+"("+t.Value+")"),_me.crudR&&(_me.crudR.dt.reload(),_me.crudR.toReadMode()))},this._resetForm=function(t){t.reset();for(var e=this._getEditChildLen(t),i=0;i<e;i++)this._getEditChild(t,i).reset()},this.isEditMode=function(){return this._nowFun!==FunEstr.View},this._updateOrViewA=async function(e,t){var i,n;return _me.fnUpdateOrViewA?_me.fnUpdateOrViewA(e,t):(i=this,n=e==FunEstr.Update?"GetUpdJson":"GetViewJson",_ajax.getJsonA(n,{key:t},function(t){i.loadJson(t),i.setEditStatus(e),i.afterOpen(e,t),_me.crudR.toEditMode(e)}))},this._getEditChild=function(t,e){return t[_edit.Childs][e]},this._getEditChildLen=function(t){var e=_edit.Childs;return null==t[e]?0:t[e].length},this.jsonGetRows=function(t){return null==t||null==t[_edit.Rows]?null:t[_edit.Rows]},this.getChildJson=function(t,e){var i=_edit.Childs;return null==t[i]||t[i].length<=e?null:t[i][e]},this.getChildRows=function(t,e){t=this.getChildJson(t,e);return this.jsonGetRows(t)},this.setChildRows=function(t,e,i){var n=_edit.Childs,t=(null==(t=null==t?{}:t)[n]&&(t[n]=[]),t[n].length<=e&&(t[n][e]={}),t[n][e]);return t[_edit.Rows]=i,t},this.editToNew=function(){var t=FunEstr.Create;this.setEditStatus(t),this.edit0.resetKey(),_prog.setPath(t)},this.getUpdRow=function(t,e,i){var n=_form.toRow(i);if(_edit.isNewRow(n))return n;for(var o,s,r,a,d=!1,l={},u=0;u<e.length;u+=2)a=_input.getObj(o=e[u],i,s=e[u+1]),(r=n[o])!=(a=a.data(_edit.DataOld))&&("date"!==s&&"dt"!==s||_date.dtsToValue(r)!==_date.dtsToValue(a))&&(l[o]=r,d=!0);return d?(l[t]=_input.get(t,i),l):null},this.getFileSid=function(t,e){return"t"+t+"_"+e},this.dataSetFileJson=function(t,e){var i,n;_json.isEmpty(e)||(i=_edit.FileJson,t.has(i)&&(n=t.get(i),e=_json.copy(e,n)),t.set(i,e))},this.viewFile=function(t,e,i,n){var o=_file.getFileExt(i.innerText);_file.isImageExt(o)&&_tool.showImage(i.innerHTML,_str.format("ViewFile?table={0}&fid={1}&key={2}&ext={3}",t,e,n,o))},this.onCreate=function(){var t=FunEstr.Create;this._resetForm(this.edit0),this.setEditStatus(t),this.afterOpen(t,null)},this.onUpdateA=async function(t){return _edit.removeIsNew(this.edit0.eform),this._updateOrViewA(FunEstr.Update,t)},this.onViewA=async function(t){return this._updateOrViewA(FunEstr.View,t)},this.onOpenModal=function(t,e,i,n){var o=_fun.getMe(!0).closest("tr");_tool.showArea(t,_itext.get(e,o),this.isEditMode(),function(t){_itext.set(e,t,o)})},this.onSaveA=async function(){if(this.validAll()){var t=this.edit0;if(_fun.hasValue(t.fnWhenSave)){var e=t.fnWhenSave();if(_str.notEmpty(e))return void _tool.msg(e)}var i,n,o,s,e=new FormData,r=this._getUpdJson(e);_json.isEmpty(r)?_tool.msg(_BR.SaveNone):(n=(i=t.isNewRow())?"Create":"Update",o=null,(s=this)._hasFile()?((o=e).append("json",_json.toStr(r)),i||o.append("key",t.getKey()),await _ajax.getJsonByFdA(n,o,function(t){s.afterSave(t)})):(o={json:_json.toStr(r)},i||(o.key=t.getKey()),await _ajax.getJsonA(n,o,function(t){s.afterSave(t)})))}else _tool.alert(_BR.InputWrong)},this._init()}function CrudR(e,i,n){this.temp={},this._init=function(){this.divRead=$("#divRead");var t=0<this.divRead.length;t&&(this.rform=$("#formRead"),0===this.rform.length&&(this.rform=null),this.rform2=$("#formRead2"),0===this.rform2.length&&(this.rform2=null),null!=this.rform&&_idate.init(this.rform),null!=this.rform2&&_idate.init(this.rform2),_var.notEmpty(e))&&(this.dt=new Datatable("#tableRead","GetPage",e,this._getFindCond(),null,null,_me.fnAfterFind||null)),this._updName=n,new CrudE(i),_prog.init(),_me.crudR=this,_me.hasRead=t,_me.divRead=this.divRead},this.dtCheck0=function(t,e){_str.isEmpty(t)&&(t=1);t="data-fid='"+_icheck.Check0Id+"' data-value='"+t+"'";return!1===e&&(t+=" readonly"),"<label class='xi-check x-no-label'>   <input "+t+" type='checkbox'>   <span class='xi-cspan'></span></label>"},this.dtRadio1=function(t,e){return _iradio.render(_icheck.Check0Id,"",!1,t,e=void 0===e?!0:e)},this.dtSetStatus=function(t,e,i){return""},this.dtStatusName=function(t){return"1"==t?"<span>"+_BR.StatusYes+"</span>":'<span class="text-danger">'+_BR.StatusNo+"</span>"},this.dtYesEmpty=function(t){return"1"==t?_BR.Yes:""},this.dtRed=function(t,e){return e?'<span class="text-danger">'+t+"</span>":"<span>"+t+"</span>"},this.dtCrudFun=function(t,e,i,n,o,s,r,a){var d="";return i&&(d+=`<button type="button" class="btn btn-link" data-onclick="${null==s?"_me.crudR.onUpdateA":s}" data-args="${t}"><i class="ico-pen" title="${_BR.TipUpdate}"></i></button>`),n&&(d+=`<button type="button" class="btn btn-link" data-onclick="${null==r?"_me.crudR.onDeleteA":r}" data-args="${t},${e}"><i class="ico-delete" title="${_BR.TipDelete}"></i></button>`),o&&(d+=`<button type="button" class="btn btn-link" data-onclick="${null==a?"_me.crudR.onViewA":a}" data-args="${t}"><i class="ico-eye" title="${_BR.TipView}"></i></button>`),d},this._getFindCond=function(){var t,e;return null==this.rform?null:(t=_form.toRow(this.rform),null!==(e=this.rform2)&&_obj.isShow(e)&&_json.copy(_form.toRow(e),t),t)},this.swap=function(t,e,i){var n,o,s;_me.hasRead&&_me.hasEdit?((n=_var.isEmpty(e))&&(e=_me.divEdit),s=t?(o=e,this.divRead):(o=this.divRead,e),o.addClass("x-off"),setTimeout(()=>{o.addClass("d-none").removeClass("x-off"),s.removeClass("d-none").addClass("x-on"),setTimeout(()=>{s.removeClass("x-on"),i&&i()},500)},200),n&&this._afterSwap(t)):i&&i()},this.toEditMode=function(t,e){this.swap(!1,null,e),_prog.setPath(t,this._updName)},this.toReadMode=function(){_prog.resetPath(),this.swap(!0)},this._afterSwap=function(t){_me.fnAfterSwap&&_me.fnAfterSwap(t)},this.onFind=function(){var t=this._getFindCond();this.dt.find(t)},this.onFind2=function(){var t=this.rform2;null!=t&&(_obj.isShow(t)?_form.hideShow([t]):_form.hideShow(null,[t]))},this.onResetFind=function(){_form.reset(this.rform),null!=this.rform2&&_form.reset(this.rform2)},this.onExport=function(){var t=this._getFindCond();window.location="Export?find="+_json.toStr(t)},this.onToRead=function(){this.toReadMode()},this.onCreate=function(){_me.crudE.onCreate(),this.toEditMode(FunEstr.Create)},this.onUpdateA=async function(t){await _me.crudE.onUpdateA(t)},this.onViewA=async function(t){await _me.crudE.onViewA(t)},this.onSetStatusA=async function(t,e){t=_icheck.checkedO($(t));await _ajax.getStrA("SetStatus",{key:e,status:t},function(t){_tool.alert(_BR.UpdateOk)})},this.onCheckAll=function(t,e,i){_icheck.setF(_input.fidFilter(i)+":not(:disabled)",_icheck.checkedO($(t)),e)},this.onDeleteA=async function(t,e){var i=this;_tool.ans(_BR.SureDeleteRow+" ("+e+")",async function(){await _ajax.getJsonA("Delete",{key:t},function(t){_tool.alert(_BR.DeleteOk),i.dt.reload()})})},this.onDeleteRowsA=async function(t,e){var i,n=_icheck.getCheckeds(t,e);0===n.length?_tool.msg(_BR.PlsSelectDeleted):(i=this,_tool.ans(_BR.SureDeleteSelected,async function(){await _ajax.getStrA("DeleteByKeys",{keys:n},function(t){_tool.alert(_BR.DeleteOk),i.dt.reload()})}))},this._init()}function Datatable(t,e,i,n,o,s,r){this.dt=null,this.findJson=n,this.recordsFiltered=-1,this.defaultShowOk=!0,this.showWork=null!=i.showWork&&i.showWork,this._fnAfterFind=r,this._keepStart=!1,this._start=0,this._nowShowOk=this.defaultShowOk,this.resetCount=function(){this.recordsFiltered=-1},this.find=function(t){this.findJson=t,this.resetCount(),this.dt.search("").draw(!this._keepStart)},this.reload=function(){this._keepStart=!0,this._nowShowOk=!1,this.find(this.findJson)},this.init=function(o,t,e,i,s){var t={pageLength:_fun.pageRows||10,lengthMenu:[10,20,50,100],processing:!1,serverSide:!0,jQueryUI:!1,filter:!1,paginate:!0,lengthChange:!0,info:!0,sorting:[],pagingType:"full_numbers",language:{url:"/locale/"+_fun.locale+"/dataTables.txt"},dom:`
t
<"row d-flex justify-content-between align-items-center mt-2"
    <"col d-flex align-items-center gap-2 li-container"li>
    <"col-auto"p>
>
`,initComplete:function(t,e){s&&$(this).closest(".tableRead_wrapper").find("div.toolbar").html(s);var i,n=$(o+"_filter input");0<n.length&&(n.off(),i=this.api(),n.on("keyup",function(t){"Enter"===t.key&&(this.resetCount(),i.search(this.value).draw())}))}.bind(this),ajax:{url:t,type:"POST",dataType:"json",data:function(t){var e;_me&&_me.fnWhenFind&&!_me.fnWhenFind()||(0<(e=t.order).length&&((e=e[0]).fid=t.columns[e.column].data),t.findJson=_json.toStr(this.findJson),t.recordsFiltered=this.recordsFiltered,this._keepStart&&(t.start=this._start))}.bind(this),dataSrc:function(t){this._start=this.dt.page.info().start,this._keepStart=!1;var e=_ajax.resultToErrMsg(t);return e?(_tool.msg(e),t.recordsFiltered=0,this.recordsFiltered=0,[]):(this.recordsFiltered=t.recordsFiltered,i?i(t):null===t.data||0===t.data.length?(_tool.alert(_BR.FindNone,"R"),this._fnAfterFind&&this._fnAfterFind({}),[]):(this._nowShowOk&&_tool.alert(_BR.FindOk),this._nowShowOk=this.defaultShowOk,this._fnAfterFind&&this._fnAfterFind(t),t.data))}.bind(this),error:function(t,e,i){_tool.hideWait(),_tool.msg("Datatable.js error."),null!=t&&(console.log("status"+t.status),console.log(i))}}},n=(e&&(_var.notEmpty(e.columnDefs)&&((n=e.columnDefs)[n.length]=_fun.dtColDef),t=_json.copy(e,t)),$(o));this.dt=n.DataTable(t),this.dt.settings()[0].showWork=this.showWork,n.on("preXhr.dt",function(t,e,i){e.showWork&&_fun.block()}),n.on("xhr.dt",function(t,e,i){e.showWork&&_fun.unBlock()})},this.init(t,e,i,o,s)}function EditMany(c,e,i,n,o){this.init=function(){var t;this.DataFkeyFid="_fkeyfid",this.mode=_edit.ModeBase,this.modeData="",this.isUrm=!1,this.kid=c,this.rowFilter=n,this.sortFid=o,this.systemError="",this.hasRowTpl=_str.notEmpty(i),this.hasRowFilter=_str.notEmpty(n),this.dataJson=null,this.hasRowTpl&&(this.rowTpl=$("#"+i).html(),t=$(this.rowTpl),null==_obj.get(c,t)&&(this.systemError=`EditMany.js input kid is wrong (${c})`,alert(this.systemError)),_edit.initVars(this,t)),this.hasEform=_str.notEmpty(e),this.hasEform&&(this.rowsBox=$("#"+e),this.eform=this.rowsBox.closest("form"),0==this.rowsBox.length)&&(this.systemError=`EditMany.js rowsBoxId is wrong (${e})`,alert(this.systemError)),this.deletedRows=[],this.newIndex=0},this.initUrm=function(t){this.mode=_edit.ModeUR,this.modeData=t,this.isUrm=!0},this._isNewBox=function(t){return"1"==_itext.get(_edit.IsNew,t)},this.reset=function(){this.fnReset?this.fnReset():this.isUrm?this._urmReset():this.hasEform&&(this.rowsBox.empty(),this._resetVar())},this._resetVar=function(){this.newIndex=0,this._resetDeletes()},this._resetDeletes=function(){this.deletedRows=[]},this._urmLoadRows=function(t){if(this._urmReset(),null!=t)for(var e=this.modeData,i=0;i<t.length;i++){var n=t[i],o=this.rowsBox.find(_input.fidFilter(n[e[1]]));_icheck.setO(o,1),o.data("key",n[e[0]])}},this._urmGetUpdJson=function(n){var t={},o=[],s=this,r=0,a=this.modeData;return this._resetDeletes(),this.rowsBox.find(":checkbox").each(function(){var t,e=$(this),i=e.data("key");_str.isEmpty(i)?_icheck.checkedO(e)&&((t={})[_edit.IsNew]="1",t[a[0]]=++r,t[a[1]]=_icheck.getO(e),s.rowSetFkey(t,n),o[o.length]=t):_icheck.checkedO(e)||s.deleteRow(i)}),0<o.length&&(t[_edit.Rows]=o),t[_edit.Deletes]=this.getDeletes(),t},this._urmReset=function(){this._resetVar();var t=this.rowsBox.find(":checkbox");_icheck.setO(t,0),t.data("key","")},this.loadRows=function(t){this.fnLoadRows?this.fnLoadRows(t):this.isUrm?this._urmLoadRows(t,_me.divRoles,_me.mUserRoleFids):this.loadRowsByRsb(t,!0)},this.loadRowByBox=function(t,e,i){e.Index=i;for(var n=$(Mustache.render(this.rowTpl,e)),o=0;o<this.fidTypeLen;o+=2)fid=this.fidTypes[o],_edit.setOld(_obj.get(fid,n),e[fid]);_idate.init(n),_form.loadRow(n,e),n.appendTo(t)},this.loadRowsByRsb=function(t,e,i){if(this._checkRowTpl()){i=this._getRowsBox(i),(_var.isEmpty(e)||e)&&this.reset(i);var n=null==t?0:t.length;if(0!=n)for(var o=0;o<n;o++)this.loadRowByBox(i,t[o],o)}},this.valid=function(){return this.fnValid?this.fnValid():!this.hasEform||this.eform.validTable(this.validator)},this.getKey=function(t){return _input.get(this.kid,t)},this._checkRowFilter=function(){return!!this.hasRowFilter||(_log.error("EditMany.js this.rowFilter is empty."),!1)},this._checkRowTpl=function(){return!!this.hasRowTpl||(_log.error("EditMany.js this.rowTpl is empty."),!1)},this._elmToRowBox=function(t){return this._checkRowFilter()?$(t).closest(this.rowFilter):null},this.idToRowBox=function(t){t=_input.fidFilter(this.kid)+`[value='${t}']`;return this.eform.find(t).parent()},this.getUpdJson=function(t){return this.fnGetUpdJson?this.fnGetUpdJson(t):this.isUrm?this._urmGetUpdJson(t):this.getUpdJsonByRsb(t,this.rowsBox)},this.getUpdJsonByRsb=function(t,e){var i={};return i[_edit.Rows]=this.getUpdRows(t,this._getRowsBox(e)),i[_edit.Deletes]=this.getDeletes(),i},this.getUpdRows=function(u,t){var h,f;if(this._checkRowFilter())return t=this._getRowsBox(t),this.setSort(t),h=[],t.find((f=this).rowFilter).each(function(t,e){var i,n=$(e),e=_input.get(f.kid,n);if(f._isNewBox(n))(i=_form.toRow(n))[f.DataFkeyFid]=u,h.push(i);else{for(var o,s,r,a={},d=!1,l=0;l<f.fidTypes.length;l+=2)"read"!==(s=f.fidTypes[l+1])&&(o=f.fidTypes[l],r=_obj.get(o,n),(s=_input.getO(r,n,s))!=_edit.getOld(r))&&(a[o]=s,d=!0);d&&(a[c]=e,h.push(a))}}),0===h.length?null:h},this.getDeletes=function(){return 0===this.deletedRows.length?null:this.deletedRows.join()},this.onAddRow=function(){this.addRow()},this.addRow=function(t,e,i){t=t||{},e=this._getRowsBox(e);e=this._renderRow(t,e);return i=this.setNewIdByBox(e,i),t[this.kid]=i,t},this.onDeleteRow=function(){var t=this._elmToRowBox(_fun.getMe());this.deleteRow(_itext.get(this.kid,t),t)},this.deleteRow=function(t,e){for(var i=this.deletedRows,n=!1,o=i.length,s=0;s<o;s++)if(i[s][this.kid]===t){n=!0;break}n||(i[o]=t),_obj.notEmpty(e)&&e.remove()},this.viewFile=function(t,e,i){var n=this.getKey(this._elmToRowBox(i));_me.crudE.viewFile(t,e,i,n)},this._renderRow=function(t,e){if(!this._checkRowTpl())return null;e=this._getRowsBox(e);var i=$(Mustache.render(this.rowTpl,t));return _form.loadRow(i,t),i.appendTo(e),i},this.dataAddFiles=function(r,a,t){if(!this.hasFile)return null;if(!this._checkRowFilter())return null;t=this._getRowsBox(t);var d=this,l={},u={};return t.find(d.rowFilter).each(function(t,e){for(var i=$(e),n=0;n<d.fileLen;n++){var o=d.fileFids[n],s=_me.crudE.getFileSid(r,o);_ifile.dataAddFile(a,o,s,i)&&(u[o]=null==u[o]?0:u[o]+1,l[s+u[o]]=d.getKey(i))}}),l},this.rowSetFkey=function(t,e){null!=t&&_edit.isNewRow(t)&&(t[this.DataFkeyFid]=e)},this.rowsSetFkey=function(t,e){if(null!=t)for(var i=0;i<t.length;i++){var n=t[i];null!=n&&_edit.isNewRow(n)&&(n[this.DataFkeyFid]=e)}},this.setNewIdByBox=function(t,e){null==e&&(this.newIndex--,e=this.newIndex);t=_obj.get(this.kid,t).parent();return _itext.set(this.kid,e,t),_edit.addIsNew(t),e},this.setSort=function(t){var i,n=this.sortFid;_str.isEmpty(n)||(t=(i=this)._getRowsBox(t)).find(_input.fidFilter(n)).each(function(t,e){_itext.set(n,t,$(e).closest(i.rowFilter))})},this._getRowsBox=function(t){return t||this.rowsBox},this.init()}function EditOne(e,i){this.init=function(){this.kid=e||"Id",i=i||"eform",this.eform=$("#"+i),this.dataJson=null,this.systemError="";var t=1!=this.eform.length?"EditOne.js input eformId is wrong. ("+i+")":null==_obj.get(this.kid,this.eform)?"EditOne.js input kid is wrong. ("+this.kid+")":"";t&&(this.systemError=t,alert(t)),_edit.initVars(this,this.eform)},this.getKey=function(){return _input.get(this.kid,this.eform)},this.getValue=function(t){return _input.get(t,this.eform)},this.isNewRow=function(){return"1"==_itext.get(_edit.IsNew,this.eform)},this.loadRow=function(t){_form.loadRow(this.eform,t);for(var e=0;e<this.fidTypeLen;e+=2)fid=this.fidTypes[e],_obj.get(fid,this.eform).data(_edit.DataOld,t[fid])},this.getUpdRow=function(){return _me.crudE.getUpdRow(this.kid,this.fidTypes,this.eform)},this.reset=function(){_form.reset(this.eform)},this.resetKey=function(){_itext.set(this.kid,"",this.eform)},this.setEdit=function(t){_form.setEdit(this.eform,t)},this.dataAddFiles=function(t,e){if(!this.hasFile)return null;for(var i={},n=0;n<this.fileLen;n++){var o=this.fileFids[n],s=_me.crudE.getFileSid(t,o);_ifile.dataAddFile(e,o,s,this.eform)&&(i[s]=this.getKey())}return i},this.viewFile=function(t,e,i){var n=this.getKey();_me.crudE.viewFile(t,e,i,n)},this.init()}var FunEstr={Create:"C",Read:"R",Update:"U",Delete:"D",View:"V"},InputTypeEstr={Check:"check",Date:"date",DateTime:"dt",Decimal:"dec",File:"file",Hide:"hide",Html:"html",Integer:"int",Link:"link",Modal:"modal",Password:"pwd",Radio:"radio",ReadOnly:"read",Select:"select",Sort:"sort",Text:"text",Textarea:"textarea"},MouseEstr={RightMenu:"contextmenu",MouseDown:"mousedown",MouseUp:"mouseup",MouseMove:"mousemove",MouseEnter:"mouseenter",MouseLeave:"mouseleave",DragStart:"dragstart",DragEnd:"dragend",DragMove:"dragmove",DragOver:"dragover",DragEnter:"dragenter",DragLeave:"dragleave",Drop:"drop"},NodeTypeEstr={Start:"S",End:"E",Node:"N"};class FlowMany{constructor(t,e,i){this.OrSep="{O}",this.AndSep="{A}",this.ColSep=",",this.FtMenu=".xf-menu",this.FtStartNode=".xf-start",this.InitLineCfg={stroke:"blue",strokeWidth:2},this.isEdit=!1,this.mNode=e,this.mLine=i,this.divLinesBox=$("#divLinesBox"),this.eformNodes=$("#eformNodes"),this.eformLines=$("#eformLines"),this.modalNodeProp=$("#modalNodeProp"),this.modalLineProp=$("#modalLineProp"),this.eformNodeProp=this.modalNodeProp.find("form"),this.tbodyLineCond=this.modalLineProp.find("tbody"),this.tplNode=$("#tplNode").html(),this.tplLine=$("#tplLine").html(),this.tplLineCond=$("#tplLineCond").html(),this.nowIsNode=!1,this.nowFlowItem=null;for(var n=[this.OrSep,") || (",this.AndSep," && ",",EQ,","=",",NEQ,","!=",",GT,",">",",GE,",">=",",ST,","<",",SE,","<="],o=(this.condOpExprs=[],this.condOpShows=[],0),s=0;s<n.length;s+=2)this.condOpExprs[o]=new RegExp(n[s],"g"),this.condOpShows[o]=n[s+1],o++;e=new FlowView(t);e.fnMoveNode=(t,e,i)=>this.fnMoveNode(t,e,i),e.fnAfterAddLine=t=>this.fnAfterAddLine(t),e.fnShowMenu=(t,e,i)=>this.fnShowMenu(t,e,i),this.flowView=e,this._setFlowEvent()}fnMoveNode(t,e,i){t=this.mNode.idToRowBox(t.getId());_form.loadRow(t,{PosX:Math.floor(e),PosY:Math.floor(i)})}fnAfterAddLine(t){this.mLine.addRow(t,null,t.Id)}fnShowMenu(t,e,i){this.nowIsNode=e,this.nowFlowItem=i;var e=e?this.isEdit&&i.getNodeType()==NodeTypeEstr.Node:this.isEdit,i="off",n=$(this.FtMenu);e?(n.find(".xd-edit").removeClass(i),n.find(".xd-delete").removeClass(i)):(n.find(".xd-edit").addClass(i),n.find(".xd-delete").addClass(i)),n.finish().toggle(100).css({position:"fixed",left:t.clientX+"px",top:t.clientY+"px"})}reset(){this.flowView.reset()}setEdit(t){this.isEdit=t,this.flowView.setEdit(t)}_setFlowEvent(){var i=this;$(document).on(MouseEstr.MouseDown,function(t){var e=i.FtMenu;0<!$(t.target).parents(e).length&&_obj.hide($(e))})}loadNodes(t){this.mNode.loadRowsByRsb(t,!0),this.flowView.loadNodes(t)}loadLines(t){if(this.mLine.loadRowsByRsb(t,!0),null!=t)for(var e=0;e<t.length;e++)t[e].Label=this._condStrToLabel(t[e].CondStr);this.flowView.loadLines(t)}addNode(t,e){t={Name:t==NodeTypeEstr.Start?"S":t==NodeTypeEstr.End?"E":"節點-"+this.flowView.getNewNodeId(),NodeType:t,PosX:100,PosY:100},t=this.mNode.addRow(t);this.flowView.addNode(t)}deleteNode(t){this.mNode.deleteRow(t.getId()),t.getLines().forEach(t=>{this.mLine.deleteRow(t.getId())}),this.flowView.deleteNode()}deleteLine(t){this.mLine.deleteRow(t.getId()),this.flowView.deleteLine(t)}_condStrToLabel(t){if(_str.isEmpty(t))return"";for(var e=0<t.indexOf(this.OrSep),i=0;i<this.condOpExprs.length;i++)t=t.replace(this.condOpExprs[i],this.condOpShows[i]);return t=e?"("+t+")":t}_condStrToList(t){if(_str.isEmpty(t))return null;for(var e=t.split(this.OrSep),i=e.length,n=1<i,o=[],s=0,r=0;r<i;r++)for(var a=e[r].split(this.AndSep),d=0;d<a.length;d++){var l=a[d].split(this.ColSep);o[s]={AndOr:n?this.OrSep:this.AndSep,Fid:l[0],Op:l[1],Value:l[2]},s++}return o}_getCondStr(){var i=this,n="";return this.tbodyLineCond.find("tr").each(function(t){var e=$(this),t=(0==t?"":_iselect.get("AndOr",e))+_itext.get("Fid",e)+i.ColSep+_iselect.get("Op",e)+i.ColSep+_itext.get("Value",e);n+=t}),n}showNodeProp(t){t=this.mNode.idToRowBox(t.getId());_form.loadRow(this.modalNodeProp,_form.toRow(t)),_modal.showO(this.modalNodeProp)}showLineProp(t){var e=this.mLine.idToRowBox(t.getId()),i=this.modalLineProp.find("form"),t=(_iread.set("FromNodeName",t.fromNode.getName(),i),_iread.set("ToNodeName",t.toNode.getName(),i),_iselect.set("FromType",t.getFromType(),i),_itext.set("Sort",_itext.get("Sort",e),i),_modal.showO(this.modalLineProp),this.tbodyLineCond.empty(),_itext.get("CondStr",e)),n=this._condStrToList(t);if(null!=n)for(var o=0;o<n.length;o++){var s=$(this.tplLineCond);_form.loadRow(s,n[o]),this.tbodyLineCond.append(s)}}onAddNode(t){t==NodeTypeEstr.Start&&this.flowView.hasStartNode()?_tool.msg("起始節點已經存在，不可再新增。"):this.addNode(t)}_menuStatus(t){return!t.classList.contains("off")}onMenuEdit(t){this._menuStatus(t)&&(this.nowIsNode?this.showNodeProp(this.nowFlowItem):this.showLineProp(this.nowFlowItem))}onMenuDelete(t){this._menuStatus(t)&&((t=this).nowIsNode?_tool.ans("是否確定刪除這個節點和流程線?",function(){t.deleteNode(t.nowFlowItem)}):_tool.ans("是否確定刪除這一條流程線?",function(){t.deleteLine(t.nowFlowItem)}))}onMenuView(t){}onAddLineCond(){var t={AndOr:this.AndSep,Op:"eq"},e=$(Mustache.render(this.tplLineCond,t));_form.loadRow(e,t),this.tbodyLineCond.append(e)}onDeleteLineCond(t){$(t).closest("tr").remove()}onModalNodeOk(){var t=_form.toRow(this.eformNodeProp),e=this.nowFlowItem,i=this.mNode.idToRowBox(e.getId()),n=_itext.get("Name",i);_form.loadRow(i,t),n!=t.Name&&e.setName(t.Name,!0),_modal.hideO(this.modalNodeProp)}onModalLineOk(){var t=this.modalLineProp,e={CondStr:this._getCondStr(),Sort:_itext.get("Sort",t),FromType:_iselect.get("FromType",t)},i=this.nowFlowItem,n=this.mLine.idToRowBox(i.getId());_form.loadRow(n,e),i.setLabel(this._condStrToLabel(e.CondStr)),i.setFromType(e.FromType),_modal.hideO(t)}}class FlowView{constructor(t){this.isEdit=!1,this.newNodeId=0,this.newLineId=0;t=document.getElementById(t);this.svg=SVG().addTo(t).size("100%","100%"),this.fnMoveNode=null,this.fnAfterAddLine=null,this.fnShowMenu=null}getNewNodeId(){return this.newNodeId++,this.newNodeId}getNewLineId(){return this.newLineId++,this.newLineId}setEdit(t){this.isEdit=t}reset(){this.nodes=[],this.lines=[],this.fromNode=null,Array.from(this.svg.node.childNodes).forEach(t=>{t.remove()})}loadNodes(t){this.reset();for(var e=0;e<t.length;e++)this.addNode(t[e])}loadLines(t){if(null!=t)for(var e=0;e<t.length;e++)this.addLine(t[e])}addNode(t){t=new FlowNode(this,t);return this.nodes.push(t),t}addLine(t){return new FlowLine(this,t)}deleteNode(t){t=t.getId();this.svg.findOne(`g[data-id="${t}"]`).remove()}deleteLine(t){t=t.getId();this.svg.find(`path[data-id="${t}"]`).remove()}drawLineStart(t){this.fromNode=t}drawLineEnd(t){var e={Id:this.newLineId,FromNodeId:this.fromNode.getId(),ToNodeId:t.getId()};return new FlowLine(this,e,this.fromNode,t),this.fromNode=null,e}idToNode(e){return this.nodes.find(t=>t.getId()==e)}hasStartNode(){return this.nodes.some(t=>t.getNodeType()==NodeTypeEstr.Start)}}class FlowNode{constructor(t,e){this.MinWidth=80,this.MinHeight=42,this.LineHeight=18,this.PadTop=8,this.PadLeft=15,this.PinWidth=12,this.PinGap=3,(this.self=this).flowView=t,this.svg=t.svg,this.json=Object.assign({Name:"Node",NodeType:NodeTypeEstr.Node,PosX:e.PosX||100,PosY:e.PosY||100},e),this.lines=[];t=this.json.NodeType;let i="",n="";this.elm=this.svg.group().attr("data-id",e.Id),this._isStartEnd()?(n=t==NodeTypeEstr.Start?(i="xf-start",NodeTypeEstr.Start):(i="xf-end",NodeTypeEstr.End),this.boxElm=this.elm.circle().addClass(i),e=window.getComputedStyle(this.boxElm.node),e=parseFloat(e.getPropertyValue("r")),this.boxElm.attr("r",e),this.nameElm=this.elm.text(n).addClass(i+"-text").attr({"text-anchor":"middle","dominant-baseline":"middle"})):(n=this.json.Name,i="xf-node",this.boxElm=this.elm.rect().addClass(i).attr({"text-anchor":"middle","dominant-baseline":"middle"}),this.nameElm=this.elm.text("").addClass(i+"-text"),this.setName(n,!1)),this.elm.move(this.json.PosX,this.json.PosY),t!=NodeTypeEstr.End&&(this.pinElm=this.elm.rect(this.PinWidth,this.PinWidth).addClass("xf-pin"),this._setPinPos()),this._setEvent()}getLines(){return this.lines}_isStartEnd(){return this.json.NodeType==NodeTypeEstr.Start||this.json.NodeType==NodeTypeEstr.End}getNodeType(){return this.json.NodeType}getPos(){var t=this.elm;return{x:t.x(),y:t.y()}}getSize(){var t=this.boxElm;return{w:t.width(),h:t.height()}}getCenter(){var t=this.boxElm;return{x:t.cx(),y:t.cy()}}_setPinPos(){var t,e;this.pinElm&&(t=this.nameElm.bbox(),e=this.getCenter(),this.pinElm.move(e.x+t.width/2+3,e.y-5))}_setEvent(){let i=this,n=this.flowView;this.elm.node.addEventListener("contextmenu",function(t){t.preventDefault(),n.fnShowMenu&&n.fnShowMenu(t,!0,i)}),this.elm.draggable().on(MouseEstr.DragMove,function(t){n.isEdit&&i._drawLines()}).on(MouseEstr.DragEnd,function(t){var e;n.isEdit&&({x:t,y:e}=t.detail.box,i.flowView.fnMoveNode)&&i.flowView.fnMoveNode(i,t,e)}),this._setEventPin()}_drawLines(){this.lines.forEach(t=>t.render())}_setEventPin(){if(this.pinElm){let n,o,s,r,a=null,d=this,l=this.flowView;this.pinElm.draggable().on(MouseEstr.DragStart,t=>{var e,i;l.isEdit&&({x:e,y:i}=d.pinElm.rbox(d.svg),o=e,s=i,n=d.self.elm.node,r=d.svg.line(o,s,o,s).addClass("xf-line off"),l.drawLineStart(d.self))}).on(MouseEstr.DragMove,t=>{var e,i;l.isEdit&&(t.preventDefault(),{x:t,y:i}=t.detail.box,t=t,i=i,r.plot(o,s,t,i),isFinite(t))&&isFinite(i)&&(e=t+(t=d.svg.node.getBoundingClientRect()).x,(e=document.elementsFromPoint(e,i+t.y).find(t=>t!=n&&(t.classList.contains("xf-node")||t.classList.contains("xf-end"))))?(i=e.instance,a!==i&&(a&&d._markNode(a,!1),a=i,d._markNode(a,!0))):a&&(d._markNode(a,!1),a=null))}).on(MouseEstr.DragEnd,t=>{var e;l.isEdit&&(a&&(d._markNode(a,!1),e=a.parent().node.dataset.id,e=l.drawLineEnd(l.idToNode(e)),a=null,l.fnAfterAddLine)&&l.fnAfterAddLine(e),r.remove())})}}_markNode(t,e){e?t.node.classList.add("on"):t.node.classList.remove("on")}getId(){return this.json.Id}addLine(t){this.lines.push(t)}deleteLine(e){var t=this.lines.findIndex(t=>t.Id==e.Id);this.lines.splice(t,1)}getName(){return this.nameElm.text()}setName(t,e){var n=_str.replaceAll(t,"\\n","\n").split("\n"),t=(this.nameElm.clear().text(function(i){n.forEach((t,e)=>{0<e?i.tspan(t).newLine().dy(this.LineHeight):i.tspan(t)})}),this.nameElm.bbox()),i=Math.max(this.MinWidth,t.width+2*this.PadLeft+this.PinWidth+2*this.PinGap),t=Math.max(this.MinHeight,t.height+2*this.PadTop);this.boxElm.size(Math.round(i),Math.round(t)),this.nameElm.center(this.boxElm.cx(),this.boxElm.cy()),e&&this._drawLines()}}class FlowLine{constructor(t,e,i,n){this.MaxCntCnt1=6,this.MinSideCnt2=16,this.MinCntCnt3=20,this.MinSideSide13=12,this.ArrowLen=10,this.ArrowWidth=5,this.FromTypeAuto="A",this.FromTypeV="V",this.FromTypeH="H",(e=e||{}).FromType=e.FromType||this.FromTypeAuto,e.Label=e.Label||"",e.Id=e.Id||t.getNewLineId(),this.flowView=t,this.json=e,this.svg=t.svg,this.fromNode=i||this.flowView.idToNode(e.FromNodeId),this.toNode=n||this.flowView.idToNode(e.ToNodeId),this.path=this.svg.path("").attr("data-id",e.Id).addClass("xf-line"),this.path2=this.svg.path("").attr("data-id",e.Id).fill("none").stroke({width:10,color:"transparent"}).attr({"pointer-events":"stroke",cursor:"pointer"}),this.labelElm=this.svg.text(e.Label).addClass("xf-line-text").font({anchor:"middle"}),this.arrow=this.svg.path("").addClass("xf-arrow"),this._setFromTypeVars(e.FromType),this.fromNode.addLine(this),this.toNode.addLine(this),this._setEvent(),this.render()}_setFromTypeVars(t){t=t||this.FromTypeAuto,this.fromType=t,this.isFromTypeV=t==this.FromTypeV,this.isFromTypeH=t==this.FromTypeH;var e=this.path.node;t==this.FromTypeAuto?e.classList.remove("xf-way"):e.classList.add("xf-way")}_setEvent(){var e=this;this.path2.node.addEventListener("contextmenu",function(t){t.preventDefault(),e.flowView.fnShowMenu&&e.flowView.fnShowMenu(t,!1,e)})}setLabel(t){this.labelElm.text(t)}render(){var e=this.fromNode.getPos(),t=this.fromNode.getSize();const i=e.x+t.w/2,n=e.y+t.h/2;var o={x:e.x+t.w/2,y:e.y},s={x:e.x+t.w/2,y:e.y+t.h},r={x:e.x,y:e.y+t.h/2},e={x:e.x+t.w,y:e.y+t.h/2},a=this.toNode.getPos(),d=this.toNode.getSize();const l=a.x+d.w/2,u=a.y+d.h/2;var h={x:a.x+d.w/2,y:a.y},f={x:a.x+d.w/2,y:a.y+d.h},c={x:a.x,y:a.y+d.h/2},a={x:a.x+d.w,y:a.y+d.h/2},_=l>i,m=u>n;const p=Math.abs(i-l),g=Math.abs(n-u);var w=p<=this.MaxCntCnt1,x=g<=this.MaxCntCnt1,y=p-t.w/2>=this.MinSideCnt2,v=g-d.h/2>=this.MinSideCnt2,d=p-d.w/2>=this.MinSideCnt2,t=g-t.h/2>=this.MinSideCnt2,E=(_?c.x-e.x:r.x-a.x)>=this.MinCntCnt3,b=(m?h.y-s.y:o.y-f.y)>=this.MinCntCnt3,F=_?c.x-e.x:r.x-a.x,T=m?h.y-s.y:o.y-f.y,O=F>=this.MinSideSide13,R=T>=this.MinSideSide13,F=F>=2*this.MinSideSide13,T=T>=2*this.MinSideSide13;let k,N,M,S=0;if(!this.isFromTypeH&&w&&R)N=m?(k=s,h):(k=o,f),M=[k,{x:k.x,y:N.y}];else if(!this.isFromTypeV&&x&&O)N=_?(k=e,c):(k=r,a),M=[k,{x:N.x,y:k.y}];else if(!this.isFromTypeV&&y&&t)k=_?e:r,N=m?h:f,M=[k,{x:N.x,y:k.y},N],S=1;else if(!this.isFromTypeH&&v&&d)k=m?s:o,N=_?c:a,M=[k,{x:k.x,y:N.y},N];else if(!this.isFromTypeH&&T&&b){N=m?(k=s,h):(k=o,f);w=(k.y+N.y)/2;M=[k,{x:k.x,y:w},{x:N.x,y:w},N]}else if(!this.isFromTypeV&&F&&E){N=_?(k=e,c):(k=r,a);R=(k.x+N.x)/2;M=[k,{x:R,y:k.y},{x:R,y:N.y},N],S=1}else if(!this.isFromTypeH&&E){let t;t=m?(k=s,N=f,Math.max(k.y,N.y)+this.MinSideSide13):(k=o,N=h,Math.min(k.y,N.y)-this.MinSideSide13),M=[k,{x:k.x,y:t},{x:N.x,y:t},N]}else if(!this.isFromTypeV&&b){let t;t=_?(k=e,N=a,Math.max(k.x,N.x)+this.MinSideSide13):(k=r,N=c,Math.min(k.x,N.x)-this.MinSideSide13),M=[k,{x:t,y:k.y},{x:t,y:N.y},N],S=1}else N=m?_?(k=this.isFromTypeH?e:s,c):(k=this.isFromTypeH?r:s,a):_?(k=this.isFromTypeH?e:o,c):(k=this.isFromTypeH?r:o,a),M=[k,N];this._drawLine(M),this.labelElm.center((M[S].x+M[S+1].x)/2,(M[S].y+M[S+1].y)/2)}_drawLine(e){let i=`M ${e[0].x} `+e[0].y;var n=e.length,o=this.MaxCntCnt1;for(let t=1;t<n;t++){var s,r,a,d,l,u=e[t-1],h=e[t];t<n-1?(s=e[t+1],u={x:h.x-u.x,y:h.y-u.y},s={x:s.x-h.x,y:s.y-h.y},r=Math.sqrt(Math.pow(u.x,2)+Math.pow(u.y,2)),d=Math.sqrt(Math.pow(s.x,2)+Math.pow(s.y,2)),r=h.x-(u={x:u.x/r,y:u.y/r}).x*o,a=h.y-u.y*o,d=h.x+(s={x:s.x/d,y:s.y/d}).x*o,l=h.y+s.y*o,i=(i+=` L ${r} `+a)+(` A ${o} ${o} 0 0 ${u.x*s.y-u.y*s.x<0?0:1} ${d} `+l)):i+=` L ${h.x} `+h.y}this.path.plot(i),this.path2.plot(i),this._drawArrow(e[n-2],e[n-1])}_drawArrow(t,e){t=Math.atan2(e.y-t.y,e.x-t.x);const i=e.x-this.ArrowLen*Math.cos(t)+this.ArrowWidth*Math.cos(t-Math.PI/2),n=e.y-this.ArrowLen*Math.sin(t)+this.ArrowWidth*Math.sin(t-Math.PI/2),o=e.x-this.ArrowLen*Math.cos(t)+this.ArrowWidth*Math.cos(t+Math.PI/2),s=e.y-this.ArrowLen*Math.sin(t)+this.ArrowWidth*Math.sin(t+Math.PI/2);this.arrow.plot(`M ${e.x} ${e.y} L ${i} ${n} M ${e.x} ${e.y} L ${o} `+s)}getId(){return this.json.Id}getFromType(){return this.json.FromType}setFromType(t){t!=this.json.FromType&&(this._setFromTypeVars(t),this.render())}}function Page(t){this.pager=t.pager,this.linker=t.linker,this.action=t.action,this.showMenu=t.showMenu||_var.notEmpty(t.pageRowList),this.pageRowList=t.pageRowList||[10,25,50,100],this._init=function(t,e){this.pageArg=this._getPageArg(t);var i,n,o,s,t=this.pageArg,r=this.pager;t.filterRows<=0?(_obj.hide(r),_tool.msg(_BR.FindNone)):(i="",this.showMenu&&(i=(s=_BR.Page.split("@@"))[0].replace("_Menu",this._getMenuHtml()),o=(n=(t.pageNo-1)*t.pageRows+1)+t.pageRows-1,s=s[1].replace("_Start",n).replace("_End",o<=t.filterRows?o:t.filterRows).replace("_Total",t.filterRows),i=_str.format("<div class='x-page-menu'><label>{0}<span>{1}</span></label></div>",i,s)),r.html(i+"<div class='x-page-btns'></div>"),r.find("select").change(function(){e()}),r.find(".x-page-btns").pagination({currentPage:t.pageNo,itemsOnPage:t.pageRows,items:t.filterRows,listStyle:"pagination "+(this.showMenu?"x-has-menu":"x-no-menu"),prevText:"<",nextText:">",onPageClick:e}))},this._getMenuHtml=function(){for(var t="<select class='form-select x-inline x-w100'>",e=0;e<this.pageRowList.length;e++)t+=_str.format("<option value='{0}'{1}>{0}</option>",this.pageRowList[e],this.pageArg.pageRows==this.pageRowList[e]?" selected":"");return t+="</select>"},this._getPageArg=function(t){t=JSON.parse(_html.decode(t));return null==t.pageNo&&(t.pageNo=1),null==t.pageRows&&(t.pageRows=0),null==t.filterRows&&(t.filterRows=-1),t},this.find=function(t,e){t=t||{};var i,n=this.pageArg,o=(_var.isEmpty(e)?(n.pageNo=1,n.filterRows=-1,n.pageRows=this.pager.find("select").val()):n.pageNo=e,this.action+"?page="+n.pageNo+"&rows="+n.pageRows+"&filter="+n.filterRows);for(i in t)_str.notEmpty(t[i])&&(o+="&"+i+"="+t[i]);e=this.linker;_obj.isEmpty(e)?window.location=o:(e.attr("href",o),e.trigger("click"))},this._init(t.pageStr,t.onFind)}var _ajax={getJsonA:async function(t,e,i,n){return _ajax._rpcA({url:t,type:"POST",data:e,dataType:"json"},i)},getJsonByFdA:async function(t,e,i,n){return _ajax._rpcA({url:t,type:"POST",data:e,dataType:"json",cache:!1,contentType:!1,processData:!1},i,n)},getStrA:async function(t,e,i,n){return _ajax._rpcA({url:t,type:"POST",data:e,dataType:"text"},i,n)},getIntA:async function(t,e,i,n){return _ajax._rpcA({url:t,type:"POST",data:e,dataType:"text"},i,n)},getViewA:async function(t,e,i,n){return _ajax._rpcA({url:t,type:"POST",data:e,dataType:"html"},i,n)},getImageFileA:async function(t,e,i){return _ajax._rpcA({url:t,type:"POST",data:e,dataType:"html"},null,i)},_rpcA:async function(t,e,i){(i=_var.isEmpty(i)?!0:i)&&_fun.block(i);var n=!1,o=null;try{_jwt.jsonAddJwtHeader(t);var o=await $.ajax(t),s=_ajax.resultToErrMsg(o);if(_str.notEmpty(s))o=null,_tool.msg(s);else if(o.ErrorRows&&0<o.ErrorRows.length)for(var r={},a=0;a<o.ErrorRows.length;a++){var d=o.ErrorRows[a],l=_str.isEmpty(d.FormId)?_me.edit0:$("#"+d.FormId);r[d.Fid]=d.Msg,l.validator.showErrors(r)}else e&&(e(o),n=!0)}catch(t){console.error(t)}return i&&_fun.unBlock(i),null==e?o:n},_isBrError:function(t){return 2<=t.length&&t.substring(0,2)===_fun.PreBrError},resultToErrMsg:function(t){return t[_fun.FidErrorMsg]?_ajax.strToErrMsg(t[_fun.FidErrorMsg]):""},strToErrMsg:function(t){var e;return _str.isEmpty(t)?"":_ajax._isBrError(t)?(e=t.substring(2),_BR[e]||_str.format("_ajax.strToErrMsg() failed, no BR Fid={0}",e)):t}},_array={find:function(t,e){if(null!=t)for(var i=0;i<t.length;i++)if(t[i]==e)return i;return-1},toStr:function(t,e){return t.join(e=e||",")},isEmpty:function(t){return null==t||0==t.length}},_assert={echo:function(t){_error.log("_assert.js "+t)},inArray:function(t,e){var i,n=!1;for(i in e)if(i==t){n=!0;break}n||_assert.echo("inArray failed: "+t)}},_browser={_langCode:"_langCode",pushState:function(t){history.pushState(null,null,t)},zz_print:function(t,e,i){_browser.printO(_obj.getById(t,e,i))},zz_printO:function(t,e){window.print()}},_btn={setEdit:function(t,e,i){_btn.setEditO(_obj.getById(t,i),e)},setEditO:function(t,e){t.prop("disabled",!e)},setEditF:function(t,e,i){_btn.setEditO(_obj.getF(t,i),e)}},_chart={rainbowColors:["#F32E37","#EABE37","#89E926","#22E352","#2FE5E8","#295AE7","#8828EE","#E629B7"],_show:function(t,e,i,n,o){null==o&&(o=!1);t={type:"hbar"==t?"bar":t,data:{labels:i.labels,datasets:[{data:i.values}]},options:{plugins:{legend:{position:"bottom",display:n=null==n?!0:n},animation:{animateScale:!0,animateRotate:!0},title:{display:!0,text:i.title,font:{size:16}}}}};return null!=i.options&&(t.options=_json.copy(i.options,t.options)),o&&(t.options.plugins.tooltip={callbacks:{label:function(t){var e,i=t.dataset.data,i=(null==t.chart._sum&&(e=0,i.map(t=>{e+=t}),t.chart._sum=e),null==t._oldLabel&&(t._oldLabel=t.label+" "+t.formattedValue),(100*i[t.dataIndex]/t.chart._sum).toFixed(2)+"%");return t._oldLabel+" ("+i+")"}}}),new Chart(e,t)},line:function(t,e){return _chart._show("line",t,e,!1)},hbar:function(t,e){return e.options={indexAxis:"y"},_chart._show("hbar",t,e,!1)},pie:function(t,e){return _chart._show("pie",t,e,null,!0)},doughnut:function(t,e){return _chart._show("doughnut",t,e,null,!0)},groupLine:function(t,e){return _chart._show("line",t,e)},groupBar:function(t,e){return _chart._show("bar",t,e)},drawLine:function(t,e,i,n){_chart._clear(),_chart._nowChart=new Chart(document.getElementById(t),{type:"line",data:{labels:e,datasets:[{data:i,borderColor:n,fill:!1}]},options:{plugins:{legend:{display:!1}}}})},initPie:function(t,e,i,n,o){e={type:"pie",options:{legend:{position:"right",labels:{boxWidth:10}}},data:{labels:e,datasets:[{data:i,backgroundColor:n,borderWidth:1}]}};return o&&(e=_json.copy(o,e)),new Chart(t,e)}},_date={getStartEnd:function(t,e,i){},uiToday:function(){var t=moment();return _date.mmToUiDate(t)},uiWeekMonday:function(){var t=moment().day(1);return _date.mmToUiDate(t)},uiWeekFriday:function(){var t=moment().day(5);return _date.mmToUiDate(t)},uiMonthDay1:function(){var t=moment().startOf("month");return _date.mmToUiDate(t)},uiMonthDayLast:function(){var t=moment().endOf("month");return _date.mmToUiDate(t)},nowYear:function(){return(new Date).getFullYear()},mmToUiDate:function(t){return t.format(_BR.MmUiDateFmt)},mmToUiDt:function(t){return t.format(_BR.MmUiDtFmt)},mmToUiDt2:function(t){return t.format(_BR.MmUiDt2Fmt)},dtsToUiDate:function(t){return _str.isEmpty(t)?"":_date.mmToUiDate(moment(t,_fun.MmDtFmt))},dtsToFormat:function(t){return _str.isEmpty(t)?"":_date.mmToUiDate(moment(t,_fun.MmDateFmt))},dtsToFormat:function(t,e){return _str.isEmpty(t)?"":moment(t,_fun.MmDtFmt).format(e)},dtsToUiDt:function(t){return _str.isEmpty(t)?"":_date.mmToUiDt(moment(t,_fun.MmDtFmt))},dtsToUiDt2:function(t){return _str.isEmpty(t)?"":_date.mmToUiDt2(moment(t,_fun.MmDtFmt))},dtsToValue:function(t){return _str.isEmpty(t)?0:moment(t,_fun.MmDtFmt).valueOf()},dtsToMoment:function(t){return _str.isEmpty(t)?null:moment(t,_fun.MmDtFmt)},uiToMmDate:function(t){return _str.isEmpty(t)?"":moment(t,_BR.MmUiDateFmt).format(_fun.MmDateFmt)},tsToUiDt:function(t){return""==t?"":moment(1e3*parseInt(t)).format(_BR.MmUiDtFmt)},getHourStr:function(t){},getDt:function(t,e,i){t=_idate.get(t,i),e=_iselect.get(e,i);return""==t?"":""==e?t:t+" "+e},isBig:function(t,e){return moment(t,_fun.MmDtFmt).isAfter(moment(e,_fun.MmDtFmt))},getMonthDiff:function(t,e){return _str.isEmpty(start)||_str.isEmpty(end)?0:_date.getMonthDiffByDate(moment(t,_fun.MmDtFmt),moment(e,_fun.MmDtFmt))},getMonthDiffByDate:function(t,e){return 12*(e.getFullYear()-t.getFullYear())+e.getMonth()-t.getMonth()+1},dsAddYear:function(t,e){return moment(t,_fun.MmDtFmt).add(e,"y").format(_fun.MmDtFmt)}},_dom={getData:function(t,e){return t.getAttribute("data-"+e)},setData:function(t,e,i){t.setAttribute("data-"+e,i)}},_edit={Rows:"_rows",Childs:"_childs",Deletes:"_deletes",FileJson:"_fileJson",DataOld:"_old",IsNew:"_IsNew",ModeBase:"Base",ModeUR:"UR",initVars:function(i,t){var n=[];t.find(_input.fidFilter()).each(function(t,e){e=$(e),t*=2;n[t]=_input.getFid(e),n[1+t]=_input.getType(e)}),i.fidTypes=n,i.fidTypeLen=i.fidTypes.length,i.fileFids=[],t.find("[data-type=file]").each(function(t,e){i.fileFids[t]=_input.getFid($(e))}),i.fileLen=i.fileFids.length,i.hasFile=0<i.fileFids.length},getOld:function(t){return t.data(_edit.DataOld)},setOld:function(t,e){t.data(_edit.DataOld,e)},isNewRow:function(t){var e=_edit.IsNew;return null!=t[e]||"1"==t[e]},addIsNew:function(t){var e=_edit.IsNew,i=t.find(_input.fidFilter(e));0==i.length?t.append(`<input type="hidden" data-fid="${e}" name="${e}" value="1" >`):i.val("1")},removeIsNew:function(t){var e=_edit.IsNew,t=t.find(_input.fidFilter(e));0<t.length&&t.remove()}},_error={log:function(t){console.log(t)}},_file={getFileName:function(t){var e=0<t.indexOf("/")?"/":"\\";return _str.getTail(t,e)},getFileExt:function(t){return _str.getTail(t,".").toLowerCase()},isImageExt:function(t){return 0<=",jpg,jpeg,png,gif,tif,tiff,".indexOf(","+t+",")},isExcelExt:function(t){return 0<=",xls,xlsx,".indexOf(","+t+",")}},_form={toRow:function(e){var i={};return e.find(_input.fidFilter()).filter(":not(.xi-unsave)").each(function(){var t=$(this);i[_input.getFid(t)]=_input.getO(t,e)}),i},toRowStr:function(t){return JSON.stringify(_form.toRow(t))},loadRow:function(t,e){for(var i in e)_input.set(i,e[i],t)},reset:function(t){t.find(_input.fidFilter()).each(function(){_input.setO($(this),"",t)})},hasFile:function(t){return 0<t.find(":file").length},setEdit:function(t,e){_itext.setEditO(t.find("input:text"),e),_itextarea.setEditO(t.find("textarea"),e),_idate.setEditO(t.find(".date input"),e),_iselect.setEditO(t.find("select"),e),_icheck.setEditO(t.find(":checkbox"),e),_iradio.setEditO(t.find(":radio"),e),_btn.setEditO(t.find("button"),e)},hideShow:function(t,e){if(t)for(var i=0;i<t.length;i++){var n=t[i];n.fadeOut(500,function(){_obj.hide(n)})}if(e)for(i=0;i<e.length;i++){var o=e[i];o.fadeIn(500,function(){_obj.show(o)})}}},_formData={},_fun={MmDateFmt:"YYYY/MM/DD",MmDtFmt:"YYYY/MM/DD HH:mm:ss",FidErrorMsg:"_ErrorMsg",PreBrError:"B:",HideRwd:"x-hide-rwd",locale:"zh-TW",maxFileSize:50971520,isRwd:!1,pageRows:10,userId:"",nowDom:"",data:{},dtColDef:{className:"x-center",orderable:!1,targets:"_all"},init:function(t){_fun.locale=t,_leftmenu.init(),_pjax.init(".x-main-right"),_tool.init(),moment.locale(_fun.locale);t=$("body");_fun.setEvent(t,"click"),_fun.setEvent(t,"change"),$.ajaxSetup({headers:{RequestVerificationToken:$('meta[name="csrf-token"]').attr("content")}})},onHelloA:async function(){await _ajax.getStrA("../Fun/Hello",null,function(t){alert(t)})},getMe:function(t){return t?$(_fun.nowDom):_fun.nowDom},setEvent:function(t,e){var s="on"+e;t.on(e,`[data-${s}]`,function(){_fun.nowDom=this;var t=$(this),e=t.data(s),t=t.data("args"),t=(t=null==t?"":t.toString())?t.split(","):[],i=e.split(".");let n=window;for(let t=0;t<i.length-1;t++)n=n[i[t]];var o=i[i.length-1],o=n[o];"function"==typeof o?o.apply(n,t):console.warn(`Function ${e} not found`)})},default:function(t,e){return null==t?e:t},hasValue:function(t){return!(null==t)},onSetLocaleA:async function(t){await _ajax.getStrA("../Fun/SetLocale",{code:t},function(t){location.reload()})},block:function(t){_obj.show(_tool.xgWork)},unBlock:function(t){_obj.hide(_tool.xgWork)}},_helper={getBaseProp:function(t,e,i,n,o,s,r){n=_str.format("type='{0}' data-id='{1}' name='{2}' value='{3}'",n,e,e+t,i);return!0===o&&(n+=" required"),!1===s&&(n+=" readonly"),_str.notEmpty(r)&&(n+=" "+r),_str.trim(n)},getEventAttr:function(t,e,i){return _str.isEmpty(e)?"":(t=`data-${t}='${e}'`,_str.notEmpty(i)&&(t+=` data-args='${i}'`),t)}},_html={encodeRow:function(t,e){for(var i=0;i<e.length;i++){var n=e[i];t[n]=_html.encode(t[n])}return t},encode:function(t){return $("<div/>").text(t).html()},decode:function(t){return $("<div/>").html(t).text()},update:function(t,e){t="#"+t,e=void 0===e?$(t):e.find(t);e.summernote("code",e.text())},updates:function(t,e){for(var i=0;i<t.length;i++)_html.update(t[i],e)}},_ibase={get:function(t,e){return this.getO(_obj.get(t,e))},getF:function(t,e){return this.getO(_obj.getF(t,e))},getD:function(t,e){return this.getO(_obj.getD(t,e))},getO:function(t){return null==t?null:t.val()},getBorder:function(t){return t},set:function(t,e,i){this.setO(_obj.get(t,i),e)},setF:function(t,e,i){this.setO(_obj.getF(t,i),e)},setO:function(t,e){t.val(e),t.text(e)},setEdit:function(t,e,i){this.setEditO(_obj.get(t,i),e)},setEditF:function(t,e,i){this.setEditO(_obj.getF(t,i),e)},setEditO:function(t,e){t.prop("readonly",!e)}},_icheck=$.extend({},_ibase,{Check0Id:"_check0",getO:function(t){return t.is(":checked")?t.data("value"):"0"},setO:function(t,e){t.prop("checked",!(null==e||"0"==e||"False"==e||0==e))},setEditO:function(t,e){t.prop("disabled",!e)},checked:function(t,e){return _icheck.checkedO(_obj.get(t,e))},checkedF:function(t,e){return _icheck.checkedO(_obj.getF(t,e))},checkedO:function(t){return t.is(":checked")},getCheckeds:function(t,e){e=e||_icheck.Check0Id;var i=[];return _obj.getF(_input.fidFilter(e)+":checked",t).each(function(t){i[t]=$(this).data("value")}),i},checkAll:function(t,e,i){i=i||_icheck.Check0Id;i=_input.fidFilter(i);_icheck.setO(t.find(i),e)}}),_icolor={init:function(){$(".x-color").colorpicker({})},get:function(t,e){return _icolor.getO(_obj.get(t,e))},getF:function(t,e){return _icolor.getO(_obj.getF(t,e))},getO:function(t){return _icolor.rgbToHex(t.find("i").css("background-color"))},rgbToHex:function(t){var e=t.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);delete e[0];for(var i=1;i<=3;++i)e[i]=parseInt(e[i]).toString(16),1==e[i].length&&(e[i]="0"+e[i]);return"#"+e.join("")}},_idate=$.extend({},_ibase,{BoxFilter:".date",getO:function(t){return _date.uiToMmDate(t.val())},setO:function(t,e){_idate._boxSetDate(_idate._objToBox(t),e)},setEditO:function(t,e){t.prop("disabled",!e)},init:function(t,e){e=_str.isEmpty(e)?t.find(_idate.BoxFilter):_obj.get(e,t).closet(_idate.BoxFilter);0!=e.length&&(e.datepicker({language:_fun.locale,autoclose:!0,showOnFocus:!1,todayHighlight:!0}).on("changeDate",function(t){_idate._boxGetInput($(this)).valid()}),e.find(".input-group-addon").off("click"))},onToggle:function(){var t=_fun.getMe();_idate._elmToBox(t).datepicker("show")},onReset:function(){var t=_fun.getMe(),t=_idate._elmToBox(t),e=_idate._boxGetInput(t);_idate.getEditO(e)&&_idate._boxSetDate(t,"")},getEditO:function(t){return!t.is(":disabled")},_elmToBox:function(t){return _idate._objToBox($(t))},_objToBox:function(t){return t.closest(_idate.BoxFilter)},_boxSetDate:function(t,e){t.datepicker("update",e),t.trigger({type:"changeDate",date:e})},_boxGetInput:function(t){return t.find("input")}}),_idt=$.extend({},_idate,{getO:function(t){var e=_idate.getO(_idt._boxGetDate(t));return _str.isEmpty(e)?"":e+" "+_iselect.getO(_idt._boxGetHour(t))+":"+_iselect.getO(_idt._boxGetMin(t))},setO:function(t,e){var i,n,e=_str.isEmpty(e)?(i="",n=0):(i=e,n=parseInt(_str.getMid(e," ",":")),parseInt(_str.getMid(e,":",":")));_idate.setO(_idt._boxGetDate(t),i),_iselect.setO(_idt._boxGetHour(t),n),_iselect.setO(_idt._boxGetMin(t),e)},setEditO:function(t,e){_idate.setEditO(_idt._boxGetDate(t),e),_iselect.setEditO(_idt._boxGetHour(t),e),_iselect.setEditO(_idt._boxGetMin(t),e)},_boxGetDate:function(t){return t.find("input:first")},_boxGetHour:function(t){return t.find("select:first")},_boxGetMin:function(t){return t.find("select:last")}}),_ifile=$.extend({},_ibase,{getBorder:function(t){return t.prev()},setO:function(t,e){t.val(e),_ifile._elmToLink(t).text(e)},dataAddFile:function(t,e,i,n){e=_obj.get(e,n),n=_ifile.getUploadFile(_ifile._elmToFile(e)),e=null!=n;return e&&t.append(i,n),e},onOpenFile:function(){var t=_fun.getMe();_ifile._elmToFile(t).focus().trigger("click")},onChangeFile:function(){var t=_fun.getMe(),e=_ifile._elmToObj(t),i=$(t),n=t.value;if(_str.isEmpty(n))_ifile.setO(e,"");else{var o=i.data("exts").toLowerCase();if(_str.notEmpty(o)&&"*"!==o){var s=_file.getFileExt(n);if((o=","+o+",").indexOf(","+s+",")<0)return _tool.msg(_BR.UploadFileNotMatch),void(t.value="")}o=i.data("max");t.files[0].size>1024*o*1024?(_tool.msg(_str.format(_BR.UploadFileNotBig,o)),t.value=""):_ifile.setO(e,_file.getFileName(n))}},onDeleteFile:function(){var t=_fun.getMe();_ifile.setO(_ifile._elmToObj(t),"")},zz_init:function(t,e,i){_obj.get(t,i).val("")},_elmToBox:function(t){return $(t).closest(".xi-box")},_elmToFile:function(t){return _ifile._boxGetFile(_ifile._elmToBox(t))},_elmToObj:function(t){return _ifile._boxGetObj(_ifile._elmToBox(t))},_elmToLink:function(t){return _ifile._boxGetLink(_ifile._elmToBox(t))},_boxGetLink:function(t){return t.find("a").last()},_boxGetFile:function(t){return t.find(":file")},_boxGetObj:function(t){return t.find("[data-type=file]")},getUploadFile:function(t){return 0!=t.length&&0<(t=t.get(0).files).length?t[0]:null}}),_ihtml=$.extend({},_ibase,{Filter:"[data-type=html]",getO:function(t){return t.summernote("code")},setO:function(t,e){t.summernote("code",e)},setEditO:function(t,e){t.summernote(e?"enable":"disable")},init:function(n,e,i){n.eform.find(_ihtml.Filter).each(function(){var t=$(this);t.data("prog",e),t.summernote({height:i||200,callbacks:{onChange:function(t,e){var i=$(this);i.summernote("isEmpty")?(i.val(""),""!=i.summernote("code")&&i.summernote("code","")):i.val(t),n.validator.element(i)},onImageUpload:function(t){var i=$(this),e=new FormData;e.append("file",t[0]),$.ajax({data:e,type:"POST",url:"SetHtmlImage",cache:!1,contentType:!1,processData:!1,success:function(t){var e=document.createElement("img");e.src=t,i.summernote("insertNode",e)}})}}})})},setEdits:function(t,e,i){t=t.find(_ihtml.Filter+e);0<t.length&&t.summernote(i?"enable":"disable")}}),_ilink={get:function(t,e){return this.getO(_obj.get(t,e))},getO:function(t){return t.text()},set:function(t,e,i){this.setO(_obj.get(t,i),e)},setO:function(t,e){t.text(e)}},_input={get:function(t,e){return _input.getO(_obj.get(t,e),e)},getO:function(t,e,i){switch(i=i||_input.getType(t)){case InputTypeEstr.Text:return _itext.getO(t);case InputTypeEstr.Textarea:return _itextarea.getO(t);case InputTypeEstr.Check:return _icheck.getO(t);case InputTypeEstr.Radio:return _iradio.getO(t,e);case InputTypeEstr.Select:return _iselect.getO(t);case InputTypeEstr.Date:return _idate.getO(t);case InputTypeEstr.DateTime:return _idt.getO(t);case InputTypeEstr.File:return _ifile.getO(t);case InputTypeEstr.Html:return _ihtml.getO(t);case InputTypeEstr.ReadOnly:return _iread.getO(t);case InputTypeEstr.Link:return _ilink.getO(t);default:return t.val()}},set:function(t,e,i){_input.setO(_obj.get(t,i),e,i)},setO:function(t,e,i,n){if(null!=t&&_var.isPureData(e))switch(n=n||_input.getType(t)){case InputTypeEstr.Text:_itext.setO(t,e);break;case InputTypeEstr.Check:_icheck.setO(t,e);break;case InputTypeEstr.Radio:_iradio.setO(t,e=e||"0",i);break;case InputTypeEstr.Select:_iselect.setO(t,e);break;case InputTypeEstr.Date:return _idate.setO(t,e);case InputTypeEstr.DateTime:return _idt.setO(t,e);case InputTypeEstr.File:_ifile.setO(t,e);break;case InputTypeEstr.Textarea:_itextarea.setO(t,e);break;case InputTypeEstr.Html:_ihtml.setO(t,e);break;case InputTypeEstr.Read:var o=t.data("format");_str.notEmpty(o)&&_str.notEmpty(_BR[o])&&(e=_date.dtsToFormat(e,_BR[o])),_iread.setO(t,e);break;case InputTypeEstr.Link:return _ilink.setO(t,e);default:t.val(e)}},getType:function(t){return t.data("type")},getObj:function(t,e,i){return(i=i||_input.getType(_obj.get(t,e)))===InputTypeEstr.Radio?_iradio.getObj(t,e):_obj.get(t,e)},getFid:function(t){return t.data("fid")},fidFilter:function(t){return _str.isEmpty(t)?"[data-fid]":`[data-fid='${t}']`}},_iradio=$.extend({},_ibase,{get:function(t,e){return _iradio._getByName(t,e)},getO:function(t,e){return _iradio._getByName(_obj.getName(t),e)},getObj:function(t,e){return _obj.getF("[name="+t+"]:checked",e)},_getByName:function(t,e){return _iradio.getObj(t,e).data("value")},set:function(t,e,i){_iradio._setByName(t,e,i)},setO:function(t,e,i){_iradio._setByName(_obj.getName(t),e,i)},_setByName:function(t,e,i){t=_obj.getF("[name="+t+"][data-value="+e+"]",i);null!=t&&t.prop("checked",!0)},setEdit:function(t,e,i){_iradio.setEditOs(_obj.get(t,i))},setEditOs:function(t,e){t.attr("disabled",!e)},render:function(t,e,i,n,o,s,r){return s=s||"",r=r||"",""==(e=e||"")&&(e="&nbsp;"),r+=" data-id='"+t+"' name='"+t+"' value='"+(n=_str.isEmpty(n=n||"")?1:n)+"'",i&&(r+=" checked"),void 0===o||o||(r+=" disabled"),_str.format("<label class='xi-check {0}'>   <input type='radio'{1}>{2}   <span class='xi-rspan'></span></label>",s,r,e)}}),_iread={get:function(t,e){return _iread.getO(_obj.get(t,e))},getF:function(t,e){return _iread.getO(_obj.getF(t,e))},getO:function(t){return t.text()},set:function(t,e,i){_iread.setO(_obj.get(t,i),e)},setF:function(t,e,i){_iread.setO(_obj.getF(t,i),e)},setO:function(t,e){t.text(e)}},_iselect=$.extend({},_ibase,{getO:function(t){return 0===t.length?"":t.find("option:selected").val()},setO:function(t,e){filter='option[value="'+e+'"]';e=t.find(filter);return 0<e.length?(e.prop("selected",!0),e):(t.find("option:selected").prop("selected",!1),null)},setEditO:function(t,e){t.prop("disabled",!e)},getIndex:function(t,e){return _iselect.getIndexO(_obj.get(t,e))},getIndexO:function(t){return t.prop("selectedIndex")},getCount:function(t,e){return _iselect.getCountO(_obj.get(t,e))},getCountO:function(t){return t.find("option").length},setIndex:function(t,e,i){_iselect.setIndexO(_obj.get(t,i),e)},setIndexO:function(t,e){t.find("option").eq(e).prop("selected",!0)},getText:function(t,e){t=_obj.get(t,e);return _iselect.getTextO(t)},getTextO:function(t){return t.find("option:selected").text()},getData:function(t,e,i){return _obj.get(t,i).find("option:selected").data(e)},getDataO:function(t,e){return t.find("option:selected").data(e)},setItems:function(t,e,i){t=_obj.get(t,i);_iselect.setItemsO(t,e)},setItemsF:function(t,e,i){t=_obj.getF(t,i);_iselect.setItemsO(t,e)},setItemsO:function(t,e){if(t.find("option").remove(),null!==e)for(var i=0;i<e.length;i++)t.append($("<option></option>").attr("value",e[i].Id).text(e[i].Str))},getExts:function(t,e){var i=[];return _obj.get(t,e).find("option").each(function(t){var e=$(this);i[t]={Id:e.val(),Str:e.text(),Ext:e.data("ext")}}),i},setExts:function(t,e,i){var t="#"+t,n=i?i.find(t):$(t);if(n.find("option").remove(),null!=e)for(var o=0;o<e.length;o++)n.append(_str.format("<option data-ext='{0}' value='{1}'>{2}</option>",e[o].Ext,e[o].Id,e[o].Str))},valuesToJson:function(t,e,i){for(var n=0;n<e.length;n++)t[e[n]]=_iselect.get(e[n],i);return t},filterByExt:function(t,e,i,n,o,s){void 0===o&&(o=!1);for(var r=_obj.get(t,n),a=(r.empty(),""!=s&&r.append(_str.format('<option value="">{0}</option>',s)),i.length),d=0;d<a;d++){var l=i[d];(!0===o&&""==l.Ext||l.Ext==e)&&r.append(_str.format('<option value="{0}">{1}</option>',l.Id,l.Str))}0<a&&_iselect.setIndexO(r,0)},changeParent:function(t,e,i,n,o){var s=o?_me.divEdit:_me.divRead,o=_iselect.get(t,s);_ajax.getJsonA(n,{parentId:o},t=>{_iselect.setItems(e,t,s),_str.notEmpty(i)&&_iselect.set(e,i,s)})}}),_itext=$.extend({},_ibase,{mask:function(t){_obj.getF("[data-mask!='']",t).each(function(){var t=$(this);t.mask(t.data("mask"))})}}),_itextarea=$.extend({},_ibase,{}),_json={toChartRows:function(t,e){for(var i=[],n=0;n<e.length;n++){var o=e[n];i.push({Id:o,Num:t[o]})}return i},copy:function(t,e){var i,e=e||{};for(i in t)e[i]=t[i];return e},keyValuesToJson:function(t,e,i){if(null===t||0===t.length)return null;e=e||"Key",i=i||"Value";for(var n={},o=0;o<t.length;o++){var s=t[o];n["f"+s[e]]=s[i]}return n},toStr:function(t){return _json.isEmpty(t)?"":JSON.stringify(t)},isEmpty:function(t){return null==t||$.isEmptyObject(t)},notEmpty:function(t){return!_json.isEmpty(t)},isKeyValue:function(t){return"[object Object]"===Object.prototype.toString.call(t)},urlToJson:function(t){var t=(t=-1<t.indexOf("?")?t.split("?")[1]:t).split("&"),e={};return t.forEach(function(t){""!==(t=t.split("="))[0]&&(e[t[0]]=decodeURIComponent(t[1]||""))}),e},strToArray:function(t){return JSON.parse(t)},findIndex:function(t,e,i){if(null!=t)for(var n=0;n<t.length;n++)if(t[n][e]==i)return n;return-1},filterRows:function(t,e,i){return null==t||0==t.length?null:t.filter(function(t){return t[e]===i})},appendRows:function(t,e){if(null!=t&&0!=t.length)for(var i=e.length,n=0;n<t.length;n++)e[i+n]=t[n]},removeNull:function(s,r){r=r||0,$.each(s,function(t,e){if(null===e)delete s[t];else if(_json.isKeyValue(e))_json.removeNull(e,r+1);else if(Array.isArray(e)){var i=e.length;if(0==i)delete s[t];else{if(_json.isKeyValue(e[0])){$.each(e,function(t,e){_json.removeNull(e,r+1),_json.isEmpty(e)});for(n=!0,o=i-1;0<=o;o--)_json.isEmpty(e[o])?n?delete e[o]:e[o]=null:n=!1}else for(var n=!0,o=0;o<i;o++)if(_str.notEmpty(e[o])){n=!1;break}n&&delete s[t]}}}),_json.isEmpty(s)&&(s=null)}},_jwt={jsonAddJwtHeader:function(t){_fun.jwtToken&&(t.headers=_jwt.getJwtAuth())},getJwtAuth:function(){return{Authorization:_jwt.getJwtBearer()}},getJwtBearer:function(){return"Bearer "+_fun.jwtToken}},_leftmenu={init:function(){_leftmenu.menu=$(".x-leftmenu"),$(".x-toggle").on("click",function(t){t.preventDefault();var t=$(this),t=(t.next().collapse("toggle"),t.find(".x-arrow")),e="x-open";t.hasClass(e)?t.removeClass(e):t.addClass(e)})},onToggleMenu:function(){_leftmenu.menu.toggleClass("x-close")},getMenuPath:function(t){var e=t.text().trim();let i=[];return t.parents("li").each(function(){var t=$(this).children(".x-toggle");t.length&&i.unshift(t.text().trim())}),i.concat(e).join(" > ")}},_locale={},_log={_start:0,_now:0,info:function(t){console.log(t)},error:function(t){alert(t)},logTimeInit:function(t){_start=new Date,_now=_start,t&&console.log(t)},logTime:function(t){var e=new Date,t=t+":"+(e-_now)+"/"+(e-_start);console.log(t),_now=new Date}},_modal={show:function(t){$("#"+t).modal("show")},hide:function(t){$("#"+t).modal("hide")},showO:function(t){t.modal("show")},hideO:function(t){t.modal("hide")},showF:function(t){$(t).modal("show")},hideF:function(t){$(t).modal("hide")}},_nav={moveLeft:function(t){t.insertBefore(t.prev())},moveRight:function(t){t.insertAfter(t.next())}},_num={isBigZero:function(t,e){return!isNaN(t)&&!(!(e||"0"!==t&&0!==t)||parseInt(t)<0)},isNum:function(t){return!isNaN(t)},toBool:function(t){return 1===t},rowToBool:function(t,e){for(var i=0;i<e.length;i++){var n=e[i];t[n]=_num.toBool(t[n])}return t},addComma:function(t){x=(t+="").split("."),x1=x[0],x2=1<x.length?"."+x[1]:"";for(var e=/(\d+)(\d{3})/;e.test(x1);)x1=x1.replace(e,"$1,$2");return x1+x2}},_obj={get:function(t,e){return _obj.getF(_input.fidFilter(t),e)},getF:function(t,e){e=e.find(t);return 0==e.length?null:e},getN:function(t,e){return _obj.getF("[name="+t+"]",e)},getV:function(t,e){return _obj.getF("[value="+t+"]",e)},getById:function(t,e){return _obj.getF("#"+t,e)},getId:function(t){return 0<t.length?t.attr("id"):""},getName:function(t){return 0<t.length?t.attr("name"):""},isShow:function(t){return t.is(":visible")},isEmpty:function(t){return null==t||0==t.length},notEmpty:function(t){return!_obj.isEmpty(t)},hasAttr:function(t){return t.attr(attr)},show:function(t){t.removeClass("d-none")},hide:function(t){t.addClass("d-none")},showByStatus:function(t,e){_var.toBool(e)?_obj.show(t):_obj.hide(t)},getData:function(t,e){return t.data(e)},setData:function(t,e,i){t.attr("data-"+e,i)},tagName:function(t){return t[0].tagName.toLowerCase()},renameCss:function(t,e,i){t.removeClass(e).addClass(i)}},_pjax={init:function(t){var e=$(document);e.pjax("[data-pjax]",t,{type:"POST"}),e.on("click",".x-leftmenu [data-pjax]",function(){var t=_leftmenu.getMenuPath($(this));_prog.storeProgPath(t)}),e.on("pjax:success",function(t,e,i,n,o){var e=_str.toJson(e);null!=e&&(e=_ajax.resultToErrMsg(e))&&$(o.container).html(e)}),e.on("pjax:error",function(t,e,i,n,o){return o.success(e.responseText,i,e),!1})}},_prog={me:null,oriPath:"",init:function(){var t;_prog.me=$(".x-prog-path"),""==_prog.me.text()&&(_str.isEmpty(_fun.data.progPath)&&(t=window.location.pathname,t=$(`.x-leftmenu [href="${t}"]`),t=_leftmenu.getMenuPath(t),_prog.storeProgPath(t)),_prog.oriPath=_fun.data.progPath,_prog.me.text(_prog.oriPath))},storeProgPath:function(t){_fun.data.progPath=t},resetPath:function(){_prog.me.text(_prog.oriPath)},setPath:function(t,e){t=t==FunEstr.Create?_BR.Create:t==FunEstr.View?_BR.View:t!=FunEstr.Update?"??":_str.isEmpty(e)?_BR.Update:e;_prog.setFunName(t)},setFunName:function(t){_prog.me.text(_prog.oriPath+"-"+t)}},_qrcode={set:function(t,e,i,n){return _qrcode.setO(_obj.getById(t,e),i,n)},setO:function(t,e,i){return i=i||128,new QRCode(t[0],{text:e,width:i,height:i,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}},_str={colSep:"@@",isEmpty:function(t){return null==t||""===t},notEmpty:function(t){return!_str.isEmpty(t)},emptyToStr:function(t,e){return _str.isEmpty(t)?e:t},format:function(){for(var t=arguments[0],e=0;e<arguments.length-1;e++)var i=new RegExp("\\{"+e+"\\}","gm"),t=t.replace(i,arguments[e+1]);return t},getMid:function(t,e,i){var n;return _str.isEmpty(t)?"":(n=t.indexOf(e))<0?t:(i=t.indexOf(i,n+1))<0?t.substring(n+e.length):t.substring(n+e.length,i)},getTail:function(t,e){e=t.lastIndexOf(e);return 0<e?t.substring(e+1):t},toBool:function(t){return _var.toBool(t)},colsToStr:function(){for(var t=arguments[0],e=1;e<arguments.length;e++)t+=_str.colSep+arguments[e];return t},trim:function(t){return t.trim()},toJson:function(t){try{return JSON.parse(t)}catch(t){return null}},replaceAll:function(t,e,i){e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e=new RegExp(e,"g");return t.replace(e,i)}},_switch={getText:function(t,e,i,n,o,s,r){s=s?' id="'+s+'"':"";n&&(s+=" checked");return _str.format('<label class="switch{5}" style="width:{2}px;"><input{3} class="switch-input{4}" type="checkbox" /><span class="switch-label" data-on="{0}" data-off="{1}"></span><span class="switch-handle"></span></label>',t,e,i,s,r=r?" "+r:"",o?" x-inline":"")}},_tab={moveLeft:function(t){t.insertBefore(t.prev())},moveRight:function(t){t.insertAfter(t.next())}},_table={rowMoveUp:function(){var t=_fun.getMe(!0).closest("tr");t.insertBefore(t.prev())},rowMoveDown:function(){var t=_fun.getMe(!0).closest("tr");t.insertAfter(t.next())},getRowCount:function(t,e){return t.find(_input.fidFilter(e)).length}},_temp={},_time={sleepA:async function(e){return new Promise(t=>setTimeout(t,e))}},_tool={init:function(){_tool.xgMsg=$("#xgMsg"),_tool.xgAns=$("#xgAns"),_tool.xgAlert=$(".x-alert"),_tool.xgArea=$(".x-area"),_tool.xgImage=$(".x-image"),_tool.xgWork=$(".x-work")},msg:function(t,e){var i=_tool.xgMsg;i.find(".xd-msg").html(t),_modal.showO(i),_tool._fnOnMsgClose=e},ans:function(t,e,i){var n=_tool.xgAns;n.find(".xd-msg").html(t),_modal.showO(n),_tool._fnOnAnsYes=e,_tool._fnOnAnsNo=void 0===i?null:i},alert:function(t,e){var i=_tool.xgAlert;i.find(".xd-msg").text(t),i.fadeIn(500,function(){_obj.show(i),setTimeout(function(){_tool.onAlertClose()},5e3)})},showWait:function(){_obj.show($(".x-wait"))},hideWait:function(){_obj.hide($(".x-wait"))},showArea:function(t,e,i,n){var o=_tool.xgArea,t=(o.find(".modal-title").text(t),o.find("textarea"));t.val(e),_itextarea.setEditO(t,i),_btn.setEditO(o.find(".xd-yes"),i),i&&(_tool._fnOnAreaYes=n),_modal.showO(o)},onAreaYes:function(){var t=_tool.xgArea;_tool._fnOnAreaYes&&(_modal.hideO(t),t=t.find("textarea").val(),_tool._fnOnAreaYes(t))},showImage:function(t,e){var i=_tool.xgImage;i.find("img").attr("src",e),i.find("label").text(t),_modal.showO(i)},onAlertClose:function(){var t=_tool.xgAlert;t.fadeOut(500,function(){_obj.hide(t)})},onAnsYes:function(){_tool._fnOnAnsYes&&(_modal.hideO(_tool.xgAns),_tool._fnOnAnsYes())},onAnsNo:function(){_tool._fnOnAnsNo&&_tool._fnOnAnsNo(),_modal.hideO(_tool.xgAns)},onMsgClose:function(){_tool._fnOnMsgClose&&_tool._fnOnMsgClose(),_modal.hideO(_tool.xgMsg)}},_valid={init:function(t){return t.removeData("validator"),t.validate({ignore:":hidden:not(.xd-valid), .note-editable.panel-body",errorElement:"span",errorPlacement:function(t,e){return t.insertAfter(_valid._getBox($(e))),!1},highlight:function(t,e,i){t=$(t),_valid._getBox(t).removeClass(i).addClass(e),i=_valid._getError(t);return null!=i&&_obj.show(i),!1},unhighlight:function(t,e,i){t=$(t),_valid._getBox(t).removeClass(e).addClass(i),e=_valid._getError(t);return null!=e&&_obj.hide(e),!1}})},showError:function(t,e,i,n){(_str.isEmpty(i)?_me.eform0:$("#"+i)).validator.showErrors({[t]:e})},_getBox:function(t){return t.closest(".xi-box")},_getError:function(t){t=_valid._getBox(t).next();return 1==t.length&&t.hasClass("error")&&t.is("span")?t:null}},_var={emptyToValue:function(t,e){return _str.isEmpty(t)?e:t},isEmpty:function(t){return null==t},notEmpty:function(t){return!_var.isEmpty(t)},isPureData:function(t){return"object"!=typeof t&&!Array.isArray(t)},toBool:function(t){return"1"==t||1==t||"True"==t}},_openUser={init:function(t,e){var i="#_"+(e=e||"ou"),n=$(i),o={boxId:e,filter:i,fn:t,isRows:1==_iText.get("_IsRows",n)},e={filter:!0,columns:[{data:"_Fun"},{data:"Account"},{data:"Name"}],columnDefs:[_me.crudR.dtProp,{targets:[0],render:function(t,e,i,n){i=_str.colsToStr(i.Id,i.Name,i.Account);return o.isRows?_me.crudR.dtCheck0(i):_me.crudR.dtRadio1(i)}}]};return o.dt=_datatable.init(o.filter+" #_Table","../OpenUser/GetPage",e),o},show:function(t){_iCheck.setF(t.filter+" #_Table",!1),_modal.showF(t.filter)},onClickFind:function(t){var e=$(t.filter);_datatable.find(t.dt,null,_iText.get("Name",e))},onClickOk:function(t){var e,i=$(t.filter);t.isRows?0==(e=_iCheck.getCheckeds(i,_icheck.Check0Id)).length?_tool.msg("請先選取資料。"):(t.fn(e),_modal.hideO(i)):""==(e=_iRadio.get(_iCheck.Check1Id,i))?_tool.msg("請先選取資料。"):(t.fn(e),_modal.hideO(i))}},_xp={};