function CrudE(edits){this._init=function(){var hasEdit,Childs,edit0,i;if(this.divEdit=$("#divEdit"),hasEdit=this.divEdit.length>0,hasEdit){if(Childs=_edit.Childs,edit0=null,edits==null)edit0=new EditOne;else if(edit0=edits[0]===null?new EditOne:edits[0],edits.length>1)for(edit0[Childs]=[],i=1;i<edits.length;i++)edit0[Childs][i-1]=edits[i];this.edit0=edit0;edit0.eform!=null&&(this.eform0=edit0.eform);this.hasChild=_fun.hasValue(this.edit0[Childs])&&this.edit0[Childs].length>0;this._initForm(this.edit0)}this._nowFun="";this.modal=null;_me.crudE=this;_me.edit0=this.edit0;_me.eform0=this.eform0;_me.hasEdit=hasEdit};this._initForm=function(edit){var childLen,i;if(edit.eform!=null)for(_idate.init(edit.eform),edit.validator=_valid.init(edit.eform),childLen=this._getEditChildLen(edit),i=0;i<childLen;i++)this._initForm(this._getEditChild(edit,i))};this.getEform0=function(){return this.edit0.eform};this._loadJson=function(json){var edit=this.edit0,childLen,i,edit2;for(edit.loadRow(json),edit.dataJson=json,childLen=this._getEditChildLen(edit),i=0;i<childLen;i++)edit2=this._getEditChild(edit,i),edit2.dataJson=this._getChildJson(json,i),edit2.loadRows(this.jsonGetRows(edit2.dataJson))};this._afterOpenEdit=function(fun,json){_me.fnAfterOpenEdit&&_me.fnAfterOpenEdit(fun,json)};this._setEditStatus=function(fun){var dataEdit;this._nowFun=fun;var box=this.divEdit,eform=this.edit0.eform,items=box.find("input, textarea, select, button");fun==_fun.FunV?(_edit.removeIsNew(eform),items.prop("disabled",!0),box.find("#btnToRead").prop("disabled",!1),_ihtml.setEdits(box,"",!1)):fun==_fun.FunC?(_edit.addIsNew(eform),dataEdit="[data-edit=U]",items.prop("disabled",!1),items.filter(dataEdit).prop("disabled",!0),_ihtml.setEdits(box,"",!0),_ihtml.setEdits(box,dataEdit,!1)):fun==_fun.FunU&&(_edit.removeIsNew(eform),dataEdit="[data-edit=C]",items.prop("disabled",!1),items.filter(dataEdit).prop("disabled",!0),_ihtml.setEdits(box,"",!0),_ihtml.setEdits(box,dataEdit,!1));this.divEdit.find("span.error").remove()};this._hasFile=function(){var edit=this.edit0,childLen,i,edit2;if(edit.hasFile)return!0;for(childLen=this._getEditChildLen(edit),i=0;i<childLen;i++)if(edit2=this._getEditChild(edit,i),edit2.hasFile)return!0;return!1};this._getUpdJson=function(formData){var edit0=this.edit0,row=edit0.getUpdRow(),key=edit0.getKey(),fileJson={},levelStr="0",i,edit2,fileJson2,childJson,data,hasData;edit0.hasFile&&(fileJson=edit0.dataAddFiles(levelStr,formData));var hasChild=!1,childs=[],childLen=this._getEditChildLen(edit0);for(i=0;i<childLen;i++)(edit2=this._getEditChild(edit0,i),edit2.hasFile&&(fileJson2=edit2.dataAddFiles(levelStr+i,formData,edit2.rowsBox),_json.copy(fileJson2,fileJson)),childJson=edit2.getUpdJson(key),childJson!=null)&&(hasChild=!0,childs[i]=childJson);return(data={},hasData=!1,row!=null&&(hasData=!0,data[_edit.Rows]=[row]),hasChild&&(hasData=!0,data[_edit.Childs]=childs),_json.isEmpty(fileJson)||(hasData=!0,data[_edit.FileJson]=fileJson),!hasData)?null:(_json.removeNull(data),data)};this.validAll=function(){var edit=this.edit0,childLen,i,edit2;if(_str.notEmpty(edit.systemError))return _tool.msg(edit.systemError),!1;if(!edit.eform.valid())return!1;for(childLen=this._getEditChildLen(edit),i=0;i<childLen;i++){if(edit2=this._getEditChild(edit,i),_str.notEmpty(edit2.systemError))return _tool.msg(edit2.systemError),!1;if(!edit2.valid())return!1}return!0};this.afterSave=function(data){if(_fun.hasValue(this.edit0.fnAfterSave)&&this.edit0.fnAfterSave(),data.Value==="0"){_tool.msg(_BR.SaveNone);return}_tool.alert(_BR.SaveOk+"("+data.Value+")");_me.crudR&&(_me.crudR.dt.reload(),_me.crudR.toReadMode())};this._resetForm=function(edit){var childLen,i,edit2;for(edit.reset(),childLen=this._getEditChildLen(edit),i=0;i<childLen;i++)edit2=this._getEditChild(edit,i),edit2.reset()};this.isEditMode=function(){return this._nowFun!==_fun.FunV};this._updateOrViewA=async function(fun,key){if(_me.fnUpdateOrViewA)return await _me.fnUpdateOrViewA(fun,key);var me=this,act=fun==_fun.FunU?"GetUpdJson":"GetViewJson";return await _ajax.getJsonA(act,{key:key},function(json){me._loadJson(json);me._setEditStatus(fun);me._afterOpenEdit(fun,json);_me.crudR.toEditMode(fun)})};this._getEditChild=function(edit,childIdx){return edit[_edit.Childs][childIdx]};this._getEditChildLen=function(edit){var fid=_edit.Childs;return edit[fid]==null?0:edit[fid].length};this.jsonGetRows=function(json){return json==null||json[_edit.Rows]==null?null:json[_edit.Rows]};this._getChildJson=function(upJson,childIdx){var childs=_edit.Childs;return upJson[childs]==null||upJson[childs].length<=childIdx?null:upJson[childs][childIdx]};this.getChildRows=function(upJson,childIdx){var child=this._getChildJson(upJson,childIdx);return this.jsonGetRows(child)};this.setChildRows=function(upJson,childIdx,rows){var fid=_edit.Childs,child;return upJson==null&&(upJson={}),upJson[fid]==null&&(upJson[fid]=[]),upJson[fid].length<=childIdx&&(upJson[fid][childIdx]={}),child=upJson[fid][childIdx],child[_edit.Rows]=rows,child};this.editToNew=function(){var fun=_fun.FunC;this._setEditStatus(fun);this.edit0.resetKey();_prog.setPath(fun)};this.getUpdRow=function(kid,fidTypes,box){var row=_form.toRow(box),key=_input.get(kid,box),diff,result,fid,ftype,value,obj,old,j;if(_str.isEmpty(key))return row;for(diff=!1,result={},j=0;j<fidTypes.length;j=j+2)if(ftype=fidTypes[j+1],fid=fidTypes[j],obj=_input.getObj(fid,box,ftype),value=row[fid],old=obj.data(_edit.DataOld),value!=old){if((ftype==="date"||ftype==="dt")&&_date.dtsToValue(value)===_date.dtsToValue(old))continue;result[fid]=value;diff=!0}return diff?(result[kid]=key,result):null};this.getFileSid=function(levelStr,fid){return"t"+levelStr+"_"+fid};this.dataSetFileJson=function(data,fileJson){var fid,json;_json.isEmpty(fileJson)||(fid=_edit.FileJson,data.has(fid)&&(json=data.get(fid),fileJson=_json.copy(fileJson,json)),data.set(fid,fileJson))};this.viewFile=function(table,fid,elm,key){var ext=_file.getFileExt(elm.innerText);_file.isImageExt(ext)&&_tool.showImage(elm.innerHTML,_str.format("ViewFile?table={0}&fid={1}&key={2}&ext={3}",table,fid,key,ext))};this.onCreate=function(){var fun=_fun.FunC;this._resetForm(this.edit0);this._setEditStatus(fun);this._afterOpenEdit(fun,null)};this.onUpdateA=async function(key){return _edit.removeIsNew(this.edit0.eform),await this._updateOrViewA(_fun.FunU,key)};this.onViewA=async function(key){return await this._updateOrViewA(_fun.FunV,key)};this.onOpenModal=function(btn,title,fid){var tr=$(btn).closest("tr");_tool.showArea(title,_itext.get(fid,tr),this.isEditMode(),function(result){_itext.set(fid,result,tr)})};this.onSaveA=async function(){var edit0,error,formData,row;if(!this.validAll()){_tool.alert(_BR.InputWrong);return}if(edit0=this.edit0,_fun.hasValue(edit0.fnWhenSave)&&(error=edit0.fnWhenSave(),_str.notEmpty(error))){_tool.msg(error);return}if(formData=new FormData,row=this._getUpdJson(formData),_json.isEmpty(row)){_tool.msg(_BR.SaveNone);return}var isNew=edit0.isNewRow(),action=isNew?"Create":"Update",data=null,me=this;this._hasFile()?(data=formData,data.append("json",_json.toStr(row)),isNew||data.append("key",edit0.getKey()),await _ajax.getJsonByFdA(action,data,function(result){me.afterSave(result)})):(data={json:_json.toStr(row)},isNew||(data.key=edit0.getKey()),await _ajax.getJsonA(action,data,function(result){me.afterSave(result)}))};this._init()}function CrudR(dtConfig,edits,updName){this.temp={};this._init=function(){this.divRead=$("#divRead");var hasRead=this.divRead.length>0;hasRead&&(this.rform=$("#formRead"),this.rform.length===0&&(this.rform=null),this.rform2=$("#formRead2"),this.rform2.length===0&&(this.rform2=null),this.rform!=null&&_idate.init(this.rform),this.rform2!=null&&_idate.init(this.rform2),_var.notEmpty(dtConfig)&&(this.dt=new Datatable("#tableRead","GetPage",dtConfig,this._getFindCond())));this._updName=updName;new CrudE(edits);_prog.init();_me.crudR=this;_me.hasRead=hasRead};this.dtCheck0=function(value,editable){_str.isEmpty(value)&&(value=1);var attr="data-fid='"+_icheck.Check0Id+"' data-value='"+value+"'";return editable===!1&&(attr+=" readonly"),"<label class='xi-check xg-no-label'>   <input "+attr+" type='checkbox'>   <span class='xi-cspan'><\/span><\/label>"};this.dtRadio1=function(value,editable){return editable===undefined&&(editable=!0),_iradio.render(_icheck.Check0Id,"",!1,value,editable)};this.dtSetStatus=function(){return""};this.dtStatusName=function(value){return value=="1"?"<span>"+_BR.StatusYes+"<\/span>":'<span class="text-danger">'+_BR.StatusNo+"<\/span>"};this.dtYesEmpty=function(value){return value=="1"?_BR.Yes:""};this.dtRed=function(text,status){return status?'<span class="text-danger">'+text+"<\/span>":"<span>"+text+"<\/span>"};this.dtCrudFun=function(key,rowName,hasUpdate,hasDelete,hasView,fnOnUpdate,fnOnDelete,fnOnView){var funs="";return hasUpdate&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="{0}(\'{1}\')"><i class="ico-pen" title="{2}"><\/i><\/button>',fnOnUpdate==null?"_me.crudR.onUpdateA":fnOnUpdate,key,_BR.TipUpdate)),hasDelete&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="{0}(\'{1}\',\'{2}\')"><i class="ico-delete" title="{3}"><\/i><\/button>',fnOnDelete==null?"_me.crudR.onDeleteA":fnOnDelete,key,rowName,_BR.TipDelete)),hasView&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="{0}(\'{1}\')"><i class="ico-eye" title="{2}"><\/i><\/button>',fnOnView==null?"_me.crudR.onViewA":fnOnView,key,_BR.TipView)),funs};this._getFindCond=function(){if(this.rform==null)return null;var row=_form.toRow(this.rform),find2=this.rform2;return find2!==null&&_obj.isShow(find2)&&_json.copy(_form.toRow(find2),row),row};this.swap=function(toRead,nowDiv,fnCallback){var isDefault,oldDiv,newDiv;if(!_me.hasRead||!_me.hasEdit){fnCallback&&fnCallback();return}isDefault=_var.isEmpty(nowDiv);isDefault&&(nowDiv=_me.crudE.divEdit);toRead?(oldDiv=nowDiv,newDiv=this.divRead):(oldDiv=this.divRead,newDiv=nowDiv);oldDiv.fadeOut(200,function(){newDiv.fadeIn(500);fnCallback&&fnCallback()});isDefault&&this._afterSwap(toRead)};this.toEditMode=function(fun,fnCallback){this.swap(!1,null,fnCallback);_prog.setPath(fun,this._updName)};this.toReadMode=function(){_prog.resetPath();this.swap(!0)};this._afterSwap=function(toRead){_me.fnAfterSwap&&_me.fnAfterSwap(toRead)};this.onFind=function(){var cond=this._getFindCond();this.dt.find(cond)};this.onFind2=function(){var find2=this.rform2;find2!=null&&(_obj.isShow(find2)?_form.hideShow([find2]):_form.hideShow(null,[find2]))};this.onResetFind=function(){_form.reset(this.rform);this.rform2!=null&&_form.reset(this.rform2)};this.onExport=function(){var find=this._getFindCond();window.location="Export?find="+_json.toStr(find)};this.onToRead=function(){this.toReadMode()};this.onCreate=function(){_me.crudE.onCreate();this.toEditMode(_fun.FunC)};this.onUpdateA=async function(key){await _me.crudE.onUpdateA(key)};this.onViewA=async function(key){await _me.crudE.onViewA(key)};this.onSetStatusA=async function(me,key){var status=_icheck.checkedO($(me));await _ajax.getStrA("SetStatus",{key:key,status:status},function(){_tool.alert(_BR.UpdateOk)})};this.onCheckAll=function(me,box,fid){_icheck.setF(_input.fidFilter(fid)+":not(:disabled)",_icheck.checkedO($(me)),box)};this.onDeleteA=async function(key,rowName){var me=this;_tool.ans(_BR.SureDeleteRow+" ("+rowName+")",async function(){await _ajax.getJsonA("Delete",{key:key},function(){_tool.alert(_BR.DeleteOk);me.dt.reload()})})};this.onDeleteRowsA=async function(box,fid){var keys=_icheck.getCheckeds(box,fid),me;if(keys.length===0){_tool.msg(_BR.PlsSelectDeleted);return}me=this;_tool.ans(_BR.SureDeleteSelected,async function(){await _ajax.getStrA("DeleteByKeys",{keys:keys},function(){_tool.alert(_BR.DeleteOk);me.dt.reload()})})};this._init()}function Datatable(selector,url,dtConfig,findJson,fnOk,tbarHtml){this.dt=null;this.findJson=findJson;this.recordsFiltered=-1;this.defaultShowOk=!0;this._keepStart=!1;this._start=0;this._nowShowOk=this.defaultShowOk;this.resetCount=function(){this.recordsFiltered=-1};this.find=function(findJson){this.findJson=findJson;this.resetCount();this.dt.search("").draw(!this._keepStart)};this.reload=function(){this._keepStart=!0;this._nowShowOk=!1;this.find(this.findJson)};this.init=function(selector,url,dtConfig,fnOk,tbarHtml){var config={pageLength:_fun.pageRows||10,lengthMenu:[10,20,50,100],processing:!1,serverSide:!0,jQueryUI:!1,filter:!1,paginate:!0,lengthChange:!0,info:!0,sorting:[],pagingType:"full_numbers",language:{url:"/locale/"+_fun.locale+"/dataTables.txt"},dom:'<"toolbar">t<li>p',initComplete:function(){var filter,api;tbarHtml&&$(this).closest(".dataTables_wrapper").find("div.toolbar").html(tbarHtml);filter=$(selector+"_filter input");filter.length>0&&(filter.unbind(),api=this.api(),filter.bind("keyup",function(e){e.keyCode===13&&(this.resetCount(),api.search(this.value).draw())}))}.bind(this),ajax:{url:url,type:"POST",dataType:"json",data:function(arg){var orders=arg.order,order;orders.length>0&&(order=orders[0],order.fid=arg.columns[order.column].data);arg.findJson=_json.toStr(this.findJson);arg.recordsFiltered=this.recordsFiltered;this._keepStart&&(arg.start=this._start)}.bind(this),dataSrc:function(result){this._start=this.dt.page.info().start;this._keepStart=!1;var errMsg=_ajax.resultToErrMsg(result);return errMsg?(_tool.msg(errMsg),result.recordsFiltered=0,this.recordsFiltered=0,[]):(this.recordsFiltered=result.recordsFiltered,fnOk?fnOk(result):result.data===null||result.data.length===0?(_tool.alert(_BR.FindNone,"R"),[]):(this._nowShowOk&&_tool.alert(_BR.FindOk),this._nowShowOk=this.defaultShowOk,result.data))}.bind(this),error:function(xhr,ajaxOptions,thrownError){_tool.hideWait();_tool.msg("Datatable.js error.");xhr!=null&&(console.log("status"+xhr.status),console.log(thrownError))}}},colDefs,dt;dtConfig&&(_var.notEmpty(dtConfig.columnDefs)&&(colDefs=dtConfig.columnDefs,colDefs[colDefs.length]=_fun.dtColDef),config=_json.copy(dtConfig,config));dt=$(selector);dt.on("preXhr.dt",function(){_fun.block()});dt.on("xhr.dt",function(){_fun.unBlock()});this.dt=dt.DataTable(config)};this.init(selector,url,dtConfig,fnOk,tbarHtml)}function EditMany(kid,rowsBoxId,rowTplId,rowFilter,sortFid){this.init=function(){if(this.DataFkeyFid="_fkeyfid",this.mode=_edit.ModeBase,this.modeData="",this.isUrm=!1,this.kid=kid,this.rowFilter=rowFilter,this.sortFid=sortFid,this.systemError="",this.hasRowTpl=_str.notEmpty(rowTplId),this.hasRowFilter=_str.notEmpty(rowFilter),this.dataJson=null,this.hasRowTpl){this.rowTpl=$("#"+rowTplId).html();var rowObj=$(this.rowTpl);_obj.get(kid,rowObj)==null&&(this.systemError=`EditMany.js input kid is wrong (${kid})`,alert(this.systemError));_edit.initVars(this,rowObj)}this.hasEform=_str.notEmpty(rowsBoxId);this.hasEform&&(this.rowsBox=$("#"+rowsBoxId),this.eform=this.rowsBox.closest("form"),this.rowsBox.length==0&&(this.systemError=`EditMany.js rowsBoxId is wrong (${rowsBoxId})`,alert(this.systemError)));this.deletedRows=[];this.newIndex=0};this.initUrm=function(fids){this.mode=_edit.ModeUR;this.modeData=fids;this.isUrm=!0};this._isNewBox=function(box){return _itext.get(_edit.IsNew,box)=="1"};this.reset=function(){this.fnReset?this.fnReset():this.isUrm?this._urmReset():this.hasEform&&(this.rowsBox.empty(),this._resetVar())};this._resetVar=function(){this.newIndex=0;this._resetDeletes()};this._resetDeletes=function(){this.deletedRows=[]};this._urmLoadRows=function(rows){var fids,i,row,obj;if(this._urmReset(),rows!=null)for(fids=this.modeData,i=0;i<rows.length;i++)row=rows[i],obj=this.rowsBox.find(_input.fidFilter(row[fids[1]])),_icheck.setO(obj,1),obj.data("key",row[fids[0]])};this._urmGetUpdJson=function(upKey){var json={},rows=[],me=this,newIdx=0,fids=this.modeData;return this._resetDeletes(),this.rowsBox.find(":checkbox").each(function(){var obj=$(this),key=obj.data("key"),row;_str.isEmpty(key)?_icheck.checkedO(obj)&&(row={},row[_edit.IsNew]="1",row[fids[0]]=++newIdx,row[fids[1]]=_icheck.getO(obj),me.rowSetFkey(row,upKey),rows[rows.length]=row):_icheck.checkedO(obj)||me.deleteRow(key)}),rows.length>0&&(json[_edit.Rows]=rows),json[_edit.Deletes]=this.getDeletes(),json};this._urmReset=function(){this._resetVar();var objs=this.rowsBox.find(":checkbox");_icheck.setO(objs,0);objs.data("key","")};this.loadRows=function(rows){this.fnLoadRows?this.fnLoadRows(rows):this.isUrm?this._urmLoadRows(rows,_me.divRoles,_me.mUserRoleFids):this.loadRowsByRsb(rows,!0)};this.loadRowByBox=function(rowBox,row,index){var box,i;for(row.Index=index,box=$(Mustache.render(this.rowTpl,row)),i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],_edit.setOld(_obj.get(fid,box),row[fid]);_idate.init(box);_form.loadRow(box,row);box.appendTo(rowBox)};this.loadRowsByRsb=function(rows,reset,rowsBox){var rowLen,i;if(this._checkRowTpl()&&(rowsBox=this._getRowsBox(rowsBox),(_var.isEmpty(reset)||reset)&&this.reset(rowsBox),rowLen=rows==null?0:rows.length,rowLen!=0))for(i=0;i<rowLen;i++)this.loadRowByBox(rowsBox,rows[i],i)};this.valid=function(){return this.fnValid?this.fnValid():this.hasEform?this.eform.validTable(this.validator):!0};this.getKey=function(rowBox){return _input.get(this.kid,rowBox)};this._checkRowFilter=function(){return this.hasRowFilter?!0:(_log.error("EditMany.js this.rowFilter is empty."),!1)};this._checkRowTpl=function(){return this.hasRowTpl?!0:(_log.error("EditMany.js this.rowTpl is empty."),!1)};this._elmToRowBox=function(elm){return this._checkRowFilter()?$(elm).closest(this.rowFilter):null};this.idToRowBox=function(id){var filter=_input.fidFilter(this.kid)+`[value='${id}']`;return this.eform.find(filter).parent()};this.getUpdJson=function(upKey){return this.fnGetUpdJson?this.fnGetUpdJson(upKey):this.isUrm?this._urmGetUpdJson(upKey):this.getUpdJsonByRsb(upKey,this.rowsBox)};this.getUpdJsonByRsb=function(upKey,rowsBox){var json={};return json[_edit.Rows]=this.getUpdRows(upKey,this._getRowsBox(rowsBox)),json[_edit.Deletes]=this.getDeletes(),json};this.getUpdRows=function(upKey,rowsBox){if(this._checkRowFilter()){rowsBox=this._getRowsBox(rowsBox);this.setSort(rowsBox);var rows=[],me=this;return rowsBox.find(me.rowFilter).each(function(idx,item){var box=$(item),key=_input.get(me.kid,box),row2,diffRow,diff,fid,ftype,value,obj,j;if(me._isNewBox(box)){row2=_form.toRow(box);row2[me.DataFkeyFid]=upKey;rows.push(row2);return}for(diffRow={},diff=!1,j=0;j<me.fidTypes.length;j=j+2)(ftype=me.fidTypes[j+1],ftype!=="read")&&(fid=me.fidTypes[j],obj=_obj.get(fid,box),value=_input.getO(obj,box,ftype),value!=_edit.getOld(obj)&&(diffRow[fid]=value,diff=!0));diff&&(diffRow[kid]=key,rows.push(diffRow))}),rows.length===0?null:rows}};this.getDeletes=function(){return this.deletedRows.length===0?null:this.deletedRows.join()};this.onAddRow=function(){this.addRow()};this.addRow=function(row,rowsBox,newId){row=row||{};rowsBox=this._getRowsBox(rowsBox);var obj=this._renderRow(row,rowsBox);return newId=this.setNewIdByBox(obj,newId),row[this.kid]=newId,row};this.onDeleteRow=function(btn){var box=this._elmToRowBox(btn);this.deleteRow(_itext.get(this.kid,box),box)};this.deleteRow=function(key,rowBox){for(var deletes=this.deletedRows,found=!1,rowLen=deletes.length,i=0;i<rowLen;i++)if(deletes[i][this.kid]===key){found=!0;break}found||(deletes[rowLen]=key);_obj.isExist(rowBox)&&rowBox.remove()};this.onViewFile=function(table,fid,elm){var key=this.getKey(this._elmToRowBox(elm));_me.crudE.viewFile(table,fid,elm,key)};this._renderRow=function(row,rowsBox){if(!this._checkRowTpl())return null;rowsBox=this._getRowsBox(rowsBox);var obj=$(Mustache.render(this.rowTpl,row));return _form.loadRow(obj,row),obj.appendTo(rowsBox),obj};this.dataAddFiles=function(levelStr,data,rowsBox){if(!this.hasFile||!this._checkRowFilter())return null;rowsBox=this._getRowsBox(rowsBox);var me=this,fileJson={},fileIdx={};return rowsBox.find(me.rowFilter).each(function(index,item){for(var fid,serverFid,tr=$(item),i=0;i<me.fileLen;i++)fid=me.fileFids[i],serverFid=_me.crudE.getFileSid(levelStr,fid),_ifile.dataAddFile(data,fid,serverFid,tr)&&(fileIdx[fid]=fileIdx[fid]==null?0:fileIdx[fid]+1,fileJson[serverFid+fileIdx[fid]]=me.getKey(tr))}),fileJson};this.rowSetFkey=function(row,fkey){row!=null&&_edit.isNewRow(row)&&(row[this.DataFkeyFid]=fkey)};this.rowsSetFkey=function(rows,fkey){var i,row;if(rows!=null)for(i=0;i<rows.length;i++)row=rows[i],row!=null&&_edit.isNewRow(row)&&(row[this.DataFkeyFid]=fkey)};this.setNewIdByBox=function(box,newId){return newId==null&&(this.newIndex++,newId=this.newIndex),_itext.set(this.kid,newId,box),_edit.addIsNew(box),newId};this.setSort=function(rowsBox){var sortFid=this.sortFid,me;_str.isEmpty(sortFid)||(me=this,rowsBox=this._getRowsBox(rowsBox),rowsBox.find(_input.fidFilter(sortFid)).each(function(i,item){_itext.set(sortFid,i,$(item).closest(me.rowFilter))}))};this._getRowsBox=function(rowsBox){return rowsBox||this.rowsBox};this.init()}function EditOne(kid,eformId){this.init=function(){this.kid=kid||"Id";eformId=eformId||"eform";this.eform=$("#"+eformId);this.dataJson=null;this.systemError="";var error=this.eform.length!=1?"EditOne.js input eformId is wrong. ("+eformId+")":_obj.get(this.kid,this.eform)==null?"EditOne.js input kid is wrong. ("+this.kid+")":"";error!=""&&(this.systemError=error,alert(error));_edit.initVars(this,this.eform)};this.getKey=function(){return _input.get(this.kid,this.eform)};this.getValue=function(fid){return _input.get(fid,this.eform)};this.isNewRow=function(){return _itext.get(_edit.IsNew,this.eform)=="1"};this.loadRow=function(row){var i,obj;for(_form.loadRow(this.eform,row),i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],obj=_obj.get(fid,this.eform),obj.data(_edit.DataOld,row[fid])};this.getUpdRow=function(){return _me.crudE.getUpdRow(this.kid,this.fidTypes,this.eform)};this.reset=function(){_form.reset(this.eform)};this.resetKey=function(){_itext.set(this.kid,"",this.eform)};this.setEdit=function(status){_form.setEdit(this.eform,status)};this.dataAddFiles=function(levelStr,data){var fileJson,i,fid,serverFid;if(!this.hasFile)return null;for(fileJson={},i=0;i<this.fileLen;i++)fid=this.fileFids[i],serverFid=_me.crudE.getFileSid(levelStr,fid),_ifile.dataAddFile(data,fid,serverFid,this.eform)&&(fileJson[serverFid]=this.getKey());return fileJson};this.onViewFile=function(table,fid,elm){var key=this.getKey();_me.crudE.viewFile(table,fid,elm,key)};this.init()}function FlowBase(boxId){this.isEdit=!1;this.newLineId=0;this._init=function(boxId){let boxDom=document.getElementById(boxId);this.svg=SVG().addTo(boxDom).size("100%","100%");this.fnMoveNode=null;this.fnAfterAddLine=null;this.fnShowMenu=null};this.getNewLineId=function(){return this.newLineId++,this.newLineId};this.setEdit=function(status){this.isEdit=status};this._reset=function(){this.nodes=[];this.lines=[];this.fromNode=null;Array.from(this.svg.node.childNodes).forEach(node=>{node.remove()})};this.loadNodes=function(rows){this._reset();for(var i=0;i<rows.length;i++)this.addNode(rows[i])};this.loadLines=function(rows){if(rows!=null)for(var i=0;i<rows.length;i++)this.addLine(rows[i])};this.addNode=function(json){let node=new FlowNode(this,json);return this.nodes.push(node),node};this.addLine=function(json){return new FlowLine(this,json)};this.deleteNode=function(node){let id=node.getId();this.svg.findOne(`g[data-id="${id}"]`)};this.deleteLine=function(line){let id=line.getId();this.svg.find(`path[data-id="${id}"]`)};this.drawLineStart=function(fromNode){this.fromNode=fromNode};this.drawLineEnd=function(toNode){var json={Id:this.newLineId,FromNodeId:this.fromNode.getId(),ToNodeId:toNode.getId()};return new FlowLine(this,json,this.fromNode,toNode),this.fromNode=null,json};this.idToNode=function(id){return this.nodes.find(node=>node.getId()==id)};this.hasStartNode=function(){return this.nodes.some(node=>node.getNodeType()==_flow.TypeStart)};this._init(boxId)}function FlowNode(flowBase,json){this.DragStart="dragstart";this.DragMove="dragmove";this.DragEnd="dragend";this.MinWidth=80;this.MinHeight=42;this.LineHeight=18;this.PadTop=8;this.PadLeft=15;this.PinWidth=12;this.PinGap=3;this._init=function(flowBase,json){this.self=this;this.flowBase=flowBase;this.svg=flowBase.svg;this.json=Object.assign({Name:"Node",NodeType:_flow.TypeNode,PosX:json.PosX||100,PosY:json.PosY||100},json);this.lines=[];let nodeType=this.json.NodeType,cssClass="",nodeText="";this.elm=this.svg.group().attr("data-id",json.Id);let startEnd=this._isStartEnd();if(startEnd){nodeType==_flow.TypeStart?(cssClass="xf-start",nodeText=_flow.TypeStart):(cssClass="xf-end",nodeText=_flow.TypeEnd);this.boxElm=this.elm.circle().addClass(cssClass);let style=window.getComputedStyle(this.boxElm.node),radius=parseFloat(style.getPropertyValue("r"));this.boxElm.attr("r",radius);this.textElm=this.elm.text(nodeText).addClass(cssClass+"-text").attr({"text-anchor":"middle","dominant-baseline":"middle"})}else nodeText=this.json.Name,cssClass="xf-node",this.boxElm=this.elm.rect().addClass(cssClass).attr({"text-anchor":"middle","dominant-baseline":"middle"}),this.textElm=this.elm.text("").addClass(cssClass+"-text"),this.setName(nodeText,!1);this.elm.move(this.json.PosX,this.json.PosY);nodeType!=_flow.TypeEnd&&(this.pinElm=this.elm.rect(this.PinWidth,this.PinWidth).addClass("xf-pin"),this._setPinPos());this._setEvent()};this.getLines=function(){return this.lines};this._isStartEnd=function(){return this.json.NodeType==_flow.TypeStart||this.json.NodeType==_flow.TypeEnd};this.getNodeType=function(){return this.json.NodeType};this.getPos=function(){let elm=this.elm;return{x:elm.x(),y:elm.y()}};this.getSize=function(){let elm=this.boxElm;return{w:elm.width(),h:elm.height()}};this.getCenter=function(){let elm=this.boxElm;return{x:elm.cx(),y:elm.cy()}};this._setPinPos=function(){if(this.pinElm){let bbox=this.textElm.bbox(),center=this.getCenter();this.pinElm.move(center.x+bbox.width/2+3,center.y-5)}};this._setEvent=function(){let me=this,flowBase=this.flowBase;this.elm.node.addEventListener("contextmenu",function(event){event.preventDefault();flowBase.fnShowMenu&&flowBase.fnShowMenu(event,!0,me)});this.elm.draggable().on(this.DragMove,()=>{flowBase.isEdit&&this._drawLines()}).on(this.DragEnd,event=>{if(flowBase.isEdit){let{x,y}=event.detail.box;this.flowBase.fnMoveNode&&this.flowBase.fnMoveNode(this,x,y)}});this._setEventPin()};this._drawLines=function(){this.lines.forEach(line=>line.render())};this._setEventPin=function(){if(this.pinElm){let fromDom,startX,startY,tempLine,toElm=null,me=this,flowBase=this.flowBase;this.pinElm.draggable().on(this.DragStart,()=>{if(flowBase.isEdit){let{x,y}=me.pinElm.rbox(me.svg);startX=x;startY=y;fromDom=me.self.elm.node;tempLine=me.svg.line(startX,startY,startX,startY).addClass("xf-line off");flowBase.drawLineStart(me.self)}}).on(this.DragMove,event=>{if(flowBase.isEdit){event.preventDefault();let{x,y}=event.detail.box,endX=x,endY=y;if(tempLine.plot(startX,startY,endX,endY),isFinite(endX)&&isFinite(endY)){let svgRect=me.svg.node.getBoundingClientRect(),viewPortX=endX+svgRect.x,viewPortY=endY+svgRect.y,overDom=document.elementsFromPoint(viewPortX,viewPortY).find(dom=>dom!=fromDom&&(dom.classList.contains("xf-node")||dom.classList.contains("xf-end")));if(overDom){let overElm=overDom.instance;toElm!==overElm&&(toElm&&me._markNode(toElm,!1),toElm=overElm,me._markNode(toElm,!0))}else toElm&&(me._markNode(toElm,!1),toElm=null)}}}).on(this.DragEnd,()=>{if(flowBase.isEdit){if(toElm){me._markNode(toElm,!1);var id=toElm.parent().node.dataset.id,json=flowBase.drawLineEnd(flowBase.idToNode(id));toElm=null;flowBase.fnAfterAddLine&&flowBase.fnAfterAddLine(json)}tempLine.remove()}})}};this._markNode=function(elm,status){status?elm.node.classList.add("on"):elm.node.classList.remove("on")};this.getId=function(){return this.json.Id};this.addLine=function(line){this.lines.push(line)};this.deleteLine=function(line){let index=this.lines.findIndex(item=>item.Id==line.Id);this.lines.splice(index,1)};this.getName=function(){return this.textElm.text()};this.setName=function(name,drawLine){var lines=_str.replaceAll(name,"\\n","\n").split("\n"),width,height;this.textElm.clear().text(function(add){lines.forEach((line,i)=>{i>0?add.tspan(line).newLine().dy(this.LineHeight):add.tspan(line)})});const bbox=this.textElm.bbox();width=Math.max(this.MinWidth,bbox.width+this.PadLeft*2+this.PinWidth+this.PinGap*2);height=Math.max(this.MinHeight,bbox.height+this.PadTop*2);this.boxElm.size(Math.round(width),Math.round(height));this.textElm.center(this.boxElm.cx(),this.boxElm.cy());drawLine&&this._drawLines()};this._init(flowBase,json)}function FlowLine(flowBase,json,fromNode,toNode){this.MaxCntCnt1=6;this.MinSideCnt2=16;this.MinCntCnt3=20;this.MinSideSide13=12;this.ArrowLen=10;this.ArrowWidth=5;this.FromTypeAuto="A";this.FromTypeV="V";this.FromTypeH="H";this._init=function(flowBase,json,fromNode,toNode){json=json||{};json.FromType=json.FromType||this.FromTypeAuto;json.Label=json.Label||"";json.Id=json.Id||flowBase.getNewLineId();this.flowBase=flowBase;this.json=json;this.svg=flowBase.svg;this.fromNode=fromNode||this.flowBase.idToNode(json.FromNodeId);this.toNode=toNode||this.flowBase.idToNode(json.ToNodeId);this.path=this.svg.path("").attr("data-id",json.Id).addClass("xf-line");this.path2=this.svg.path("").attr("data-id",json.Id).fill("none").stroke({width:10,color:"transparent"}).attr({"pointer-events":"stroke",cursor:"pointer"});this.textElm=this.svg.text(json.Label).addClass("xf-line-text").font({anchor:"middle"});this.arrow=this.svg.path("").addClass("xf-arrow");this.fromNode.addLine(this);this.toNode.addLine(this);this._setEvent();this._setFromTypeVars(json.FromType);this.render()};this._setEvent=function(){var me=this;this.path2.node.addEventListener("contextmenu",function(event){event.preventDefault();me.flowBase.fnShowMenu&&me.flowBase.fnShowMenu(event,!1,me)})};this._setFromTypeVars=function(fromType){fromType=fromType||this.FromTypeAuto;this.fromType=fromType;this.isFromTypeV=fromType==this.FromTypeV;this.isFromTypeH=fromType==this.FromTypeH;var dom=this.path.node;fromType==this.FromTypeAuto?dom.classList.remove("xf-way"):dom.classList.add("xf-way")};this.getLabel=function(){return this.label};this.setLabel=function(label){this.label=label};this.render=function(){const fromPos=this.fromNode.getPos(),fromSize=this.fromNode.getSize(),fromCnt={x:fromPos.x+fromSize.w/2,y:fromPos.y+fromSize.h/2},fromUp={x:fromPos.x+fromSize.w/2,y:fromPos.y},fromDown={x:fromPos.x+fromSize.w/2,y:fromPos.y+fromSize.h},fromLeft={x:fromPos.x,y:fromPos.y+fromSize.h/2},fromRight={x:fromPos.x+fromSize.w,y:fromPos.y+fromSize.h/2},toPos=this.toNode.getPos(),toSize=this.toNode.getSize(),toCnt={x:toPos.x+toSize.w/2,y:toPos.y+toSize.h/2},toUp={x:toPos.x+toSize.w/2,y:toPos.y},toDown={x:toPos.x+toSize.w/2,y:toPos.y+toSize.h},toLeft={x:toPos.x,y:toPos.y+toSize.h/2},toRight={x:toPos.x+toSize.w,y:toPos.y+toSize.h/2},isToRight=toCnt.x>fromCnt.x,isToDown=toCnt.y>fromCnt.y,cntCntSize={w:Math.abs(fromCnt.x-toCnt.x),h:Math.abs(fromCnt.y-toCnt.y)},isMaxCntCnt1H=cntCntSize.w<=this.MaxCntCnt1,isMaxCntCnt1V=cntCntSize.h<=this.MaxCntCnt1,isMinSideCnt2H=cntCntSize.w-fromSize.w/2>=this.MinSideCnt2,isMinSideCnt2V=cntCntSize.h-toSize.h/2>=this.MinSideCnt2,isMinCntSide2H=cntCntSize.w-toSize.w/2>=this.MinSideCnt2,isMinCntSide2V=cntCntSize.h-fromSize.h/2>=this.MinSideCnt2,isMinCntCnt3H=(isToRight?toLeft.x-fromRight.x:fromLeft.x-toRight.x)>=this.MinCntCnt3,isMinCntCnt3V=(isToDown?toUp.y-fromDown.y:fromUp.y-toDown.y)>=this.MinCntCnt3,sideSideH=isToRight?toLeft.x-fromRight.x:fromLeft.x-toRight.x,sideSideV=isToDown?toUp.y-fromDown.y:fromUp.y-toDown.y,isMinSideSide1H=sideSideH>=this.MinSideSide13,isMinSideSide1V=sideSideV>=this.MinSideSide13,isMinSideSide3H=sideSideH>=this.MinSideSide13*2,isMinSideSide3V=sideSideV>=this.MinSideSide13*2;let fromPnt,toPnt,points,textStartAry=0;if(!this.isFromTypeH&&isMaxCntCnt1H&&isMinSideSide1V)isToDown?(fromPnt=fromDown,toPnt=toUp):(fromPnt=fromUp,toPnt=toDown),points=[fromPnt,{x:fromPnt.x,y:toPnt.y}];else if(!this.isFromTypeV&&isMaxCntCnt1V&&isMinSideSide1H)isToRight?(fromPnt=fromRight,toPnt=toLeft):(fromPnt=fromLeft,toPnt=toRight),points=[fromPnt,{x:toPnt.x,y:fromPnt.y}];else if(!this.isFromTypeV&&isMinSideCnt2H&&isMinCntSide2V)fromPnt=isToRight?fromRight:fromLeft,toPnt=isToDown?toUp:toDown,points=[fromPnt,{x:toPnt.x,y:fromPnt.y},toPnt],textStartAry=1;else if(!this.isFromTypeH&&isMinSideCnt2V&&isMinCntSide2H)fromPnt=isToDown?fromDown:fromUp,toPnt=isToRight?toLeft:toRight,points=[fromPnt,{x:fromPnt.x,y:toPnt.y},toPnt];else if(!this.isFromTypeH&&isMinSideSide3V&&isMinCntCnt3V){isToDown?(fromPnt=fromDown,toPnt=toUp):(fromPnt=fromUp,toPnt=toDown);let midY=(fromPnt.y+toPnt.y)/2;points=[fromPnt,{x:fromPnt.x,y:midY},{x:toPnt.x,y:midY},toPnt]}else if(!this.isFromTypeV&&isMinSideSide3H&&isMinCntCnt3H){isToRight?(fromPnt=fromRight,toPnt=toLeft):(fromPnt=fromLeft,toPnt=toRight);let midX=(fromPnt.x+toPnt.x)/2;points=[fromPnt,{x:midX,y:fromPnt.y},{x:midX,y:toPnt.y},toPnt];textStartAry=1}else if(!this.isFromTypeH&&isMinCntCnt3H){let midY;isToDown?(fromPnt=fromDown,toPnt=toDown,midY=Math.max(fromPnt.y,toPnt.y)+this.MinSideSide13):(fromPnt=fromUp,toPnt=toUp,midY=Math.min(fromPnt.y,toPnt.y)-this.MinSideSide13);points=[fromPnt,{x:fromPnt.x,y:midY},{x:toPnt.x,y:midY},toPnt]}else if(!this.isFromTypeV&&isMinCntCnt3V){let midX;isToRight?(fromPnt=fromRight,toPnt=toRight,midX=Math.max(fromPnt.x,toPnt.x)+this.MinSideSide13):(fromPnt=fromLeft,toPnt=toLeft,midX=Math.min(fromPnt.x,toPnt.x)-this.MinSideSide13);points=[fromPnt,{x:midX,y:fromPnt.y},{x:midX,y:toPnt.y},toPnt];textStartAry=1}else isToDown?isToRight?(fromPnt=this.isFromTypeH?fromRight:fromDown,toPnt=toLeft):(fromPnt=this.isFromTypeH?fromLeft:fromDown,toPnt=toRight):isToRight?(fromPnt=this.isFromTypeH?fromRight:fromUp,toPnt=toLeft):(fromPnt=this.isFromTypeH?fromLeft:fromUp,toPnt=toRight),points=[fromPnt,toPnt];this._drawLine(points);this.textElm.center((points[textStartAry].x+points[textStartAry+1].x)/2,(points[textStartAry].y+points[textStartAry+1].y)/2)};this._drawLine=function(points){let pathStr=`M ${points[0].x} ${points[0].y}`,pntLen=points.length,radius=this.MaxCntCnt1;for(let i=1;i<pntLen;i++){const prevPnt=points[i-1],nowPnt=points[i];if(i<pntLen-1){const nextPnt=points[i+1],vec1={x:nowPnt.x-prevPnt.x,y:nowPnt.y-prevPnt.y},vec2={x:nextPnt.x-nowPnt.x,y:nextPnt.y-nowPnt.y},len1=Math.sqrt(Math.pow(vec1.x,2)+Math.pow(vec1.y,2)),len2=Math.sqrt(Math.pow(vec2.x,2)+Math.pow(vec2.y,2)),unitVec1={x:vec1.x/len1,y:vec1.y/len1},unitVec2={x:vec2.x/len2,y:vec2.y/len2},arcStartX=nowPnt.x-unitVec1.x*radius,arcStartY=nowPnt.y-unitVec1.y*radius,arcEndX=nowPnt.x+unitVec2.x*radius,arcEndY=nowPnt.y+unitVec2.y*radius;pathStr+=` L ${arcStartX} ${arcStartY}`;const cross=unitVec1.x*unitVec2.y-unitVec1.y*unitVec2.x,sweepFlag=cross<0?0:1;pathStr+=` A ${radius} ${radius} 0 0 ${sweepFlag} ${arcEndX} ${arcEndY}`}else pathStr+=` L ${nowPnt.x} ${nowPnt.y}`}this.path.plot(pathStr);this.path2.plot(pathStr);this._drawArrow(points[pntLen-2],points[pntLen-1])};this._drawArrow=function(fromPnt,toPnt){const angle=Math.atan2(toPnt.y-fromPnt.y,toPnt.x-fromPnt.x),arrowPnt1={x:toPnt.x-this.ArrowLen*Math.cos(angle)+this.ArrowWidth*Math.cos(angle-Math.PI/2),y:toPnt.y-this.ArrowLen*Math.sin(angle)+this.ArrowWidth*Math.sin(angle-Math.PI/2)},arrowPnt2={x:toPnt.x-this.ArrowLen*Math.cos(angle)+this.ArrowWidth*Math.cos(angle+Math.PI/2),y:toPnt.y-this.ArrowLen*Math.sin(angle)+this.ArrowWidth*Math.sin(angle+Math.PI/2)};this.arrow.plot(`M ${toPnt.x} ${toPnt.y} L ${arrowPnt1.x} ${arrowPnt1.y} M ${toPnt.x} ${toPnt.y} L ${arrowPnt2.x} ${arrowPnt2.y}`)};this.getId=function(){return this.json.Id};this.getFromType=function(){return this.json.FromType};this.setFromType=function(fromType){fromType!=this.json.FromType&&(this._setFromTypeVars(fromType),this.render())};this._init(flowBase,json,fromNode,toNode)}function FlowForm(boxId,mNode,mLine){this.isEdit=!1;this._init=function(){var condOpMaps,j,i,flowBase;for(this.OrSep="{O}",this.AndSep="{A}",this.ColSep=",",this.MenuFilter=".xf-menu",this.StartNodeFilter=".xf-start",this.InitLineCfg={stroke:"blue",strokeWidth:2},this.mNode=mNode,this.mLine=mLine,this.divLinesBox=$("#divLinesBox"),this.eformNodes=$("#eformNodes"),this.eformLines=$("#eformLines"),this.modalNodeProp=$("#modalNodeProp"),this.modalLineProp=$("#modalLineProp"),this.eformNodeProp=this.modalNodeProp.find("form"),this.tbodyLineCond=this.modalLineProp.find("tbody"),this.tplNode=$("#tplNode").html(),this.tplLine=$("#tplLine").html(),this.tplLineCond=$("#tplLineCond").html(),this.nowIsNode=!1,this.nowFlowItem=null,condOpMaps=[this.OrSep,") || (",this.AndSep," && ",",EQ,","=",",NEQ,","!=",",GT,",">",",GE,",">=",",ST,","<",",SE,","<=",],this.condOpExprs=[],this.condOpShows=[],j=0,i=0;i<condOpMaps.length;i=i+2)this.condOpExprs[j]=new RegExp(condOpMaps[i],"g"),this.condOpShows[j]=condOpMaps[i+1],j++;flowBase=new FlowBase(boxId);flowBase.fnMoveNode=(node,x,y)=>this.fnMoveNode(node,x,y);flowBase.fnAfterAddLine=json=>this.fnAfterAddLine(json);flowBase.fnShowMenu=(event,isNode,flowItem)=>this.fnShowMenu(event,isNode,flowItem);this.flowBase=flowBase;this._setFlowEvent()};this.fnMoveNode=function(node,x,y){var rowBox=this.mNode.idToRowBox(node.getId());_form.loadRow(rowBox,{PosX:Math.floor(x),PosY:Math.floor(y)})};this.fnAfterAddLine=function(json){this.mLine.addRow(json,null,json.Id)};this.fnShowMenu=function(event,isNode,flowItem){this.nowIsNode=isNode;this.nowFlowItem=flowItem;var canEdit=isNode?this.isEdit&&flowItem.getNodeType()==_flow.TypeNode:this.isEdit,css="off",menu=$(this.MenuFilter);canEdit?(menu.find(".xd-edit").removeClass(css),menu.find(".xd-delete").removeClass(css)):(menu.find(".xd-edit").addClass(css),menu.find(".xd-delete").addClass(css));menu.finish().toggle(100).css({position:"fixed",left:event.clientX+"px",top:event.clientY+"px"})};this.setEdit=function(status){this.isEdit=status;this.flowBase.setEdit(status)};this._setFlowEvent=function(){var me=this;$(document).on("mousedown",function(e){var filter=me.MenuFilter;!$(e.target).parents(filter).length>0&&$(filter).hide(100)})};this.loadNodes=function(rows){this.mNode.loadRowsByRsb(rows,!0);this.flowBase.loadNodes(rows)};this.loadLines=function(rows){if(this.mLine.loadRowsByRsb(rows,!0),rows!=null)for(var i=0;i<rows.length;i++)rows[i].Label=this._condStrToLabel(rows[i].CondStr);this.flowBase.loadLines(rows)};this.addNode=function(nodeType,name){var json={Name:nodeType==_flow.TypeNode?name:"",NodeType:nodeType,PosX:100,PosY:100},row=this.mNode.addRow(json);row.Name+="-"+row.Id;this.flowBase.addNode(row)};this.deleteNode=function(node){this.mNode.deleteRow(node.getId());node.getLines().forEach(line=>{this.mLine.deleteRow(line.getId())});this.flowBase.deleteNode()};this.deleteLine=function(line){this.mLine.deleteRow(line.getId());this.flowBase.deleteLine(line)};this._condStrToLabel=function(str){var hasOr,i;if(_str.isEmpty(str))return"";for(hasOr=str.indexOf(this.OrSep)>0,i=0;i<this.condOpExprs.length;i++)str=str.replace(this.condOpExprs[i],this.condOpShows[i]);return hasOr&&(str="("+str+")"),str};this._condStrToList=function(str){var i,andList,j,cols;if(_str.isEmpty(str))return null;var orList=str.split(this.OrSep),orLen=orList.length,hasOr=orLen>1,result=[],ary=0;for(i=0;i<orLen;i++)for(andList=orList[i].split(this.AndSep),j=0;j<andList.length;j++)cols=andList[j].split(this.ColSep),result[ary]={AndOr:hasOr?this.OrSep:this.AndSep,Fid:cols[0],Op:cols[1],Value:cols[2]},ary++;return result};this._getCondStr=function(){var me=this,condStr="";return this.tbodyLineCond.find("tr").each(function(idx){var tr=$(this),str=(idx==0?"":_iselect.get("AndOr",tr))+_itext.get("Fid",tr)+me.ColSep+_iselect.get("Op",tr)+me.ColSep+_itext.get("Value",tr);condStr+=str}),condStr};this.showNodeProp=function(node){var rowBox=this.mNode.idToRowBox(node.getId());_form.loadRow(this.modalNodeProp,_form.toRow(rowBox));_modal.showO(this.modalNodeProp)};this.showLineProp=function(line){var rowBox=this.mLine.idToRowBox(line.getId()),form=this.modalLineProp.find("form"),condStr,condList,i,newCond;if(_iread.set("FromNodeName",line.fromNode.getName(),form),_iread.set("ToNodeName",line.toNode.getName(),form),_iselect.set("FromType",line.getFromType(),form),_itext.set("Sort",_itext.get("Sort",rowBox),form),_modal.showO(this.modalLineProp),this.tbodyLineCond.empty(),condStr=_itext.get("CondStr",rowBox),condList=this._condStrToList(condStr),condList!=null)for(i=0;i<condList.length;i++)newCond=$(this.tplLineCond),_form.loadRow(newCond,condList[i]),this.tbodyLineCond.append(newCond)};this.onAddNode=function(nodeType){if(nodeType==_flow.TypeStart){if(this.flowBase.hasStartNode()){_tool.msg("起始節點已經存在，不可再新增。");return}this.addNode(nodeType)}else nodeType==_flow.TypeEnd?this.addNode(nodeType):this.addNode(_flow.TypeNode,"節點")};this._menuStatus=function(me){return!me.classList.contains("off")};this.onMenuEdit=function(me){this._menuStatus(me)&&(this.nowIsNode?this.showNodeProp(this.nowFlowItem):this.showLineProp(this.nowFlowItem))};this.onMenuDelete=function(me){if(this._menuStatus(me)){var me=this;me.nowIsNode?_tool.ans("是否確定刪除這個節點和流程線?",function(){me.deleteNode(me.nowFlowItem)}):_tool.ans("是否確定刪除這一條流程線?",function(){me.deleteLine(me.nowFlowItem)})}};this.onMenuView=function(){};this.onAddLineCond=function(){var row={AndOr:this.AndSep,Op:"eq"},cond=$(Mustache.render(this.tplLineCond,row));_form.loadRow(cond,row);this.tbodyLineCond.append(cond)};this.onDeleteLineCond=function(btn){$(btn).closest("tr").remove()};this.onModalNodeOk=function(){var row=_form.toRow(this.eformNodeProp),node=this.nowFlowItem,rowBox=this.mNode.idToRowBox(node.getId()),oldName=_itext.get("Name",rowBox);_form.loadRow(rowBox,row);oldName!=row.Name&&node.setName(row.Name,!0);_modal.hideO(this.modalNodeProp)};this.onModalLineOk=function(){var modal=this.modalLineProp,row={CondStr:this._getCondStr(),Sort:_itext.get("Sort",modal),FromType:_iselect.get("FromType",modal)},line=this.nowFlowItem,rowBox=this.mLine.idToRowBox(line.getId());_form.loadRow(rowBox,row);line.setLabel(this._condStrToLabel(row.CondStr));line.setFromType(row.FromType);_modal.hideO(modal)};this._init()}function Page(config){this.pager=config.pager;this.linker=config.linker;this.action=config.action;this.showMenu=config.showMenu||_var.notEmpty(config.pageRowList);this.pageRowList=config.pageRowList||[10,25,50,100];this._init=function(pageStr,onFind){var arg,pager,menu,cols;if(this.pageArg=this._getPageArg(pageStr),arg=this.pageArg,pager=this.pager,arg.filterRows<=0){pager.hide();_tool.msg(_BR.FindNone);return}if(menu="",this.showMenu){cols=_BR.Page.split("@@");menu=cols[0].replace("_Menu",this._getMenuHtml());var start=(arg.pageNo-1)*arg.pageRows+1,end=start+arg.pageRows-1,info=cols[1].replace("_Start",start).replace("_End",end<=arg.filterRows?end:arg.filterRows).replace("_Total",arg.filterRows);menu=_str.format("<div class='xg-page-menu'><label>{0}<span>{1}<\/span><\/label><\/div>",menu,info)}pager.html(menu+"<div class='xg-page-btns'><\/div>");pager.find("select").change(function(){onFind()});pager.find(".xg-page-btns").pagination({currentPage:arg.pageNo,itemsOnPage:arg.pageRows,items:arg.filterRows,listStyle:"pagination "+(this.showMenu?"xg-has-menu":"xg-no-menu"),prevText:"<",nextText:">",onPageClick:onFind})};this._getMenuHtml=function(){for(var menu="<select class='form-select' style='width:80px; display:inline-block'>",i=0;i<this.pageRowList.length;i++)menu+=_str.format("<option value='{0}'{1}>{0}<\/option>",this.pageRowList[i],this.pageArg.pageRows==this.pageRowList[i]?" selected":"");return menu+"<\/select>"};this._getPageArg=function(pageStr){var json=JSON.parse(_html.decode(pageStr));return json.pageNo==null&&(json.pageNo=1),json.pageRows==null&&(json.pageRows=0),json.filterRows==null&&(json.filterRows=-1),json};this.find=function(json,page){var arg,url,key,linker;json=json||{};arg=this.pageArg;_var.isEmpty(page)?(arg.pageNo=1,arg.filterRows=-1,arg.pageRows=this.pager.find("select").val()):arg.pageNo=page;url=this.action+"?page="+arg.pageNo+"&rows="+arg.pageRows+"&filter="+arg.filterRows;for(key in json)_str.notEmpty(json[key])&&(url+="&"+key+"="+json[key]);linker=this.linker;_obj.isExist(linker)?(linker.attr("href",url),linker.trigger("click")):window.location=url};this._init(config.pageStr,config.onFind)}var _ajax={getJsonA:async function(url,data,fnOk){var json={url:url,type:"POST",data:data,dataType:"json"};return await _ajax._rpcA(json,fnOk)},getJsonByFdA:async function(url,data,fnOk,block){var json={url:url,type:"POST",data:data,dataType:"json",cache:!1,contentType:!1,processData:!1};return await _ajax._rpcA(json,fnOk,block)},getStrA:async function(url,data,fnOk,block){var json={url:url,type:"POST",data:data,dataType:"text"};return await _ajax._rpcA(json,fnOk,block)},getViewA:async function(url,data,fnOk,block){var json={url:url,type:"POST",data:data,dataType:"html"};return await _ajax._rpcA(json,fnOk,block)},getImageFileA:async function(url,data,block){var json={url:url,type:"POST",data:data,dataType:"html"};return await _ajax._rpcA(json,null,block)},_rpcA:async function(json,fnOk,block){var status,result,errMsg,errJson,i,row,edit;_var.isEmpty(block)&&(block=!0);block&&_fun.block();status=!1;result=null;try{if(_jwt.jsonAddJwtHeader(json),result=await $.ajax(json),errMsg=_ajax.resultToErrMsg(result),_str.notEmpty(errMsg))result=null,_tool.msg(errMsg);else if(result.ErrorRows&&result.ErrorRows.length>0)for(errJson={},i=0;i<result.ErrorRows.length;i++)row=result.ErrorRows[i],edit=_str.isEmpty(row.FormId)?_me.edit0:$("#"+row.FormId),errJson[row.Fid]=row.Msg,edit.validator.showErrors(errJson);else fnOk&&(fnOk(result),status=!0)}catch(error){console.error(error)}return block&&_fun.unBlock(),fnOk==null?result:status},_isBrError:function(result){return result.length>=2&&result.substring(0,2)===_fun.PreBrError},resultToErrMsg:function(result){return result.ErrorMsg?_ajax.strToErrMsg(result.ErrorMsg):""},strToErrMsg:function(str){if(_str.isEmpty(str))return"";if(!_ajax._isBrError(str))return str;var fid=str.substring(2);return _BR[fid]?_BR[fid]:_str.format("_ajax.strToErrMsg() failed, no BR Fid={0}",fid)}},_array={find:function(ary,id){if(ary==null)return-1;for(var i=0;i<ary.length;i++)if(ary[i]==id)return i;return-1},toStr:function(ary,sep){return sep=sep||",",ary.join(sep)}},_assert={echo:function(msg){_error.log("_assert.js "+msg)},inArray:function(value,ary){var find=!1;for(var item in ary)if(item==value){find=!0;break}find||_assert.echo("inArray failed: "+value)}},_browser={_langCode:"_langCode",pushState:function(url){history.pushState(null,null,url)},zz_print:function(id,fm,fnCallback){_browser.printO(_obj.getById(id,fm,fnCallback))},zz_printO:function(){window.print()}},_btn={setEdit:function(id,status,box){_btn.setEditO(_obj.getById(id,box),status)},setEditO:function(obj,status){obj.prop("disabled",!status)},setEditF:function(ft,status,box){_btn.setEditO(_obj.getF(ft,box),status)}},_chart={rainbowColors:["#F32E37","#EABE37","#89E926","#22E352","#2FE5E8","#295AE7","#8828EE","#E629B7",],_show:function(type,canvasObj,dto,legend,percent){legend==null&&(legend=!0);percent==null&&(percent=!1);var isHbar=type=="hbar",config={type:isHbar?"bar":type,data:{labels:dto.labels,datasets:[{data:dto.values}]},options:{plugins:{legend:{position:"bottom",display:legend},animation:{animateScale:!0,animateRotate:!0},title:{display:!0,text:dto.title,font:{size:16}}}}};return dto.options!=null&&(config.options=_json.copy(dto.options,config.options)),percent&&(config.options.plugins.tooltip={callbacks:{label:function(ctx){var list=ctx.dataset.data,sum,percent;return ctx.chart._sum==null&&(sum=0,list.map(a=>{sum+=a}),ctx.chart._sum=sum),ctx._oldLabel==null&&(ctx._oldLabel=ctx.label+" "+ctx.formattedValue),percent=(list[ctx.dataIndex]*100/ctx.chart._sum).toFixed(2)+"%",ctx._oldLabel+" ("+percent+")"}}}),new Chart(canvasObj,config)},line:function(canvasObj,dto){return _chart._show("line",canvasObj,dto,!1)},hbar:function(canvasObj,dto){return dto.options={indexAxis:"y"},_chart._show("hbar",canvasObj,dto,!1)},pie:function(canvasObj,dto){return _chart._show("pie",canvasObj,dto,null,!0)},doughnut:function(canvasObj,dto){return _chart._show("doughnut",canvasObj,dto,null,!0)},groupLine:function(canvasObj,dto){return _chart._show("line",canvasObj,dto)},groupBar:function(canvasObj,dto){return _chart._show("bar",canvasObj,dto)},drawLine:function(canvasId,ids,values,color){_chart._clear();_chart._nowChart=new Chart(document.getElementById(canvasId),{type:"line",data:{labels:ids,datasets:[{data:values,borderColor:color,fill:!1}]},options:{plugins:{legend:{display:!1}}}})},initPie:function(canvasObj,labels,values,colors,config){var config0={type:"pie",options:{legend:{position:"right",labels:{boxWidth:10}}},data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderWidth:1}]}};return config&&(config0=_json.copy(config,config0)),new Chart(canvasObj,config0)}},_date={getStartEnd:function(){},uiToday:function(){var mm=moment();return _date.mmToUiDate(mm)},uiWeekMonday:function(){var mm=moment().day(1);return _date.mmToUiDate(mm)},uiWeekFriday:function(){var mm=moment().day(5);return _date.mmToUiDate(mm)},uiMonthDay1:function(){var mm=moment().startOf("month");return _date.mmToUiDate(mm)},uiMonthDayLast:function(){var mm=moment().endOf("month");return _date.mmToUiDate(mm)},nowYear:function(){return(new Date).getFullYear()},mmToUiDate:function(mm){return mm.format(_BR.MmUiDateFmt)},mmToUiDt:function(mm){return mm.format(_BR.MmUiDtFmt)},mmToUiDt2:function(mm){return mm.format(_BR.MmUiDt2Fmt)},dtsToUiDate:function(dts){return _str.isEmpty(dts)?"":_date.mmToUiDate(moment(dts,_fun.MmDtFmt))},dtsToFormat:function(ds){return _str.isEmpty(ds)?"":_date.mmToUiDate(moment(ds,_fun.MmDateFmt))},dtsToUiDt:function(dts){return _str.isEmpty(dts)?"":_date.mmToUiDt(moment(dts,_fun.MmDtFmt))},dtsToUiDt2:function(dts){return _str.isEmpty(dts)?"":_date.mmToUiDt2(moment(dts,_fun.MmDtFmt))},dtsToFormat:function(dts,format){return _str.isEmpty(dts)?"":moment(dts,_fun.MmDtFmt).format(format)},dtsToValue:function(dts){return _str.isEmpty(dts)?0:moment(dts,_fun.MmDtFmt).valueOf()},dtsToMoment:function(dts){return _str.isEmpty(dts)?null:moment(dts,_fun.MmDtFmt)},uiToMmDate:function(ds){return _str.isEmpty(ds)?"":moment(ds,_BR.MmUiDateFmt).format(_fun.MmDateFmt)},tsToUiDt:function(ts){return ts==""?"":moment(parseInt(ts)*1e3).format(_BR.MmUiDtFmt)},getHourStr:function(){},getDt:function(fDate,fTime,box){var date=_idate.get(fDate,box),time=_iselect.get(fTime,box);return date==""?"":time==""?date:date+" "+time},isBig:function(ds1,ds2){return moment(ds1,_fun.MmDtFmt).isAfter(moment(ds2,_fun.MmDtFmt))},getMonthDiff:function(ds1,ds2){return _str.isEmpty(start)||_str.isEmpty(end)?0:_date.getMonthDiffByDate(moment(ds1,_fun.MmDtFmt),moment(ds2,_fun.MmDtFmt))},getMonthDiffByDate:function(dt1,dt2){return(dt2.getFullYear()-dt1.getFullYear())*12+dt2.getMonth()-dt1.getMonth()+1},dsAddYear:function(ds,year){return moment(ds,_fun.MmDtFmt).add(year,"y").format(_fun.MmDtFmt)}},_edit={Rows:"_rows",Childs:"_childs",Deletes:"_deletes",FileJson:"_fileJson",DataOld:"_old",IsNew:"_IsNew",ModeBase:"Base",ModeUR:"UR",initVars:function(me,box){var fidTypes=[];box.find(_input.fidFilter()).each(function(i,item){var obj=$(item),j=i*2;fidTypes[j]=_input.getFid(obj);fidTypes[j+1]=_input.getType(obj)});me.fidTypes=fidTypes;me.fidTypeLen=me.fidTypes.length;me.fileFids=[];box.find("[data-type=file]").each(function(index,item){me.fileFids[index]=_input.getFid($(item))});me.fileLen=me.fileFids.length;me.hasFile=me.fileFids.length>0},getOld:function(obj){return obj.data(_edit.DataOld)},setOld:function(obj,value){obj.data(_edit.DataOld,value)},isNewRow:function(row){var fid=_edit.IsNew;return row[fid]!=null||row[fid]=="1"},addIsNew:function(box){var fid=_edit.IsNew,field=box.find(_input.fidFilter(fid));field.length==0?field=box.append(`<input type="hidden" data-fid="${fid}" name="${fid}" value="1" >`):field.val("1")},removeIsNew:function(box){var fid=_edit.IsNew,field=box.find(_input.fidFilter(fid));field.length>0&&field.remove()}},_error={log:function(msg){console.log(msg)}},_file={getFileName:function(path){var sep=path.indexOf("/")>0?"/":"\\";return _str.getTail(path,sep)},getFileExt:function(path){return _str.getTail(path,".").toLowerCase()},isImageExt:function(ext){return",jpg,jpeg,png,gif,tif,tiff,".indexOf(","+ext+",")>=0},isExcelExt:function(ext){return",xls,xlsx,".indexOf(","+ext+",")>=0}},_form={toRow:function(form){var row={};return form.find(_input.fidFilter()).filter(":not(.xi-unsave)").each(function(){var obj=$(this);row[_input.getFid(obj)]=_input.getO(obj,form)}),row},toRowStr:function(form){return JSON.stringify(_form.toRow(form))},loadRow:function(form,row){for(var key in row)_input.set(key,row[key],form)},reset:function(form){form.find(_input.fidFilter()).each(function(){_input.setO($(this),"",form)})},hasFile:function(form){return form.find(":file").length>0},setEdit:function(form,status){_itext.setEditO(form.find("input:text"),status);_itextarea.setEditO(form.find("textarea"),status);_idate.setEditO(form.find(".date input"),status);_iselect.setEditO(form.find("select"),status);_icheck.setEditO(form.find(":checkbox"),status);_iradio.setEditO(form.find(":radio"),status);_btn.setEditO(form.find("button"),status)},hideShow:function(hides,shows){var form1,i,form2;if(hides)for(i=0;i<hides.length;i++)form1=hides[i],form1.fadeOut(500,function(){form1.hide()});if(shows)for(i=0;i<shows.length;i++)form2=shows[i],form2.fadeIn(500,function(){form2.show()})}},_formData={},_fun={MmDateFmt:"YYYY/MM/DD",MmDtFmt:"YYYY/MM/DD HH:mm:ss",FunC:"C",FunR:"R",FunU:"U",FunD:"D",FunV:"V",PreBrError:"B:",HideRwd:"xg-hide-rwd",locale:"zh-TW",maxFileSize:50971520,isRwd:!1,pageRows:10,dtColDef:{className:"xg-center",orderable:!1,targets:"_all"},userId:"",init:function(locale){_fun.locale=locale;_leftmenu.init();_pjax.init(".xu-body");_tool.init();moment.locale(_fun.locale)},onHelloA:async function(){await _ajax.getStrA("../Fun/Hello",null,function(msg){alert(msg)})},"default":function(val,defVal){return val==null?defVal:val},hasValue:function(obj){return!(obj==null)},onSetLocaleA:async function(code){await _ajax.getStrA("../Fun/SetLocale",{code:code},function(){location.reload()})},block:function(){$.blockUI({message:'<table><tr><td style="height:50px">   <i class="spinner ico-spin"><\/i>   <span style="margin-left:3px; vertical-align:middle;">'+_BR.Working+"<\/span><\/td><\/tr><\/table>",css:{padding:"0 30px",borderWidth:"2px",width:"auto",left:"42%"},overlayCSS:{opacity:.3}})},unBlock:function(){$.unblockUI()}},_helper={getBaseProp:function(rowNo,fid,value,type,required,editable,extAttr){var attr=_str.format("type='{0}' data-id='{1}' name='{2}' value='{3}'",type,fid,fid+rowNo,value);return required===!0&&(attr+=" required"),editable===!1&&(attr+=" readonly"),_str.notEmpty(extAttr)&&(attr+=" "+extAttr),_str.trim(attr)}},_html={encodeRow:function(row,fields){for(var id,i=0;i<fields.length;i++)id=fields[i],row[id]=_html.encode(row[id]);return row},encode:function(value){return $("<div/>").text(value).html()},decode:function(value){return $("<div/>").html(value).text()},update:function(id,box){var filter="#"+id,obj=box===undefined?$(filter):box.find(filter);obj.summernote("code",obj.text())},updates:function(ids,box){for(var i=0;i<ids.length;i++)_html.update(ids[i],box)}},_ibase={get:function(fid,box){return this.getO(_obj.get(fid,box))},getF:function(ft,box){return this.getO(_obj.getF(ft,box))},getD:function(id,box){return this.getO(_obj.getD(id,box))},getO:function(obj){return obj==null?null:obj.val()},getBorder:function(obj){return obj},set:function(fid,value,box){this.setO(_obj.get(fid,box),value)},setF:function(ft,value,box){this.setO(_obj.getF(ft,box),value)},setO:function(obj,value){obj.val(value);obj.text(value)},setEdit:function(fid,status,box){this.setEditO(_obj.get(fid,box),status)},setEditF:function(ft,status,box){this.setEditO(_obj.getF(ft,box),status)},setEditO:function(obj,status){obj.prop("readonly",!status)}},_icheck=$.extend({},_ibase,{Check0Id:"_check0",getO:function(obj){return obj.is(":checked")?obj.data("value"):"0"},setO:function(obj,value){var status=!(value==null||value=="0"||value=="False"||value==!1);obj.prop("checked",status)},setEditO:function(obj,status){obj.prop("disabled",!status)},checked:function(fid,form){return _icheck.checkedO(_obj.get(fid,form))},checkedF:function(filter,form){return _icheck.checkedO(_obj.getF(filter,form))},checkedO:function(obj){return obj.is(":checked")},getCheckeds:function(form,fid){fid=fid||_icheck.Check0Id;var ary=[];return _obj.getF(_input.fidFilter(fid)+":checked",form).each(function(i){ary[i]=$(this).data("value")}),ary}}),_icolor={init:function(){$(".xg-color").colorpicker({})},get:function(fid,form){return _icolor.getO(_obj.get(fid,form))},getF:function(filter,form){return _icolor.getO(_obj.getF(filter,form))},getO:function(obj){return _icolor.rgbToHex(obj.find("i").css("background-color"))},rgbToHex:function(rgb){var parts=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),i;for(delete parts[0],i=1;i<=3;++i)parts[i]=parseInt(parts[i]).toString(16),parts[i].length==1&&(parts[i]="0"+parts[i]);return"#"+parts.join("")}},_idate=$.extend({},_ibase,{BoxFilter:".date",getO:function(obj){return _date.uiToMmDate(obj.val())},setO:function(obj,value){_idate._boxSetDate(_idate._objToBox(obj),value)},setEditO:function(obj,status){obj.prop("disabled",!status)},init:function(box,fid){var obj=_str.isEmpty(fid)?box.find(_idate.BoxFilter):_obj.get(fid,box).closet(_idate.BoxFilter);if(obj.length!=0){obj.datepicker({language:_fun.locale,autoclose:!0,showOnFocus:!1,todayHighlight:!0}).on("changeDate",function(){_idate._boxGetInput($(this)).valid()});obj.find(".input-group-addon").off("click")}},onToggle:function(btn){_idate._elmToBox(btn).datepicker("show")},onReset:function(btn){var box=_idate._elmToBox(btn),input=_idate._boxGetInput(box);_idate.getEditO(input)&&_idate._boxSetDate(box,"")},getEditO:function(obj){return!obj.is(":disabled")},_elmToBox:function(elm){return _idate._objToBox($(elm))},_objToBox:function(obj){return obj.closest(_idate.BoxFilter)},_boxSetDate:function(box,date){box.datepicker("update",date);box.trigger({type:"changeDate",date:date})},_boxGetInput:function(box){return box.find("input")}}),_idt=$.extend({},_idate,{getO:function(obj){var date=_idate.getO(_idt._boxGetDate(obj));return _str.isEmpty(date)?"":date+" "+_iselect.getO(_idt._boxGetHour(obj))+":"+_iselect.getO(_idt._boxGetMin(obj))},setO:function(obj,value){var date,hour,min;_str.isEmpty(value)?(date="",hour=0,min=0):(date=value,hour=parseInt(_str.getMid(value," ",":")),min=parseInt(_str.getMid(value,":",":")));_idate.setO(_idt._boxGetDate(obj),date);_iselect.setO(_idt._boxGetHour(obj),hour);_iselect.setO(_idt._boxGetMin(obj),min)},setEditO:function(obj,status){_idate.setEditO(_idt._boxGetDate(obj),status);_iselect.setEditO(_idt._boxGetHour(obj),status);_iselect.setEditO(_idt._boxGetMin(obj),status)},_boxGetDate:function(box){return box.find("input:first")},_boxGetHour:function(box){return box.find("select:first")},_boxGetMin:function(box){return box.find("select:last")}}),_ifile=$.extend({},_ibase,{getBorder:function(obj){return obj.prev()},setO:function(obj,value){obj.val(value);_ifile._elmToLink(obj).text(value)},dataAddFile:function(data,fid,serverFid,box){var obj=_obj.get(fid,box),file=_ifile.getUploadFile(_ifile._elmToFile(obj)),hasFile=file!=null;return hasFile&&data.append(serverFid,file),hasFile},onOpenFile:function(btn){var file=_ifile._elmToFile(btn);file.focus().trigger("click")},onChangeFile:function(file){var obj=_ifile._elmToObj(file),fileObj=$(file),value=file.value,exts,ext,max;if(_str.isEmpty(value)){_ifile.setO(obj,"");return}if(exts=fileObj.data("exts").toLowerCase(),_str.notEmpty(exts)&&exts!=="*"&&(ext=_file.getFileExt(value),exts=","+exts+",",exts.indexOf(","+ext+",")<0)){_tool.msg(_BR.UploadFileNotMatch);file.value="";return}if(max=fileObj.data("max"),file.files[0].size>max*1048576){_tool.msg(_str.format(_BR.UploadFileNotBig,max));file.value="";return}_ifile.setO(obj,_file.getFileName(value))},onDeleteFile:function(btn){_ifile.setO(_ifile._elmToObj(btn),"")},zz_init:function(fid,path,form){var fileObj=_obj.get(fid,form);fileObj.val("")},_elmToBox:function(elm){return $(elm).closest(".xi-box")},_elmToFile:function(elm){return _ifile._boxGetFile(_ifile._elmToBox(elm))},_elmToObj:function(elm){return _ifile._boxGetObj(_ifile._elmToBox(elm))},_elmToLink:function(elm){return _ifile._boxGetLink(_ifile._elmToBox(elm))},_boxGetLink:function(box){return box.find("button").last()},_boxGetFile:function(box){return box.find(":file")},_boxGetObj:function(box){return box.find("[data-type=file]")},getUploadFile:function(fileObj){if(fileObj.length==0)return null;var files=fileObj.get(0).files;return files.length>0?files[0]:null}}),_ihtml=$.extend({},_ibase,{Filter:"[data-type=html]",getO:function(obj){return obj.summernote("code")},setO:function(obj,value){obj.summernote("code",value)},setEditO:function(obj,status){obj.summernote(status?"enable":"disable")},init:function(edit,prog,height){edit.eform.find(_ihtml.Filter).each(function(){var upMe=$(this);upMe.data("prog",prog);upMe.summernote({height:height||200,callbacks:{onChange:function(contents){var me=$(this);me.summernote("isEmpty")?(me.val(""),me.summernote("code")!=""&&me.summernote("code","")):me.val(contents);edit.validator.element(me)},onImageUpload:function(files){var me=$(this),data=new FormData;data.append("file",files[0]);$.ajax({data:data,type:"POST",url:"SetHtmlImage",cache:!1,contentType:!1,processData:!1,success:function(url){var image=document.createElement("img");image.src=url;me.summernote("insertNode",image)}})}}})})},setEdits:function(box,subFilter,status){var items=box.find(_ihtml.Filter+subFilter);items.length>0&&items.summernote(status?"enable":"disable")}}),_ilink={get:function(fid,form){return this.getO(_obj.get(fid,form))},getO:function(obj){return obj.text()},set:function(fid,value,form){this.setO(_obj.get(fid,form),value)},setO:function(obj,value){obj.text(value)}},_input={get:function(fid,box){return _input.getO(_obj.get(fid,box),box)},getO:function(obj,box,type){type=type||_input.getType(obj);switch(type){case"text":return _itext.getO(obj);case"textarea":return _itextarea.getO(obj);case"check":return _icheck.getO(obj);case"radio":return _iradio.getO(obj,box);case"select":return _iselect.getO(obj);case"date":return _idate.getO(obj);case"dt":return _idt.getO(obj);case"file":return _ifile.getO(obj);case"html":return _ihtml.getO(obj);case"read":return _iread.getO(obj);case"link":return _ilink.getO(obj);default:return obj.val()}},set:function(fid,value,box){_input.setO(_obj.get(fid,box),value,box)},setO:function(obj,value,box,type){if(obj!=null&&_var.isPureData(value)){type=type||_input.getType(obj);switch(type){case"text":_itext.setO(obj,value);break;case"check":_icheck.setO(obj,value);break;case"radio":value=value||"0";_iradio.setO(obj,value,box);break;case"select":_iselect.setO(obj,value);break;case"date":return _idate.setO(obj,value);case"dt":return _idt.setO(obj,value);case"file":_ifile.setO(obj,value);break;case"textarea":_itextarea.setO(obj,value);break;case"html":_ihtml.setO(obj,value);break;case"read":var format=obj.data("format");_str.notEmpty(format)&&_str.notEmpty(_BR[format])&&(value=_date.dtsToFormat(value,_BR[format]));_iread.setO(obj,value);break;case"link":return _ilink.setO(obj,value);default:obj.val(value)}}},getType:function(obj){return obj.data("type")},getObj:function(fid,box,ftype){return ftype=ftype||_input.getType(_obj.get(fid,box)),ftype==="radio"?_iradio.getObj(fid,box):_obj.get(fid,box)},getFid:function(obj){return obj.data("fid")},fidFilter:function(fid){return _str.isEmpty(fid)?"[data-fid]":`[data-fid='${fid}']`}},_iradio=$.extend({},_ibase,{get:function(fid,box){return _iradio._getByName(fid,box)},getO:function(obj,box){return _iradio._getByName(_obj.getName(obj),box)},getObj:function(fid,box){return _obj.getF("[name="+fid+"]:checked",box)},_getByName:function(name,box){return _iradio.getObj(name,box).data("value")},set:function(fid,value,box){_iradio._setByName(fid,value,box)},setO:function(obj,value,box){_iradio._setByName(_obj.getName(obj),value,box)},_setByName:function(name,value,box){var obj=_obj.getF("[name="+name+"][data-value="+value+"]",box);obj!=null&&obj.prop("checked",!0)},setEdit:function(fid,status,box){_iradio.setEditOs(_obj.get(fid,box))},setEditOs:function(objs,status){objs.attr("disabled",!status)},render:function(fid,label,checked,value,editable,extClass,extProp){return label=label||"",extClass=extClass||"",extProp=extProp||"",value=value||"",label==""&&(label="&nbsp;"),_str.isEmpty(value)&&(value=1),extProp+=" data-id='"+fid+"' name='"+fid+"' value='"+value+"'",checked&&(extProp+=" checked"),editable===undefined||editable||(extProp+=" disabled"),_str.format("<label class='xi-check {0}'>   <input type='radio'{1}>{2}   <span class='xi-rspan'><\/span><\/label>",extClass,extProp,label)}}),_iread={get:function(fid,form){return _iread.getO(_obj.get(fid,form))},getF:function(filter,form){return _iread.getO(_obj.getF(filter,form))},getO:function(obj){return obj.text()},set:function(fid,value,form){_iread.setO(_obj.get(fid,form),value)},setF:function(filter,value,form){_iread.setO(_obj.getF(filter,form),value)},setO:function(obj,value){obj.text(value)}},_iselect=$.extend({},_ibase,{getO:function(obj){return obj.length===0?"":obj.find("option:selected").val()},setO:function(obj,value){filter='option[value="'+value+'"]';var item=obj.find(filter);return item.length>0?(item.prop("selected",!0),item):(obj.find("option:selected").prop("selected",!1),null)},setEditO:function(obj,status){obj.prop("disabled",!status)},getIndex:function(fid,box){return _iselect.getIndexO(_obj.get(fid,box))},getIndexO:function(obj){return obj.prop("selectedIndex")},getCount:function(fid,box){return _iselect.getCountO(_obj.get(fid,box))},getCountO:function(obj){return obj.find("option").length},setIndex:function(fid,idx,box){_iselect.setIndexO(_obj.get(fid,box),idx)},setIndexO:function(obj,idx){obj.find("option").eq(idx).prop("selected",!0)},getText:function(fid,box){var obj=_obj.get(fid,box);return _iselect.getTextO(obj)},getTextO:function(obj){return obj.find("option:selected").text()},getData:function(fid,name,box){return _obj.get(fid,box).find("option:selected").data(name)},getDataO:function(obj,name){return obj.find("option:selected").data(name)},setItems:function(fid,items,box){var obj=_obj.get(fid,box);_iselect.setItemsO(obj,items)},setItemsF:function(filter,items,box){var obj=_obj.getF(filter,box);_iselect.setItemsO(obj,items)},setItemsO:function(obj,items){if(obj.find("option").remove(),items!==null)for(var i=0;i<items.length;i++)obj.append($("<option><\/option>").attr("value",items[i].Id).text(items[i].Str))},getExts:function(fid,box){var rows=[];return _obj.get(fid,box).find("option").each(function(i){var me=$(this);rows[i]={Id:me.val(),Str:me.text(),Ext:me.data("ext")}}),rows},setExts:function(fid,items,box){var filter="#"+fid,obj=box?box.find(filter):$(filter),i;if(obj.find("option").remove(),items!=null)for(i=0;i<items.length;i++)obj.append(_str.format("<option data-ext='{0}' value='{1}'>{2}<\/option>",items[i].Ext,items[i].Id,items[i].Str))},valuesToJson:function(json,fids,box){for(var i=0;i<fids.length;i++)json[fids[i]]=_iselect.get(fids[i],box);return json},filterByExt:function(fid,value,rows,box,allItem,addEmptyStr){var obj,len,i,row;for(allItem===undefined&&(allItem=!1),obj=_obj.get(fid,box),obj.empty(),addEmptyStr!=""&&obj.append(_str.format('<option value="">{0}<\/option>',addEmptyStr)),len=rows.length,i=0;i<len;i++)row=rows[i],(allItem===!0&&row.Ext==""||row.Ext==value)&&obj.append(_str.format('<option value="{0}">{1}<\/option>',row.Id,row.Str));len>0&&_iselect.setIndexO(obj,0)},onChangeParent:function(parentFid,childFid,childId,action,isEdit){var box=isEdit?_me.crudE.divEdit:_me.crudR.divRead,thisId=_iselect.get(parentFid,box);_ajax.getJsonA(action,{parentId:thisId},rows=>{_iselect.setItems(childFid,rows,box),_str.notEmpty(childId)&&_iselect.set(childFid,childId,box)})}}),_itext=$.extend({},_ibase,{mask:function(box){_obj.getF("[data-mask!='']",box).each(function(){var me=$(this);me.mask(me.data("mask"))})}}),_itextarea=$.extend({},_ibase,{}),_json={toChartRows:function(json,cols){for(var fid,rows=[],i=0;i<cols.length;i++)fid=cols[i],rows.push({Id:fid,Num:json[fid]});return rows},copy:function(from,to){var to=to||{};for(var key in from)to[key]=from[key];return to},keyValuesToJson:function(keyValues,keyId,valueId){var data,i,row;if(keyValues===null||keyValues.length===0)return null;for(keyId||(keyId="Key"),valueId||(valueId="Value"),data={},i=0;i<keyValues.length;i++)row=keyValues[i],data["f"+row[keyId]]=row[valueId];return data},toStr:function(json){return _json.isEmpty(json)?"":JSON.stringify(json)},isEmpty:function(json){return json==null||$.isEmptyObject(json)},isKeyValue:function(value){return Object.prototype.toString.call(value)==="[object Object]"},urlToJson:function(url){url.indexOf("?")>-1&&(url=url.split("?")[1]);var pairs=url.split("&"),json={};return pairs.forEach(function(pair){pair=pair.split("=");pair[0]!==""&&(json[pair[0]]=decodeURIComponent(pair[1]||""))}),json},strToArray:function(str){return $.parseJSON(str)},findIndex:function(rows,fid,value){if(rows==null)return-1;for(var i=0;i<rows.length;i++)if(rows[i][fid]==value)return i;return-1},filterRows:function(rows,fid,value){return rows==null||rows.length==0?null:rows.filter(function(row){return row[fid]===value})},appendRows:function(froms,tos){var len,i;if(froms!=null&&froms.length!=0)for(len=tos.length,i=0;i<froms.length;i++)tos[len+i]=froms[i]},removeNull:function(obj,level){level=level||0;$.each(obj,function(key,value){var len,isEmpty,i;if(value===null)delete obj[key];else if(_json.isKeyValue(value))_json.removeNull(value,level+1);else if($.isArray(value)){if(len=value.length,len==0){delete obj[key];return}if(!_json.isKeyValue(value[0])){for(isEmpty=!0,i=0;i<len;i++)if(_str.notEmpty(value[i])){isEmpty=!1;break}isEmpty&&delete obj[key];return}for($.each(value,function(k2,v2){_json.removeNull(v2,level+1);_json.isEmpty(v2)&&(v2=null)}),isEmpty=!0,i=len-1;i>=0;i--)_json.isEmpty(value[i])?isEmpty?delete value[i]:value[i]=null:isEmpty=!1;isEmpty&&delete obj[key]}});_json.isEmpty(obj)&&(obj=null)}},_jwt={jsonAddJwtHeader:function(json){_fun.jwtToken&&(json.headers=_jwt.getJwtAuth())},getJwtAuth:function(){return{Authorization:_jwt.getJwtBearer()}},getJwtBearer:function(){return"Bearer "+_fun.jwtToken}},_leftmenu={init:function(){_leftmenu.menu=$(".xg-leftmenu");$(".xg-toggle").click(function(e){var me,arrow,clsName;e.preventDefault();me=$(this);me.next().collapse("toggle");arrow=me.find(".xg-arrow");clsName="xg-open";arrow.hasClass(clsName)?arrow.removeClass(clsName):arrow.addClass(clsName)})},onToggleMenu:function(){_leftmenu.menu.toggleClass("xg-close")}},_locale={},_log={_start:0,_now:0,info:function(msg){console.log(msg)},error:function(msg){alert(msg)},logTimeInit:function(name){_start=new Date;_now=_start;name&&console.log(name)},logTime:function(name){var now=new Date,msg=name+":"+(now-_now)+"/"+(now-_start);console.log(msg);_now=new Date}},_modal={show:function(id){$("#"+id).modal("show")},hide:function(id){$("#"+id).modal("hide")},showO:function(obj){obj.modal("show")},hideO:function(obj){obj.modal("hide")},showF:function(filter){$(filter).modal("show")},hideF:function(filter){$(filter).modal("hide")}},_nav={moveLeft:function(obj){obj.insertBefore(obj.prev())},moveRight:function(obj){obj.insertAfter(obj.next())}},_num={isBigZero:function(value,zero){return isNaN(value)?!1:zero||value!=="0"&&value!==0?parseInt(value)<0?!1:!0:!1},isNum:function(value){return!isNaN(value)},toBool:function(value){return value===1},rowToBool:function(row,fids){for(var fid,i=0;i<fids.length;i++)fid=fids[i],row[fid]=_num.toBool(row[fid]);return row},addComma:function(str){str+="";x=str.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";for(var rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1,$2");return x1+x2}},_obj={get:function(fid,box){return _obj.getF(_input.fidFilter(fid),box)},getF:function(ft,box){var obj=box.find(ft);return obj.length==0?null:obj},getN:function(name,box){return _obj.getF("[name="+name+"]",box)},getV:function(val,box){return _obj.getF("[value="+val+"]",box)},getById:function(id,box){return _obj.getF("#"+id,box)},getId:function(obj){return obj.length>0?obj.attr("id"):""},getName:function(obj){return obj.length>0?obj.attr("name"):""},isShow:function(obj){return obj.is(":visible")},isExist:function(obj){return obj!==undefined&&obj!==null&&obj.length>0},hasAttr:function(obj){return obj.attr(attr)}},_pjax={init:function(boxFt){var docu=$(document);docu.pjax("[data-pjax]",boxFt,{type:"POST"});docu.on("pjax:success",function(event,data,status,xhr,opts){var json=_str.toJson(data),errMsg;json!=null&&(errMsg=_ajax.resultToErrMsg(json),errMsg&&$(opts.container).html(errMsg))});docu.on("pjax:error",function(event,xhr,textStatus,errorThrown,opts){return opts.success(xhr.responseText,textStatus,xhr),!1})}},_prog={me:null,oriPath:"",init:function(){_prog.me=$(".xg-prog-path");_prog.oriPath=_prog.me.text()},resetPath:function(){_prog.me.text(_prog.oriPath)},setPath:function(fun,updName){var name=fun==_fun.FunC?_BR.Create:fun==_fun.FunV?_BR.View:fun!=_fun.FunU?"??":_str.isEmpty(updName)?_BR.Update:updName;_prog.setFunName(name)},setFunName:function(name){_prog.me.text(_prog.oriPath+"-"+name)}},_qrcode={set:function(id,box,url,width){return _qrcode.setO(_obj.getById(id,box),url,width)},setO:function(obj,url,width){return width=width||128,new QRCode(obj[0],{text:url,width:width,height:width,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}},_str={colSep:"@@",isEmpty:function(str){return str===undefined||str===null||str===""},notEmpty:function(str){return!_str.isEmpty(str)},emptyToStr:function(str,newStr){return _str.isEmpty(str)?newStr:str},format:function(){for(var reg,str=arguments[0],i=0;i<arguments.length-1;i++)reg=new RegExp("\\{"+i+"\\}","gm"),str=str.replace(reg,arguments[i+1]);return str},getMid:function(str,find1,find2){var pos,pos2;return _str.isEmpty(str)?"":(pos=str.indexOf(find1),pos<0)?str:(pos2=str.indexOf(find2,pos+1),pos2<0?str.substring(pos+find1.length):str.substring(pos+find1.length,pos2))},getTail:function(value,find){var pos=value.lastIndexOf(find);return pos>0?value.substring(pos+1):value},toBool:function(val){return val=="1"||val==!0||val=="True"},colsToStr:function(){for(var str=arguments[0],i=1;i<arguments.length;i++)str+=_str.colSep+arguments[i];return str},trim:function(str){return $.trim(str)},toJson:function(str){try{return JSON.parse(str)}catch(error){return null}},replaceAll:function(str,oldStr,newStr){const oldStr2=oldStr.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),regex=new RegExp(oldStr2,"g");return str.replace(regex,newStr)}},_switch={getText:function(yes,no,width,status,inline,fid,cls){var inline2=inline?" xg-inline":"",attr=fid?' id="'+fid+'"':"",html;return status&&(attr+=" checked"),cls=cls?" "+cls:"",html='<label class="switch{5}" style="width:{2}px;"><input{3} class="switch-input{4}" type="checkbox" /><span class="switch-label" data-on="{0}" data-off="{1}"><\/span><span class="switch-handle"><\/span><\/label>',_str.format(html,yes,no,width,attr,cls,inline2)}},_tab={moveLeft:function(obj){obj.insertBefore(obj.prev())},moveRight:function(obj){obj.insertAfter(obj.next())}},_table={rowMoveUp:function(btn){var row=$(btn).closest("tr");row.insertBefore(row.prev())},rowMoveDown:function(btn){var row=$(btn).closest("tr");row.insertAfter(row.next())},getRowCount:function(table,fid){return table.find(_input.fidFilter(fid)).length}},_temp={},_time={sleepA:async function(ms){return new Promise(a=>setTimeout(a,ms))}},_tool={init:function(){_tool.xgAlert=$(".xg-alert");_tool.xgMsg=$("#xgMsg");_tool.xgAns=$("#xgAns");_tool.xgArea=$("#xg-area");_tool.xgImage=$("#xg-image")},msg:function(msg,fnClose){var box=_tool.xgMsg;box.find(".xd-msg").html(msg);_modal.showO(box);_tool._fnOnMsgClose=fnClose},ans:function(msg,fnYes,fnNo){var box=_tool.xgAns;box.find(".xd-msg").html(msg);_modal.showO(box);_tool._fnOnAnsYes=fnYes;_tool._fnOnAnsNo=fnNo===undefined?null:fnNo},alert:function(msg){var box=_tool.xgAlert;box.find(".xd-msg").text(msg);box.fadeIn(500,function(){box.show();setTimeout(function(){_tool.onAlertClose()},5e3)})},showWait:function(){$(".xg-wait").show()},hideWait:function(){$(".xg-wait").hide()},showArea:function(title,value,isEdit,fnOk){var box=_tool.xgArea,obj;box.find(".modal-title").text(title);obj=box.find("textarea");obj.val(value);_itextarea.setEditO(obj,isEdit);_btn.setEditO(box.find(".xd-yes"),isEdit);isEdit&&(_tool._fnOnAreaYes=fnOk);_modal.showO(box)},onAreaYes:function(){var box=_tool.xgArea,value;_tool._fnOnAreaYes&&(_modal.hideO(box),value=box.find("textarea").val(),_tool._fnOnAreaYes(value))},showImage:function(fileName,imageSrc){var box=_tool.xgImage;box.find("img").attr("src",imageSrc);box.find("label").text(fileName);_modal.showO(box)},onAlertClose:function(){var box=_tool.xgAlert;box.fadeOut(500,function(){box.hide()})},onAnsYes:function(){_tool._fnOnAnsYes&&(_modal.hideO(_tool.xgAns),_tool._fnOnAnsYes())},onAnsNo:function(){_tool._fnOnAnsNo&&_tool._fnOnAnsNo();_modal.hideO(_tool.xgAns)},onMsgClose:function(){_tool._fnOnMsgClose&&_tool._fnOnMsgClose();_modal.hideO(_tool.xgMsg)}},_valid={init:function(form){form.removeData("validator");var config={ignore:":hidden:not(.xd-valid), .note-editable.panel-body",errorElement:"span",errorPlacement:function(error,elm){return error.insertAfter(_valid._getBox($(elm))),!1},highlight:function(elm,errorClass,validClass){var me=$(elm),box=_valid._getBox(me),errObj;return box.removeClass(validClass).addClass(errorClass),errObj=_valid._getError(me),errObj!=null&&errObj.show(),!1},unhighlight:function(elm,errorClass,validClass){var me=$(elm),box=_valid._getBox(me),errObj;return box.removeClass(errorClass).addClass(validClass),errObj=_valid._getError(me),errObj!=null&&errObj.hide(),!1}};return form.validate(config)},showError:function(fid,msg,eformId){var eform=_str.isEmpty(eformId)?_me.eform0:$("#"+eformId);eform.validator.showErrors({[fid]:msg})},_getBox:function(obj){return obj.closest(".xi-box")},_getError:function(obj){var error=_valid._getBox(obj).next();return error.length==1&&error.hasClass("error")&&error.is("span")?error:null}},_var={emptyToValue:function(var1,value){return _str.isEmpty(var1)?value:var1},isEmpty:function(var1){return var1===undefined||var1===null},notEmpty:function(var1){return!_var.isEmpty(var1)},isPureData:function(value){return typeof value!="object"&&!Array.isArray(value)}},_flow={TypeStart:"S",TypeEnd:"E",TypeNode:"N"},_openUser={init:function(fn,boxId){boxId=boxId||"ou";var filter="#_"+boxId,box=$(filter),ou={boxId:boxId,filter:filter,fn:fn,isRows:_iText.get("_IsRows",box)==1},config={filter:!0,columns:[{data:"_Fun"},{data:"Account"},{data:"Name"},],columnDefs:[_me.crudR.dtProp,{targets:[0],render:function(data,type,full){var value=_str.colsToStr(full.Id,full.Name,full.Account);return ou.isRows?_me.crudR.dtCheck0(value):_me.crudR.dtRadio1(value)}},]},table=ou.filter+" #_Table";return ou.dt=_datatable.init(table,"../OpenUser/GetPage",config),ou},show:function(ou){_iCheck.setF(ou.filter+" #_Table",!1);_modal.showF(ou.filter)},onClickFind:function(ou){var box=$(ou.filter);_datatable.find(ou.dt,null,_iText.get("Name",box))},onClickOk:function(ou){var box=$(ou.filter),keys,value;ou.isRows?(keys=_iCheck.getCheckeds(box,_icheck.Check0Id),keys.length==0?_tool.msg("請先選取資料。"):(ou.fn(keys),_modal.hideO(box))):(value=_iRadio.get(_iCheck.Check1Id,box),value==""?_tool.msg("請先選取資料。"):(ou.fn(value),_modal.hideO(box)))}},_xp={};