function Datatable(selector,url,dtConfig,findJson,fnOk,tbarHtml){this.dt=null;this.findJson=findJson;this.recordsFiltered=-1;this.defaultShowOk=!0;this._keepStart=!1;this._start=0;this._nowShowOk=this.defaultShowOk;this.resetCount=function(){this.recordsFiltered=-1};this.find=function(findJson){this.findJson=findJson;this.resetCount();this.dt.search("").draw(!this._keepStart)};this.reload=function(){this._keepStart=!0;this._nowShowOk=!1;this.find(this.findJson)};this.init=function(selector,url,dtConfig,fnOk,tbarHtml){var config={processing:!1,serverSide:!0,jQueryUI:!1,filter:!1,paginate:!0,lengthChange:!0,info:!0,sorting:[],pagingType:"full_numbers",language:{url:"/locale/"+_fun.locale+"/dataTables.txt"},dom:_crudR.dtDom,initComplete:function(){var filter,api;tbarHtml&&$(this).closest(".dataTables_wrapper").find("div.toolbar").html(tbarHtml);filter=$(selector+"_filter input");filter.length>0&&(filter.unbind(),api=this.api(),filter.bind("keyup",function(e){e.keyCode===13&&(this.resetCount(),api.search(this.value).draw())}))}.bind(this),ajax:{url:url,type:"POST",dataType:"json",data:function(arg){var orders=arg.order,order;orders.length>0&&(order=orders[0],order.fid=arg.columns[order.column].data);arg.findJson=_json.toStr(this.findJson);arg.recordsFiltered=this.recordsFiltered;this._keepStart&&(arg.start=this._start)}.bind(this),dataSrc:function(result){this._start=this.dt.page.info().start;this._keepStart=!1;var msg=_ajax.resultToMsg(result);return msg?(_tool.msg(msg),result.recordsFiltered=0,this.recordsFiltered=0,[]):(this.recordsFiltered=result.recordsFiltered,fnOk?fnOk(result):result.data===null||result.data.length===0?(_tool.alert(_BR.FindNone,"R"),[]):(this._nowShowOk&&_tool.alert(_BR.FindOk),this._nowShowOk=this.defaultShowOk,result.data))}.bind(this),error:function(xhr,ajaxOptions,thrownError){_tool.hideWait();_tool.msg("Datatable.js error.");xhr!=null&&(console.log("status"+xhr.status),console.log(thrownError))}}},colDefs,dt;dtConfig&&(_var.isEmpty(dtConfig.columnDefs)||(colDefs=dtConfig.columnDefs,colDefs[colDefs.length]=_crudR.dtColDef),config=_json.copy(dtConfig,config));dt=$(selector);dt.on("preXhr.dt",function(){_fun.block()});dt.on("xhr.dt",function(){_fun.unBlock()});this.dt=dt.DataTable(config)};this.init(selector,url,dtConfig,fnOk,tbarHtml)}function EditMany(kid,eformId,tplRowId,rowFilter,sortFid){this.init=function(){if(this.DataFkeyFid="_fkeyfid",this.kid=kid,this.hasRowFilter=!_str.isEmpty(rowFilter),this.rowFilter=rowFilter,this.sortFid=sortFid,this.systemError="",this.hasTplRow=!_str.isEmpty(tplRowId),this.hasTplRow){this.tplRow=$("#"+tplRowId).html();var rowObj=$(this.tplRow);_obj.get(kid,rowObj)==null&&(this.systemError="EditMany.js input kid is wrong ("+kid+")",alert(this.systemError));_edit.setFidTypeVars(this,rowObj);_edit.setFileVars(this,rowObj)}this.hasEform=!_str.isEmpty(eformId);this.hasEform&&(this.eform=$("#"+eformId),this.rowsBox=this.eform.find("tbody"));this.deletedRows=[];this.newIndex=0};this.isNewRow=function(row){return _edit.isNewKey(row[this.kid])};this.reset=function(rowsBox){rowsBox=this.getRowsBox(rowsBox);rowsBox!=null&&rowsBox.empty();this.newIndex=0;this.resetDeleted()};this.resetDeleted=function(){this.deletedRows=[]};this.loadJson=function(json){if(this.hasEform){var rows=json==null||json[_crudE.Rows]==null?null:json[_crudE.Rows];this.loadRows(this.rowsBox,rows)}else this.fnLoadJson(json)};this.urmLoadJson=function(json,rowsBox,fids){var objs=rowsBox.find(":checkbox"),rows,i,row,obj;if(_icheck.setO(objs,0),objs.data("key",""),rows=_crudE.getJsonRows(json),rows!=null)for(i=0;i<rows.length;i++)row=rows[i],obj=rowsBox.find(_fun.fidFilter(row[fids[1]])),_icheck.setO(obj,1),obj.data("key",row[fids[0]])};this.urmGetUpdJson=function(upKey,rowsBox,fids){var json={},rows=[],me=this,newIdx=0;return this.resetDeleted(),rowsBox.find(":checkbox").each(function(){var obj=$(this),key=obj.data("key"),row;_str.isEmpty(key)?_icheck.checkedO(obj)&&(row={},row[fids[0]]=++newIdx,row[fids[1]]=_icheck.getO(obj),me.rowSetFkey(row,upKey),rows[rows.length]=row):_icheck.checkedO(obj)||me.deleteRow(key)}),rows.length>0&&(json[_crudE.Rows]=rows),json[_crudE.Deletes]=this.getDeletedStr(),json};this.singleFormLoadRow=function(rowBox,row,index){var form,i,obj;if(this.checkTplRow()){for(form=$(Mustache.render(this.tplRow,{Index:index})),_form.loadJson(form,row),i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],obj=_obj.get(fid,form),obj.data(_edit.DataOld,row[fid]);rowBox.append(form)}};this.loadRows=function(rowsBox,rows,reset){var rowLen,i,row,box,j,obj2;if(this.checkTplRow()&&(reset===undefined&&(reset=!0),reset&&this.reset(rowsBox),rowLen=rows==null?0:rows.length,rowLen!==0))for(i=0;i<rowLen;i++){for(row=rows[i],box=$(Mustache.render(this.tplRow,row)),j=0;j<this.fidTypeLen;j=j+2)fid=this.fidTypes[j],obj2=_obj.get(fid,box),_edit.setOld(obj2,row[fid]);_form.loadJson(box,row);box.appendTo(rowsBox)}};this.valid=function(){return this.hasEform?this.eform.validTable(this.validator):this.fnValid==null?!0:this.fnValid()};this.getKey=function(box){return _input.get(this.kid,box)};this.getRow=function(trObj){for(var row={},i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],obj=_obj.get(fid,trObj),row[fid]=_input.getO(obj,trObj,this.fidTypes[i+1]);return row};this.checkRowFilter=function(){return this.hasRowFilter?!0:(_log.error("EditMany.js this.rowFilter is empty."),!1)};this.checkTplRow=function(){return this.hasTplRow?!0:(_log.error("EditMany.js this.tplRow is empty."),!1)};this.elmToRowBox=function(elm){return this.checkRowFilter()?$(elm).closest(this.rowFilter):null};this.getUpdJsonByCrud=function(upKey){return this.hasEform?this.getUpdJson(upKey,this.rowsBox):this.fnGetUpdJson(upKey)};this.getUpdJson=function(upKey,rowsBox){rowsBox=this.getRowsBox(rowsBox);var json={};return json[_crudE.Rows]=this.getUpdRows(upKey,rowsBox),json[_crudE.Deletes]=this.getDeletedStr(),json};this.getUpdRows=function(upKey,rowsBox){if(this.checkRowFilter()){rowsBox=this.getRowsBox(rowsBox);this.setSort(rowsBox);var rows=[],me=this;return rowsBox.find(me.rowFilter).each(function(idx,item){var tr=$(item),key=_input.get(me.kid,tr),row2,diffRow,diff,fid,ftype,value,obj,j;if(_edit.isNewKey(key)){row2=me.getRow(tr);row2[me.DataFkeyFid]=upKey;rows.push(row2);return}for(diffRow={},diff=!1,j=0;j<me.fidTypes.length;j=j+2)(ftype=me.fidTypes[j+1],ftype!=="read")&&(fid=me.fidTypes[j],obj=_obj.get(fid,tr),value=_input.getO(obj,tr,ftype),value!=_edit.getOld(obj)&&(diffRow[fid]=value,diff=!0));diff&&(diffRow[kid]=key,rows.push(diffRow))}),rows.length===0?null:rows}};this.getDeletedStr=function(){return this.deletedRows.length===0?null:this.deletedRows.join()};this.onAddRow=function(){this.addRow()};this.addRow=function(rowsBox,row){row=row||{};rowsBox=this.getRowsBox(rowsBox);var obj=this._renderRow(rowsBox,row);return this.boxSetNewId(obj),obj};this.onDeleteRow=function(btn){var box=this.elmToRowBox(btn);this.deleteRow(_itext.get(this.kid,box),box)};this.deleteRow=function(key,rowBox){for(var deletes=this.deletedRows,found=!1,rowLen=deletes.length,i=0;i<rowLen;i++)if(deletes[i][this.kid]===key){found=!0;break}found||(deletes[rowLen]=key);_obj.isExist(rowBox)&&rowBox.remove()};this.onViewFile=function(table,fid,elm){var key=this.getKey(this.elmToRowBox(elm));_edit.viewFile(table,fid,elm,key)};this._renderRow=function(rowsBox,row){if(!this.checkTplRow())return null;rowsBox=this.getRowsBox(rowsBox);var obj=$(Mustache.render(this.tplRow,row));return _form.loadJson(obj,row),obj.appendTo(rowsBox),obj};this.dataAddFiles=function(levelStr,data,rowsBox){if(!this.hasFile||!this.checkRowFilter())return null;rowsBox=this.getRowsBox(rowsBox);var me=this,fileJson={},fileIdx={};return rowsBox.find(me.rowFilter).each(function(index,item){for(var fid,serverFid,tr=$(item),i=0;i<me.fileLen;i++)fid=me.fileFids[i],serverFid=_edit.getServerFid(levelStr,fid),_ifile.dataAddFile(data,fid,serverFid,tr)&&(fileIdx[fid]=fileIdx[fid]==null?0:fileIdx[fid]+1,fileJson[serverFid+fileIdx[fid]]=me.getKey(tr))}),fileJson};this.rowSetFkey=function(row,fkey){row!=null&&this.isNewRow(row)&&(row[this.DataFkeyFid]=fkey)};this.rowsSetFkey=function(rows,fkey){var i,row;if(rows!=null)for(i=0;i<rows.length;i++)row=rows[i],row!=null&&this.isNewRow(row)&&(row[this.DataFkeyFid]=fkey)};this.boxSetNewId=function(box){return this.newIndex++,_itext.set(this.kid,this.newIndex,box),this.newIndex};this.setSort=function(rowsBox){var sortFid=this.sortFid,me;_str.isEmpty(sortFid)||(me=this,rowsBox=this.getRowsBox(rowsBox),rowsBox.find(_fun.fidFilter(sortFid)).each(function(i,item){_itext.set(sortFid,i,$(item).closest(me.rowFilter))}))};this.getRowsBox=function(rowsBox){return rowsBox||this.rowsBox};this.init()}function EditOne(kid,eformId){this.init=function(){this.kid=kid||"Id";eformId=eformId||"eform";this.eform=$("#"+eformId);this.systemError="";var error=this.eform.length!=1?"EditOne.js input eformId is wrong. ("+eformId+")":_obj.get(this.kid,this.eform)==null?"EditOne.js input kid is wrong. ("+this.kid+")":"";error!=""&&(this.systemError=error,alert(error));_edit.setFidTypeVars(this,this.eform);_edit.setFileVars(this,this.eform)};this.getKey=function(){return _input.get(this.kid,this.eform)};this.getValue=function(fid){return _input.get(fid,this.eform)};this.isNewRow=function(){return _str.isEmpty(this.getKey())};this.loadRow=function(row){var i,obj;for(_form.loadJson(this.eform,row),i=0;i<this.fidTypeLen;i=i+2)fid=this.fidTypes[i],obj=_obj.get(fid,this.eform),obj.data(_edit.DataOld,row[fid])};this.getUpdRow=function(){return _edit.getUpdRow(this.kid,this.fidTypes,this.eform)};this.reset=function(){_form.reset(this.eform)};this.setEdit=function(status){_form.setEdit(this.eform,status)};this.dataAddFiles=function(levelStr,data){var fileJson,i,fid,serverFid;if(!this.hasFile)return null;for(fileJson={},i=0;i<this.fileLen;i++)fid=this.fileFids[i],serverFid=_edit.getServerFid(levelStr,fid),_ifile.dataAddFile(data,fid,serverFid,this.eform)&&(fileJson[serverFid]=this.getKey());return fileJson};this.onViewFile=function(table,fid,elm){var key=this.getKey();_edit.viewFile(table,fid,elm,key)};this.init()}function Flow(boxId,mNode,mLine){this.init=function(){var condOpMaps,j,i,plumb;for(this.StartNode="S",this.EndNode="E",this.NormalNode="N",this.OrSep="{O}",this.AndSep="{A}",this.ColSep=",",this.NodeFilter=".xf-node",this.MenuFilter=".xf-menu",this.EpFilter=".xf-ep",this.StartNodeCls="xf-start-node",this.EndNodeCls="xf-end-node",this.InitLineCfg={stroke:"blue",strokeWidth:2},this.OkLineCfg={stroke:"green",strokeWidth:2},this.DenyLineCfg={stroke:"red",strokeWidth:2},this.StartNodeCfg={filter:this.EpFilter,anchor:["Bottom","Left","Right"],connectorStyle:{stroke:"#5c96bc",strokeWidth:2,outlineStroke:"transparent",outlineWidth:3},connectionType:"basic",extract:{action:"the-action"},maxConnections:10},this.EndNodeCfg={dropOptions:{hoverClass:"dragHover"},anchor:["Top","Bottom","Left","Right"],allowLoopback:!0},this.mNode=mNode,this.mLine=mLine,this.divFlowBox=$("#"+boxId),this.divLinesBox=$("#divLinesBox"),this.divLineConds=$("#divLineConds"),this.eformNode=$("#eformNode"),this.eformLine=$("#eformLine"),this.modalNodeProp=$("#modalNodeProp"),this.modalLineProp=$("#modalLineProp"),this.tplNode=$("#tplNode").html(),this.tplLine=$("#tplLine").html(),this.tplLineCond=$("#tplLineCond").html(),this.nowIsNode=!1,this.nowElm=null,condOpMaps=[this.OrSep,") || (",this.AndSep," && ",",EQ,","=",",NEQ,","!=",",GT,",">",",GE,",">=",",ST,","<",",SE,","<=",],this.condOpExprs=[],this.condOpShows=[],j=0,i=0;i<condOpMaps.length;i=i+2)this.condOpExprs[j]=new RegExp(condOpMaps[i],"g"),this.condOpShows[j]=condOpMaps[i+1],j++;plumb=jsPlumb.getInstance({Container:boxId,Connector:"Flowchart",Endpoint:["Dot",{radius:2}],HoverPaintStyle:{stroke:"#1e8151",strokeWidth:3},ConnectionOverlays:[["Arrow",{location:1,id:"arrow",width:8,length:10,foldback:.8}],["Label",{label:"",id:"label",cssClass:"xf-line-label"}]]});plumb.registerConnectionType("basic",{anchor:"Continuous",connector:"Flowchart"});this.plumb=plumb;this._setFlowEvent()};this._setFlowEvent=function(){var plumb=this.plumb,me=this;plumb.bind("contextmenu",function(elm,event){me.showPopupMenu(elm,event,!1)});plumb.bind("beforeDrop",function(info){var conn=info.connection,prop,row;return plumb.getConnections({source:conn.source,target:conn.target}).length>0?!1:(prop=me.getLineProp(""),conn.setPaintStyle(prop.style),me._setLineLabel(conn,prop.label),row={StartNode:me._elmToNodeValue(conn.source,"Id"),EndNode:me._elmToNodeValue(conn.target,"Id"),CondStr:"",Sort:9},me._setLineKey(conn,me.addLine(row)),!0)});$(document).bind("mousedown",function(e){var filter=me.MenuFilter;!$(e.target).parents(filter).length>0&&$(filter).hide(100)})};this._setNodeEvent=function(nodeObj){var nodeType=_itext.get("NodeType",nodeObj),plumb=this.plumb,me=this,nodeElm=nodeObj[0];plumb.draggable(nodeElm,{grid:[10,10],stop:function(params){var pos=$(params.el).position();_form.loadJson(nodeObj,{PosX:Math.floor(pos.left),PosY:Math.floor(pos.top)})}});nodeType!=this.EndNode&&plumb.makeSource(nodeElm,this.StartNodeCfg);nodeType!=this.StartNode&&plumb.makeTarget(nodeElm,this.EndNodeCfg);nodeObj.on("contextmenu",function(event){me.showPopupMenu(event.target,event,!0)})};this.loadNodes=function(json){var box,rows,i,me;for(this.reset(),jsPlumb.setSuspendDrawing(!0),box=this.divFlowBox,rows=_crudE.getJsonRows(json),i=0;i<rows.length;i++)this._setNodeClass(rows[i]);this.mNode.loadRows(box,rows,!1);me=this;box.find(this.NodeFilter).each(function(){me._setNodeEvent($(this))});jsPlumb.setSuspendDrawing(!1,!0)};this.loadLines=function(json){var rows,i;for(jsPlumb.setSuspendDrawing(!0),rows=_crudE.getJsonRows(json),i=0;i<rows.length;i++)this._renderLine(rows[i]);this.mLine.loadRows(this.divLinesBox,rows);jsPlumb.setSuspendDrawing(!1,!0)};this._setNodeClass=function(row){switch(row.NodeType){case this.StartNode:row._NodeClass=this.StartNodeCls;break;case this.EndNode:row._NodeClass=this.EndNodeCls}return row};this.addNode=function(name,nodeType){var row={Name:name,NodeType:nodeType,PosX:100,PosY:100},node=this.mNode.addRow(this.divFlowBox,this._setNodeClass(row));this._setNodeEvent(node)};this._idToNode=function(id){return this.divFlowBox.find(".xf-node [value="+id+"]").closest(".xf-node")};this._elmToNode=function(elm){return $(elm).closest(this.NodeFilter)};this._elmToNodeValue=function(elm,fid){var node=this._elmToNode(elm);return this._boxGetValue(node,fid)};this._boxGetValue=function(node,fid){return _itext.get(fid,node)};this._boxGetValues=function(node,fids){for(var fid,json={},i=0;i<fids.length;i++)fid=fids[i],json[fid]=_itext.get(fid,node);return json};this.deleteNode=function(nodeElm){var plumb=this.plumb,node;this.deleteLines(plumb.getConnections({source:nodeElm}));this.deleteLines(plumb.getConnections({target:nodeElm}));node=$(nodeElm);this.mNode.deleteRow(this._getObjKey(node));$(nodeElm).remove()};this._renderLine=function(row){var prop=this.getLineProp(row.CondStr),conn=this.plumb.connect({source:this._idToNode(row.StartNode),target:this._idToNode(row.EndNode),paintStyle:prop.style});this._setLineKey(conn,row.Id);this._setLineLabel(conn,prop.label)};this.addLine=function(row){var newLine=$(this.tplLine),key;return _form.loadJson(newLine,row),key=this.mLine.boxSetNewId(newLine),this.divLinesBox.append(newLine),key};this._setLineKey=function(conn,key){var row={};row.Id=key;conn.setParameters(row)};this._isSourceCondMode=function(sourceType){return sourceType==this.StartNode};this.getLineProp=function(condStr){return{style:this.InitLineCfg,label:this._condStrToLabel(condStr)}};this._getLineElmKey=function(conn){return conn.getParameters().Id};this._getObjKey=function(obj){return _itext.get("Id",obj)};this._setLineLabel=function(conn,label){var obj=conn.getOverlay("label");obj.setVisible(!_str.isEmpty(label));obj.setLabel(label)};this.deleteLineWithMsg=function(conn){_tool.ans("delete this line ?",function(){this.deleteLine(conn)})};this.deleteLine=function(conn){var json=conn.getParameters();this.mLine.deleteRow(json.Id);this.plumb.deleteConnection(conn)};this.deleteLines=function(conns){for(var i=0;i<conns.length;i++)this.deleteLine(conns[i])};this.reset=function(){for(var box,conns=this.plumb.getAllConnections(),len=conns.length,i=len-1;i>=0;i--)this.plumb.deleteConnection(conns[i]);box=this.divFlowBox;box.find(this.NodeFilter).remove()};this.showPopupMenu=function(elm,event,isNode){event.preventDefault();this.nowIsNode=isNode;this.nowElm=isNode?$(elm).closest(this.NodeFilter)[0]:elm;var canEdit=!0,nodeType;isNode?(nodeType=this._elmToNodeValue(elm,"NodeType"),canEdit=nodeType==this.NormalNode):(nodeType=this._elmToNodeValue(elm.source,"NodeType"),canEdit=nodeType==this.StartNode);$(this.MenuFilter).finish().toggle(100).css({top:event.pageY+"px",left:event.pageX+"px"})};this._condStrToLabel=function(str){var hasOr,i;if(_str.isEmpty(str))return"";for(hasOr=str.indexOf(this.OrSep)>0,i=0;i<this.condOpExprs.length;i++)str=str.replace(this.condOpExprs[i],this.condOpShows[i]);return hasOr&&(str="("+str+")"),str};this._condStrToList=function(str){var i,andList,j,cols;if(_str.isEmpty(str))return null;var list=[],k=0,orList=str.split(this.OrSep),orLen=orList.length,hasOr=orLen>1;for(i=0;i<orLen;i++)for(andList=orList[i].split(this.AndSep),j=0;j<andList.length;j++)cols=andList[j].split(this.ColSep),list[k]={AndOr:hasOr?this.OrSep:this.AndSep,Fid:cols[0],Op:cols[1],Value:cols[2]},k++;return list};this._getLineLabel=function(){var me=this,condStr="";return this.divLineConds.find("tr").each(function(idx){var tr=$(this),str=(idx==0?"":_iselect.get("AndOr",tr))+_itext.get("Fid",tr)+me.ColSep+_iselect.get("Op",tr)+me.ColSep+_itext.get("Value",tr);condStr+=str}),condStr};this.showNodeProp=function(){var node=this._elmToNode(this.nowElm),row=this._boxGetValues(node,["NodeType","Name","SignerType","SignerValue"]);_form.loadJson(this.modalNodeProp,row);_modal.showO(this.modalNodeProp)};this.showLineProp=function(conn){var form=this.eformLine,line=this._connToLine(conn),condList,i,newCond;if(_iread.set("StartNode",this._elmToNodeValue(conn.source,"Name"),form),_iread.set("EndNode",this._elmToNodeValue(conn.target,"Name"),form),_itext.set("Sort",this._boxGetValue(line,"Sort"),form),_modal.showO(this.modalLineProp),this.divLineConds.empty(),condList=this._condStrToList(this._boxGetValue(line,"CondStr")),condList!=null)for(i=0;i<condList.length;i++)newCond=$(this.tplLineCond),_form.loadJson(newCond,condList[i]),this.divLineConds.append(newCond)};this._connToLine=function(conn){return this._idToLine(this._getLineElmKey(conn))};this._idToLine=function(id){return this.divLinesBox.find(".xd-line [value="+id+"]").closest(".xd-line")};this.onAddStartNode=function(){if(this.divFlowBox.find("."+this.StartNodeCls).length>0){_tool.msg("Start Node Already Existed !");return}this.addNode("Start",this.StartNode)};this.onAddEndNode=function(){this.addNode("End",this.EndNode)};this.onAddNormalNode=function(){this.addNode("Node",this.NormalNode)};this.onMenuEdit=function(){this.nowIsNode?this.showNodeProp(this._elmToNodeValue(this.nowElm,"NodeType")):this.showLineProp(this.nowElm)};this.onMenuDelete=function(){var me=this;me.nowIsNode?_tool.ans("delete this node ?",function(){me.deleteNode(me.nowElm)}):_tool.ans("delete this line ?",function(){me.deleteLine(me.nowElm)})};this.onAddLineCond=function(){var row={AndOr:this.AndSep,Op:"eq"},cond=$(Mustache.render(this.tplLineCond,row));_form.loadJson(cond,row);this.divLineConds.append(cond)};this.onDeleteLineCond=function(btn){$(btn).closest("tr").remove()};this.onModalNodeOk=function(){_modal.hideO(this.modalNodeProp);var row=_form.toJson(this.eformNode),nodeObj=$(this.nowElm);nodeObj.find(".xd-name").text(row.Name);_itext.set("Name",row.Name,nodeObj);_itext.set("SignerType",row.SignerType,nodeObj);_itext.set("SignerValue",row.SignerValue,nodeObj)};this.onModalLineOk=function(){var prop;_modal.hideO(this.modalLineProp);var condStr=this._getLineLabel(),conn=this.nowElm,row={CondStr:condStr,Sort:_itext.get("Sort",this.eformLine)},line=this._connToLine(conn);_form.loadJson(line,row);prop=this.getLineProp(condStr);this._setLineLabel(conn,prop.label);conn.setPaintStyle(prop.style)};this.init()}function Page(config){this.pager=config.pager;this.linker=config.linker;this.action=config.action;this.showMenu=config.showMenu||_var.notEmpty(config.pageRowList);this.pageRowList=config.pageRowList||[10,25,50,100];this._init=function(pageStr,onFind){var arg,pager,menu,cols;if(this.pageArg=this._getPageArg(pageStr),arg=this.pageArg,pager=this.pager,arg.filterRows<=0){pager.hide();_tool.msg(_BR.FindNone);return}if(menu="",this.showMenu){cols=_BR.Page.split("@@");menu=cols[0].replace("_Menu",this._getMenuHtml());var start=(arg.pageNo-1)*arg.pageRows+1,end=start+arg.pageRows-1,info=cols[1].replace("_Start",start).replace("_End",end<=arg.filterRows?end:arg.filterRows).replace("_Total",arg.filterRows);menu=_str.format("<div class='xg-page-menu'><label>{0}<span>{1}<\/span><\/label><\/div>",menu,info)}pager.html(menu+"<div class='xg-page-btns'><\/div>");pager.find("select").change(function(){onFind()});pager.find(".xg-page-btns").pagination({currentPage:arg.pageNo,itemsOnPage:arg.pageRows,items:arg.filterRows,listStyle:"pagination "+(this.showMenu?"xg-has-menu":"xg-no-menu"),prevText:"<",nextText:">",onPageClick:onFind})};this._getMenuHtml=function(){for(var menu="<select class='form-select' style='width:80px; display:inline-block'>",i=0;i<this.pageRowList.length;i++)menu+=_str.format("<option value='{0}'{1}>{0}<\/option>",this.pageRowList[i],this.pageArg.pageRows==this.pageRowList[i]?" selected":"");return menu+"<\/select>"};this._getPageArg=function(pageStr){var json=JSON.parse(_html.decode(pageStr));return json.pageNo==null&&(json.pageNo=1),json.pageRows==null&&(json.pageRows=0),json.filterRows==null&&(json.filterRows=-1),json};this.find=function(json,page){var arg,url,key,linker;json=json||{};arg=this.pageArg;_var.isEmpty(page)?(arg.pageNo=1,arg.filterRows=-1,arg.pageRows=this.pager.find("select").val()):arg.pageNo=page;url=this.action+"?page="+arg.pageNo+"&rows="+arg.pageRows+"&filter="+arg.filterRows;for(key in json)_str.notEmpty(json[key])&&(url+="&"+key+"="+json[key]);linker=this.linker;_obj.isExist(linker)?(linker.attr("href",url),linker.trigger("click")):window.location=url};this._init(config.pageStr,config.onFind)}var _ajax={getJson:function(url,data,fnOk,fnError){var json={url:url,type:"POST",data:data,dataType:"json"};_ajax._call(json,fnOk,fnError)},getJson0:function(url,data,fnOk,fnError){_ajax.getJson(url,data,fnOk,fnError,!1)},getJsonByFormData:function(url,data,fnOk,fnError){var json={url:url,type:"POST",cache:!1,data:data,contentType:!1,dataType:"json",processData:!1};_ajax._call(json,fnOk,fnError)},getJsonByFormData0:function(url,data,fnOk,fnError){_ajax.getJsonByFormData(url,data,fnOk,fnError,!1)},getStr:function(url,data,fnOk,fnError){var json={url:url,type:"POST",data:data,dataType:"text"};_ajax._call(json,fnOk,fnError)},getStr0:function(url,data,fnOk,fnError){_ajax.getStr(url,data,fnOk,fnError,!1)},getView:function(url,data,fnOk,fnError){var json={url:url,type:"POST",data:data,dataType:"html"};_ajax._call(json,fnOk,fnError)},getView0:function(url,data,fnOk,fnError){_ajax.getView(url,data,fnOk,fnError,!1)},getImageFile:function(url,data,block){var json={url:url,type:"POST",data:data,dataType:"html"};_ajax._call(json,null,null,block)},getImageFile0:function(url,data){_ajax.getImageFile(url,data,!1)},_call:function(json,fnOk,fnError,block){_var.isEmpty(block)&&(block=!0);var config={success:function(result){var msg=_ajax.resultToMsg(result);msg?fnError==null?_tool.msg(msg):fnError(result):typeof result=="string"&&result.substring(0,2)===_fun.PreBrError?(msg=_ajax.strToMsg(result),fnError==null?_tool.msg(msg):fnError(msg)):fnOk&&fnOk(result)},error:function(xhr,ajaxOptions,thrownError){xhr!=null&&(console.log("status"+xhr.status),console.log(thrownError))},beforeSend:function(){block&&_fun.block()},complete:function(){block&&_fun.unBlock()}};$.ajax(_json.copy(json,config))},resultToMsg:function(result){return result.ErrorMsg?_ajax.strToMsg(result.ErrorMsg):""},strToMsg:function(str){if(_str.isEmpty(str))return"";if(str.substring(0,2)!==_fun.PreBrError)return str;var fid=str.substring(2);return _BR[fid]?_BR[fid]:_str.format("_ajax._call() failed, no BR Fid={0}",fid)}},_array={find:function(ary,id){if(ary==null)return-1;for(var i=0;i<ary.length;i++)if(ary[i]==id)return i;return-1},toStr:function(ary,sep){return sep=sep||",",ary.join(sep)}},_assert={echo:function(msg){_error.log("_assert.js "+msg)},inArray:function(value,ary){var find=!1;for(var item in ary)if(item==value){find=!0;break}find||_assert.echo("inArray failed: "+value)}},_browser={_langCode:"_langCode",pushState:function(url){history.pushState(null,null,url)},zz_print:function(id,fm,fnCallback){_browser.printO(_obj.getById(id,fm,fnCallback))},zz_printO:function(){window.print()}},_btn={setEdit:function(id,status,box){_btn.setEditO(_obj.getById(id,box),status)},setEditO:function(obj,status){obj.prop("disabled",!status)},setEditF:function(ft,status,box){_btn.setEditO(_obj.getF(ft,box),status)}},_chart={_nowChart:null,rainbowColors:["#F32E37","#EABE37","#89E926","#22E352","#2FE5E8","#295AE7","#8828EE","#E629B7",],line:function(canvasId,rows,color){for(var row,ids=[],values=[],i=0;i<rows.length;i++)row=rows[i],ids[i]=row.Id,values[i]=row.Num;_chart.drawLine(canvasId,ids,values,color)},drawLine:function(canvasId,ids,values,color){_chart._nowChart!=null&&_chart._nowChart.destroy();_chart._nowChart=new Chart(document.getElementById(canvasId),{type:"line",data:{labels:ids,datasets:[{data:values,borderColor:color,fill:!1}]},options:{plugins:{legend:{display:!1}}}})},initPie:function(canvasObj,labels,values,colors,config){var config0={type:"pie",options:{legend:{position:"right",labels:{boxWidth:10}}},data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderWidth:1}]}};return config&&(config0=_json.copy(config,config0)),new Chart(canvasObj,config0)}},_crudE={Rows:"_rows",Childs:"_childs",Deletes:"_deletes",init:function(edits){var Childs,edit0,i;if(_me.divEdit=$("#divEdit"),_me.hasEdit=_me.divEdit.length>0,_me.hasEdit){if(Childs=_crudE.Childs,edit0=null,edits==null)edit0=new EditOne;else if(edit0=edits[0]===null?new EditOne:edits[0],edits.length>1)for(edit0[Childs]=[],i=1;i<edits.length;i++)edit0[Childs][i-1]=edits[i];_me.edit0=edit0;_me.hasChild=_fun.hasValue(_me.edit0[Childs])&&_me.edit0[Childs].length>0;_crudE._initForm(_me.edit0)}_me._nowFun="";_me.modal=null},_initForm:function(edit){var childLen,i;if(edit.eform!=null)for(_idate.init(edit.eform),edit.validator=_valid.init(edit.eform),childLen=_crudE._getEditChildLen(edit),i=0;i<childLen;i++)_crudE._initForm(_crudE._getEditChild(edit,i))},getEform0:function(){return _me.edit0.eform},_loadJson:function(json){var edit=_me.edit0,childLen,i,edit2;for(edit.loadRow(json),childLen=_crudE._getEditChildLen(edit),i=0;i<childLen;i++)edit2=_crudE._getEditChild(edit,i),edit2.loadJson(_crudE._getChildJson(json,i))},_afterOpenEdit:function(fun,json){var edit=_me.edit0;_fun.hasValue(edit.fnAfterOpenEdit)&&edit.fnAfterOpenEdit(fun,json)},_setEditStatus:function(fun){var box,items,dataEdit;fun!==_me._nowFun&&(_me._nowFun=fun,box=_me.divEdit,items=box.find("input, textarea, select, button"),fun==_fun.FunV?(items.prop("disabled",!0),box.find("#btnToRead").prop("disabled",!1),_ihtml.setEdits(box,"",!1)):fun==_fun.FunC?(dataEdit="[data-edit=U]",items.prop("disabled",!1),items.filter(dataEdit).prop("disabled",!0),_ihtml.setEdits(box,"",!0),_ihtml.setEdits(box,dataEdit,!1)):fun==_fun.FunU&&(dataEdit="[data-edit=C]",items.prop("disabled",!1),items.filter(dataEdit).prop("disabled",!0),_ihtml.setEdits(box,"",!0),_ihtml.setEdits(box,dataEdit,!1)))},_hasFile:function(){var edit=_me.edit0,childLen,i,edit2;if(edit.hasFile)return!0;for(childLen=_crudE._getEditChildLen(edit),i=0;i<childLen;i++)if(edit2=_crudE._getEditChild(edit,i),edit2.hasFile)return!0;return!1},_getUpdJson:function(formData){var edit0=_me.edit0,row=edit0.getUpdRow(),key=edit0.getKey(),fileJson={},levelStr="0",i,edit2,fileJson2,childJson,data,hasData;edit0.hasFile&&(fileJson=edit0.dataAddFiles(levelStr,formData));var hasChild=!1,childs=[],childLen=_crudE._getEditChildLen(edit0);for(i=0;i<childLen;i++)(edit2=_crudE._getEditChild(edit0,i),edit2.hasFile&&(fileJson2=edit2.dataAddFiles(levelStr+i,formData,edit2.rowsBox),_json.copy(fileJson2,fileJson)),childJson=edit2.getUpdJsonByCrud(key),childJson!=null)&&(hasChild=!0,childs[i]=childJson);return(data={},hasData=!1,row!=null&&(hasData=!0,data[_crudE.Rows]=[row]),hasChild&&(hasData=!0,data[_crudE.Childs]=childs),_json.isEmpty(fileJson)||(hasData=!0,data[_edit.FileJson]=fileJson),!hasData)?null:(_json.removeNull(data),data)},validAll:function(){var edit=_me.edit0,childLen,i,edit2;if(_str.notEmpty(edit.systemError))return _tool.msg(edit.systemError),!1;if(!edit.eform.valid())return!1;for(childLen=_crudE._getEditChildLen(edit),i=0;i<childLen;i++){if(edit2=_crudE._getEditChild(edit,i),_str.notEmpty(edit2.systemError))return _tool.msg(edit2.systemError),!1;if(!edit2.valid())return!1}return!0},_afterSave:function(data){if(_fun.hasValue(_me.edit0.fnAfterSave)&&_me.edit0.fnAfterSave(),data.Value==="0"){_tool.msg(_BR.SaveNone);return}_tool.alert(_BR.SaveOk+"("+data.Value+")");_me.hasRead&&(_me.dt.reload(),_crudR.toReadMode())},_resetForm:function(edit){var childLen,i,edit2;for(edit.reset(),childLen=_crudE._getEditChildLen(edit),i=0;i<childLen;i++)edit2=_crudE._getEditChild(edit,i),edit2.reset()},_isEditMode:function(){return _me._nowFun!==_fun.FunV},_updateOrView:function(fun,key){var act=fun==_fun.FunU?"GetUpdJson":"GetViewJson";_ajax.getJson(act,{key:key},function(data){_crudE._loadJson(data);_crudE._setEditStatus(fun);_crudE._afterOpenEdit(fun,data)})},_getEditChild:function(edit,childIdx){return edit[_crudE.Childs][childIdx]},_getEditChildLen:function(edit){var fid=_crudE.Childs;return edit[fid]==null?0:edit[fid].length},getJsonRows:function(json){return json==null||json[_crudE.Rows]==null?null:json[_crudE.Rows]},_getChildJson:function(upJson,childIdx){var childs=_crudE.Childs;return upJson[childs]==null||upJson[childs].length<=childIdx?null:upJson[childs][childIdx]},getChildRows:function(upJson,childIdx){var child=_crudE._getChildJson(upJson,childIdx);return _crudE.getJsonRows(child)},setChildRows:function(upRow,childIdx,rows){var fid=_crudE.Childs,child;return upRow==null&&(upRow={}),upRow[fid]==null&&(upRow[fid]=[]),upRow[fid].length<=childIdx&&(upRow[fid][childIdx]={}),child=upRow[fid][childIdx],child[_crudE.Rows]=rows,child},onCreate:function(){var fun=_fun.FunC;_crudE._setEditStatus(fun);_crudE._resetForm(_me.edit0);_crudE._afterOpenEdit(fun,null)},onUpdate:function(key){_crudE._updateOrView(_fun.FunU,key)},onView:function(key){_crudE._updateOrView(_fun.FunV,key)},onOpenModal:function(btn,title,fid){var tr=$(btn).closest("tr");_tool.showArea(title,_itext.get(fid,tr),_crudE._isEditMode(),function(result){_itext.set(fid,result,tr)})},onSave:function(){var edit0,error,formData,row;if(!_crudE.validAll()){_tool.alert(_BR.InputWrong);return}if(edit0=_me.edit0,_fun.hasValue(edit0.fnWhenSave)&&(error=edit0.fnWhenSave(),_str.notEmpty(error))){_tool.msg(error);return}if(formData=new FormData,row=_crudE._getUpdJson(formData),_json.isEmpty(row)){_tool.msg(_BR.SaveNone);return}var isNew=edit0.isNewRow(),action=isNew?"Create":"Update",data=null;_crudE._hasFile()?(data=formData,data.append("json",_json.toStr(row)),isNew||data.append("key",edit0.getKey()),_ajax.getJsonByFormData(action,data,function(result){_crudE._afterSave(result)})):(data={json:_json.toStr(row)},isNew||(data.key=edit0.getKey()),_ajax.getJson(action,data,function(result){_crudE._afterSave(result)}))}},_crudR={temp:{},dtDom:'<"toolbar">t<li>p',dtColDef:{className:"xg-center",orderable:!1,targets:"_all"},dtCheck0:function(value,editable){_str.isEmpty(value)&&(value=1);var attr="data-fid='"+_icheck.Check0Id+"' data-value='"+value+"'";return editable===!1&&(attr+=" readonly"),"<label class='xi-check xg-no-label'>   <input "+attr+" type='checkbox'>   <span class='xi-cspan'><\/span><\/label>"},dtRadio1:function(value,editable){return editable===undefined&&(editable=!0),_iradio.render(_icheck.Check0Id,"",!1,value,editable)},dtSetStatus:function(){return""},dtStatusName:function(value){return value=="1"?"<span>"+_BR.StatusYes+"<\/span>":'<span class="text-danger">'+_BR.StatusNo+"<\/span>"},dtYesEmpty:function(value){return value=="1"?_BR.Yes:""},dtCrudFun:function(key,rowName,hasUpdate,hasDelete,hasView,fnOnUpdate,fnOnDelete,fnOnView){var funs="";return hasUpdate&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="{0}(\'{1}\')"><i class="ico-pen" title="{2}"><\/i><\/button>',fnOnUpdate==null?"_crudR.onUpdate":fnOnUpdate,key,_BR.TipUpdate)),hasDelete&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="_crudR.onDelete(\'{1}\',\'{2}\')"><i class="ico-delete" title="{3}"><\/i><\/button>',fnOnDelete==null?"_crudR.onDelete":fnOnDelete,key,rowName,_BR.TipDelete)),hasView&&(funs+=_str.format('<button type="button" class="btn btn-link" onclick="_crudR.onView(\'{1}\')"><i class="ico-eye" title="{2}"><\/i><\/button>',fnOnView==null?"_crudR.onView":fnOnView,key,_BR.TipView)),funs},init:function(dtConfig,edits,updName){_me.divRead=$("#divRead");_me.hasRead=_me.divRead.length>0;_me.hasRead&&(_me.rform=$("#formRead"),_me.rform.length===0&&(_me.rform=null),_me.rform2=$("#formRead2"),_me.rform2.length===0&&(_me.rform2=null),_me.rform!=null&&_idate.init(_me.rform),_me.rform2!=null&&_idate.init(_me.rform2),_me.dt=new Datatable("#tableRead","GetPage",dtConfig));_me._updName=updName;_crudE.init(edits);_prog.init()},_getFindCond:function(){var row=_form.toJson(_me.rform),find2=_me.rform2;return find2!==null&&_obj.isShow(find2)&&_json.copy(_form.toJson(find2),row),row},swap:function(toRead,nowDiv){var isDefault,oldDiv,newDiv;_me.hasRead&&_me.hasEdit&&(isDefault=_var.isEmpty(nowDiv),isDefault&&(nowDiv=_me.divEdit),toRead?(oldDiv=nowDiv,newDiv=_me.divRead):(oldDiv=_me.divRead,newDiv=nowDiv),_obj.isShow(oldDiv)&&(oldDiv.fadeToggle(200),newDiv.fadeToggle(500)),isDefault&&_crudR._afterSwap(toRead))},toEditMode:function(fun){_crudR.swap(!1);_prog.setPath(fun,_me._updName)},toReadMode:function(){_prog.resetPath();_crudR.swap(!0)},_afterSwap:function(toRead){var edit=_me.edit0;_fun.hasValue(edit.fnAfterSwap)&&edit.fnAfterSwap(toRead)},onFind:function(){var cond=_crudR._getFindCond();_me.dt.find(cond)},onFind2:function(){var find2=_me.rform2;find2!=null&&(_obj.isShow(find2)?_form.hideShow([find2]):_form.hideShow(null,[find2]))},onResetFind:function(){_form.reset(_me.rform);_me.rform2!=null&&_form.reset(_me.rform2)},onExport:function(){var find=_crudR._getFindCond();window.location="Export?find="+_json.toStr(find)},onToRead:function(){_crudR.toReadMode()},onCreate:function(){_crudE.onCreate();_crudR.toEditMode(_fun.FunC)},onUpdate:function(key){_crudE.onUpdate(key);_crudR.toEditMode(_fun.FunU)},onView:function(key){_crudE.onView(key);_crudR.toEditMode(_fun.FunV)},onSetStatus:function(me,key){var status=_icheck.checkedO($(me));_ajax.getStr("SetStatus",{key:key,status:status},function(){_tool.alert(_BR.UpdateOk)})},onCheckAll:function(me,box,fid){_icheck.setF(_fun.fidFilter(fid)+":not(:disabled)",_icheck.checkedO($(me)),box)},onDelete:function(key,rowName){_tool.ans(_BR.SureDeleteRow+" ("+rowName+")",function(){_ajax.getJson("Delete",{key:key},function(){_tool.alert(_BR.DeleteOk);_me.dt.reload()})})},onDeleteRows:function(box,fid){var keys=_icheck.getCheckeds(box,fid);if(keys.length===0){_tool.msg(_BR.PlsSelectDeleted);return}_tool.ans(_BR.SureDeleteSelected,function(){_ajax.getStr("DeleteByKeys",{keys:keys},function(){_tool.alert(_BR.DeleteOk);_me.dt.reload()})})}},_date={getStartEnd:function(){},nowYear:function(){return(new Date).getFullYear()},mmToUiDate:function(ds){return _str.isEmpty(ds)?"":moment(ds,_fun.MmDateFmt).format(_BR.MmUiDateFmt)},mmToUiDt:function(dts){return _str.isEmpty(dts)?"":moment(dts,_fun.MmDtFmt).format(_BR.MmUiDtFmt)},mmToUiDt2:function(dts){return _str.isEmpty(dts)?"":moment(dts,_fun.MmDtFmt).format(_BR.MmUiDt2Fmt)},mmToFormat:function(dts,format){return _str.isEmpty(dts)?"":moment(dts,_fun.MmDtFmt).format(format)},mmToValue:function(dts){return _str.isEmpty(dts)?0:moment(dts,_fun.MmDtFmt).valueOf()},mmToMoment:function(dts){return _str.isEmpty(dts)?null:moment(dts,_fun.MmDtFmt)},uiToMmDate:function(ds){return _str.isEmpty(ds)?"":moment(ds,_BR.MmUiDateFmt).format(_fun.MmDateFmt)},tsToUiDt:function(ts){return ts==""?"":moment(parseInt(ts)*1e3).format(_BR.MmUiDtFmt)},getHourStr:function(){},getDt:function(fDate,fTime,box){var date=_idate.get(fDate,box),time=_iselect.get(fTime,box);return date==""?"":time==""?date:date+" "+time},isBig:function(ds1,ds2){return moment(ds1,_fun.MmDtFmt).isAfter(moment(ds2,_fun.MmDtFmt))},getMonthDiff:function(ds1,ds2){return _str.isEmpty(start)||_str.isEmpty(end)?0:_date.getMonthDiffByDate(moment(ds1,_fun.MmDtFmt),moment(ds2,_fun.MmDtFmt))},getMonthDiffByDate:function(dt1,dt2){return(dt2.getFullYear()-dt1.getFullYear())*12+dt2.getMonth()-dt1.getMonth()+1},jsDateAddYear:function(ds,year){return moment(ds,_fun.MmDtFmt).add(year,"y").format(_fun.MmDtFmt)}},_edit={FileJson:"_fileJson",DataOld:"_old",getOld:function(obj){return obj.data(_edit.DataOld)},setOld:function(obj,value){obj.data(_edit.DataOld,value)},getUpdRow:function(kid,fidTypes,box){var row=_form.toJson(box),key=_input.get(kid,box),diff,result,fid,ftype,value,obj,old,j;if(_str.isEmpty(key))return row;for(diff=!1,result={},j=0;j<fidTypes.length;j=j+2)if(ftype=fidTypes[j+1],fid=fidTypes[j],obj=_input.getObj(fid,box,ftype),value=row[fid],old=obj.data(_edit.DataOld),value!=old){if((ftype==="date"||ftype==="dt")&&_date.mmToValue(value)===_date.mmToValue(old))continue;result[fid]=value;diff=!0}return diff?(result[kid]=key,result):null},setFidTypeVars:function(me,box){var fidTypes=[];box.find(_fun.fidFilter()).each(function(i,item){var obj=$(item),j=i*2;fidTypes[j]=_fun.getFid(obj);fidTypes[j+1]=_input.getType(obj)});me.fidTypes=fidTypes;me.fidTypeLen=me.fidTypes.length},setFileVars:function(me,box){me.fileFids=[];box.find("[data-type=file]").each(function(index,item){me.fileFids[index]=_fun.getFid($(item))});me.fileLen=me.fileFids.length;me.hasFile=me.fileFids.length>0},getServerFid:function(levelStr,fid){return"t"+levelStr+"_"+fid},dataSetFileJson:function(data,fileJson){var fid,json;_json.isEmpty(fileJson)||(fid=_edit.FileJson,data.has(fid)&&(json=data.get(fid),fileJson=_json.copy(fileJson,json)),data.set(fid,fileJson))},isNewKey:function(key){var len,val;return(key=key.toString(),len=key.length,len>=6)?!1:(val=parseInt(key),!Number.isNaN(val)&&val.toString().length==len)},viewFile:function(table,fid,elm,key){if(_edit.isNewKey(key)){_tool.msg(_BR.NewFileNotView);return}var ext=_file.getFileExt(elm.innerText);_file.isImageExt(ext)&&_tool.showImage(elm.innerHTML,_str.format("ViewFile?table={0}&fid={1}&key={2}&ext={3}",table,fid,key,ext))}},_error={log:function(msg){console.log(msg)}},_file={getFileName:function(path){var sep=path.indexOf("/")>0?"/":"\\";return _str.getTail(path,sep)},getFileExt:function(path){return _str.getTail(path,".").toLowerCase()},isImageExt:function(ext){return",jpg,jpeg,png,gif,tif,tiff,".indexOf(","+ext+",")>=0}},_form={toJson:function(form){var json={};return form.find(_fun.fidFilter()).filter(":not(.xi-unsave)").each(function(){var obj=$(this);json[_fun.getFid(obj)]=_input.getO(obj,form)}),json},toJsonStr:function(form){return JSON.stringify(_form.toJson(form))},loadJson:function(form,json){for(var key in json)_input.set(key,json[key],form)},reset:function(form){form.find(_fun.fidFilter()).each(function(){_input.setO($(this),"",form)})},hasFile:function(form){return form.find(":file").length>0},setEdit:function(form,status){_itext.setEditO(form.find("input:text"),status);_itextarea.setEditO(form.find("textarea"),status);_idate.setEditO(form.find(".date input"),status);_iselect.setEditO(form.find("select"),status);_icheck.setEditO(form.find(":checkbox"),status);_iradio.setEditO(form.find(":radio"),status);_btn.setEditO(form.find("button"),status)},hideShow:function(hides,shows){var form1,i,form2;if(hides)for(i=0;i<hides.length;i++)form1=hides[i],form1.fadeOut(500,function(){form1.hide()});if(shows)for(i=0;i<shows.length;i++)form2=shows[i],form2.fadeIn(500,function(){form2.show()})}},_formData={},_fun={MmDateFmt:"YYYY/MM/DD",MmDtFmt:"YYYY/MM/DD HH:mm:ss",FunC:"C",FunR:"R",FunU:"U",FunD:"D",FunV:"V",PreBrError:"B:",HideRwd:"xg-hide-rwd",locale:"zh-TW",maxFileSize:50971520,isRwd:!1,onHello:function(){_ajax.getStr("../Fun/Hello",null,function(msg){alert(msg)})},getFid:function(obj){return obj.data("fid")},fidFilter:function(fid){return _str.isEmpty(fid)?"[data-fid]":"[data-fid="+fid+"]"},"default":function(val,defVal){return val==null?defVal:val},hasValue:function(obj){return!(obj==null)},onSetLocale:function(code){_ajax.getStr("../Fun/SetLocale",{code:code},function(){location.reload()})},block:function(){$.blockUI({message:'<table><tr><td style="height:50px">   <i class="spinner ico-spin"><\/i>   <span style="margin-left:3px; vertical-align:middle;">'+_BR.Working+"<\/span><\/td><\/tr><\/table>",css:{padding:"0 30px",borderWidth:"2px",width:"auto",left:"42%"},overlayCSS:{opacity:.3}})},unBlock:function(){$.unblockUI()}},_helper={getBaseProp:function(rowNo,fid,value,type,required,editable,extAttr){var attr=_str.format("type='{0}' data-id='{1}' name='{2}' value='{3}'",type,fid,fid+rowNo,value);return required===!0&&(attr+=" required"),editable===!1&&(attr+=" readonly"),_str.isEmpty(extAttr)||(attr+=" "+extAttr),_str.trim(attr)}},_html={encodeRow:function(row,fields){for(var id,i=0;i<fields.length;i++)id=fields[i],row[id]=_html.encode(row[id]);return row},encode:function(value){return $("<div/>").text(value).html()},decode:function(value){return $("<div/>").html(value).text()},update:function(id,box){var filter="#"+id,obj=box===undefined?$(filter):box.find(filter);obj.summernote("code",obj.text())},updates:function(ids,box){for(var i=0;i<ids.length;i++)_html.update(ids[i],box)}},_ibase={get:function(fid,box){return this.getO(_obj.get(fid,box))},getF:function(ft,box){return this.getO(_obj.getF(ft,box))},getD:function(id,box){return this.getO(_obj.getD(id,box))},getO:function(obj){return obj.val()},getBorder:function(obj){return obj},set:function(fid,value,box){this.setO(_obj.get(fid,box),value)},setF:function(ft,value,box){this.setO(_obj.getF(ft,box),value)},setO:function(obj,value){obj.val(value)},setEdit:function(fid,status,box){this.setEditO(_obj.get(fid,box),status)},setEditF:function(ft,status,box){this.setEditO(_obj.getF(ft,box),status)},setEditO:function(obj,status){obj.prop("readonly",!status)}},_icheck=$.extend({},_ibase,{Check0Id:"_check0",getO:function(obj){return obj.is(":checked")?obj.data("value"):"0"},setO:function(obj,value){var status=!(value==null||value=="0"||value=="False"||value==!1);obj.prop("checked",status)},setEditO:function(obj,status){obj.prop("disabled",!status)},checked:function(fid,form){return _icheck.checkedO(_obj.get(fid,form))},checkedF:function(filter,form){return _icheck.checkedO(_obj.getF(filter,form))},checkedO:function(obj){return obj.is(":checked")},getCheckeds:function(form,fid){fid=fid||_icheck.Check0Id;var ary=[];return _obj.getF(_fun.fidFilter(fid)+":checked",form).each(function(i){ary[i]=$(this).data("value")}),ary}}),_icolor={init:function(){$(".xg-color").colorpicker({})},get:function(fid,form){return _icolor.getO(_obj.get(fid,form))},getF:function(filter,form){return _icolor.getO(_obj.getF(filter,form))},getO:function(obj){return _icolor.rgbToHex(obj.find("i").css("background-color"))},rgbToHex:function(rgb){var parts=rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),i;for(delete parts[0],i=1;i<=3;++i)parts[i]=parseInt(parts[i]).toString(16),parts[i].length==1&&(parts[i]="0"+parts[i]);return"#"+parts.join("")}},_idate=$.extend({},_ibase,{BoxFilter:".date",getO:function(obj){return _date.uiToMmDate(obj.val())},setO:function(obj,value){_idate._boxSetDate(_idate._objToBox(obj),_date.mmToUiDate(value))},setEditO:function(obj,status){obj.prop("disabled",!status)},init:function(box,fid){var obj=_str.isEmpty(fid)?box.find(_idate.BoxFilter):_obj.get(fid,box).closet(_idate.BoxFilter);if(obj.length!=0){obj.datepicker({language:_fun.locale,autoclose:!0,showOnFocus:!1}).on("changeDate",function(){});obj.find(".input-group-addon").off("click")}},onToggle:function(btn){_idate._elmToBox(btn).datepicker("show")},onReset:function(btn){var box=_idate._elmToBox(btn);_idate.getEditO(_idate._boxGetInput(box))&&_idate._boxSetDate(box,"")},getEditO:function(obj){return!obj.is(":disabled")},_elmToBox:function(elm){return _idate._objToBox($(elm))},_objToBox:function(obj){return obj.closest(_idate.BoxFilter)},_boxSetDate:function(box,date){box.datepicker("update",date)},_boxGetInput:function(box){return box.find("input")}}),_idt=$.extend({},_idate,{getO:function(obj){var date=_idate.getO(_idt._boxGetDate(obj));return _str.isEmpty(date)?"":date+" "+_iselect.getO(_idt._boxGetHour(obj))+":"+_iselect.getO(_idt._boxGetMin(obj))},setO:function(obj,value){var date,hour,min;_str.isEmpty(value)?(date="",hour=0,min=0):(date=value,hour=parseInt(_str.getMid(value," ",":")),min=parseInt(_str.getMid(value,":",":")));_idate.setO(_idt._boxGetDate(obj),date);_iselect.setO(_idt._boxGetHour(obj),hour);_iselect.setO(_idt._boxGetMin(obj),min)},setEditO:function(obj,status){_idate.setEditO(_idt._boxGetDate(obj),status);_iselect.setEditO(_idt._boxGetHour(obj),status);_iselect.setEditO(_idt._boxGetMin(obj),status)},_boxGetDate:function(box){return box.find("input:first")},_boxGetHour:function(box){return box.find("select:first")},_boxGetMin:function(box){return box.find("select:last")}}),_ifile=$.extend({},_ibase,{getBorder:function(obj){return obj.prev()},setO:function(obj,value){obj.val(value);_ifile._elmToLink(obj).text(value)},dataAddFile:function(data,fid,serverFid,box){var obj=_obj.get(fid,box),file=_ifile.getUploadFile(_ifile._elmToFile(obj)),hasFile=file!=null;return hasFile&&data.append(serverFid,file),hasFile},onOpenFile:function(btn){var file=_ifile._elmToFile(btn);file.focus().trigger("click")},onChangeFile:function(file){var obj=_ifile._elmToObj(file),fileObj=$(file),value=file.value,exts,ext,max;if(_str.isEmpty(value)){_ifile.setO(obj,"");return}if(exts=fileObj.data("exts").toLowerCase(),!_str.isEmpty(exts)&&exts!=="*"&&(ext=_file.getFileExt(value),exts=","+exts+",",exts.indexOf(","+ext+",")<0)){_tool.msg(_BR.UploadFileNotMatch);file.value="";return}if(max=fileObj.data("max"),file.files[0].size>max*1048576){_tool.msg(_str.format(_BR.UploadFileNotBig,max));file.value="";return}_ifile.setO(obj,_file.getFileName(value))},onDeleteFile:function(btn){_ifile.setO(_ifile._elmToObj(btn),"")},zz_init:function(fid,path,form){var fileObj=_obj.get(fid,form);fileObj.val("")},_elmToBox:function(elm){return $(elm).closest(".xi-box")},_elmToFile:function(elm){return _ifile._boxGetFile(_ifile._elmToBox(elm))},_elmToObj:function(elm){return _ifile._boxGetObj(_ifile._elmToBox(elm))},_elmToLink:function(elm){return _ifile._boxGetLink(_ifile._elmToBox(elm))},_boxGetLink:function(box){return box.find("a")},_boxGetFile:function(box){return box.find(":file")},_boxGetObj:function(box){return box.find("[data-type=file]")},getUploadFile:function(fileObj){if(fileObj.length==0)return null;var files=fileObj.get(0).files;return files.length>0?files[0]:null}}),_ihtml=$.extend({},_ibase,{Filter:"[data-type=html]",getO:function(obj){return obj.summernote("code")},setO:function(obj,value){obj.summernote("code",value)},setEditO:function(obj,status){obj.summernote(status?"enable":"disable")},init:function(edit,prog,height){edit.eform.find(_ihtml.Filter).each(function(){var upMe=$(this);upMe.data("prog",prog);upMe.summernote({height:height||200,callbacks:{onChange:function(contents){var me=$(this);me.summernote("isEmpty")?(me.val(""),me.summernote("code")!=""&&me.summernote("code","")):me.val(contents);edit.validator.element(me)},onImageUpload:function(files){var me=$(this),data=new FormData;data.append("file",files[0]);$.ajax({data:data,type:"POST",url:"SetHtmlImage",cache:!1,contentType:!1,processData:!1,success:function(url){var image=document.createElement("img");image.src=url;me.summernote("insertNode",image)}})}}})})},setEdits:function(box,subFilter,status){var items=box.find(_ihtml.Filter+subFilter);items.length>0&&items.summernote(status?"enable":"disable")}}),_ilink={get:function(fid,form){return this.getO(_obj.get(fid,form))},getO:function(obj){return obj.text()},set:function(fid,value,form){this.setO(_obj.get(fid,form),value)},setO:function(obj,value){obj.text(value)}},_input={get:function(fid,box){return _input.getO(_obj.get(fid,box),box)},getO:function(obj,box,type){type=type||_input.getType(obj);switch(type){case"text":return _itext.getO(obj);case"textarea":return _itextarea.getO(obj);case"check":return _icheck.getO(obj);case"radio":return _iradio.getO(obj,box);case"select":return _iselect.getO(obj);case"date":return _idate.getO(obj);case"dt":return _idt.getO(obj);case"file":return _ifile.getO(obj);case"html":return _ihtml.getO(obj);case"read":return _iread.getO(obj);case"link":return _ilink.getO(obj);default:return obj.val()}},set:function(fid,value,box){_input.setO(_obj.get(fid,box),value,box)},setO:function(obj,value,box,type){if(obj!=null&&_var.isPureData(value)){type=type||_input.getType(obj);switch(type){case"text":_itext.setO(obj,value);break;case"check":_icheck.setO(obj,value);break;case"radio":value=value||"0";_iradio.setO(obj,value,box);break;case"select":_iselect.setO(obj,value);break;case"date":return _idate.setO(obj,value);case"dt":return _idt.setO(obj,value);case"file":_ifile.setO(obj,value);break;case"textarea":_itextarea.setO(obj,value);break;case"html":_ihtml.setO(obj,value);break;case"read":var format=obj.data("format");_str.notEmpty(format)&&_str.notEmpty(_BR[format])&&(value=_date.mmToFormat(value,_BR[format]));_iread.setO(obj,value);break;case"link":return _ilink.setO(obj,value);default:obj.val(value)}}},getType:function(obj){return obj.data("type")},getObj:function(fid,box,ftype){return ftype=ftype||_input.getType(_obj.get(fid,box)),ftype==="radio"?_iradio.getObj(fid,box):_obj.get(fid,box)}},_iradio=$.extend({},_ibase,{get:function(fid,box){return _iradio._getByName(fid,box)},getO:function(obj,box){return _iradio._getByName(_obj.getName(obj),box)},getObj:function(fid,box){return _obj.getF("[name="+fid+"]:checked",box)},_getByName:function(name,box){return _iradio.getObj(name,box).data("value")},set:function(fid,value,box){_iradio._setByName(fid,value,box)},setO:function(obj,value,box){_iradio._setByName(_obj.getName(obj),value,box)},_setByName:function(name,value,box){var obj=_obj.getF("[name="+name+"][data-value="+value+"]",box);obj.prop("checked",!0)},setEdit:function(fid,status,box){_iradio.setEditOs(_obj.get(fid,box))},setEditOs:function(objs,status){objs.attr("disabled",!status)},render:function(fid,label,checked,value,editable,extClass,extProp){return label=label||"",extClass=extClass||"",extProp=extProp||"",value=value||"",label==""&&(label="&nbsp;"),_str.isEmpty(value)&&(value=1),extProp+=" data-id='"+fid+"' name='"+fid+"' value='"+value+"'",checked&&(extProp+=" checked"),editable===undefined||editable||(extProp+=" disabled"),_str.format("<label class='xi-check {0}'>   <input type='radio'{1}>{2}   <span class='xi-rspan'><\/span><\/label>",extClass,extProp,label)}}),_iread={get:function(fid,form){return _iread.getO(_obj.get(fid,form))},getF:function(filter,form){return _iread.getO(_obj.getF(filter,form))},getO:function(obj){return obj.text()},set:function(fid,value,form){_iread.setO(_obj.get(fid,form),value)},setF:function(filter,value,form){_iread.setO(_obj.getF(filter,form),value)},setO:function(obj,value){obj.text(value)}},_iselect=$.extend({},_ibase,{getO:function(obj){return obj.length===0?"":obj.find("option:selected").val()},setO:function(obj,value){filter='option[value="'+value+'"]';var item=obj.find(filter);return item.length>0?(item.prop("selected",!0),item):(obj.find("option:selected").prop("selected",!1),null)},setEditO:function(obj,status){obj.prop("disabled",!status)},getIndex:function(fid,box){return _iselect.getIndexO(_obj.get(fid,box))},getIndexO:function(obj){return obj.prop("selectedIndex")},getCount:function(fid,box){return _iselect.getCountO(_obj.get(fid,box))},getCountO:function(obj){return obj.find("option").length},setIndex:function(fid,idx,box){_iselect.setIndexO(_obj.get(fid,box),idx)},setIndexO:function(obj,idx){obj.find("option").eq(idx).prop("selected",!0)},getText:function(fid,box){var obj=_obj.get(fid,box);return _iselect.getTextO(obj)},getTextO:function(obj){return obj.find("option:selected").text()},getData:function(fid,name,box){return _obj.get(fid,box).find("option:selected").data(name)},getDataO:function(obj,name){return obj.find("option:selected").data(name)},setItems:function(fid,items,box){var obj=_obj.get(fid,box);_iselect.setItemsO(obj,items)},setItemsF:function(filter,items,box){var obj=_obj.getF(filter,box);_iselect.setItemsO(obj,items)},setItemsO:function(obj,items){if(obj.find("option").remove(),items!==null)for(var i=0;i<items.length;i++)obj.append($("<option><\/option>").attr("value",items[i].Id).text(items[i].Str))},getExts:function(fid,box){var rows=[];return _obj.get(fid,box).find("option").each(function(i){var me=$(this);rows[i]={Id:me.val(),Str:me.text(),Ext:me.data("ext")}}),rows},setExts:function(fid,items,box){var filter="#"+fid,obj=box?box.find(filter):$(filter),i;if(obj.find("option").remove(),items!=null)for(i=0;i<items.length;i++)obj.append(_str.format("<option data-ext='{0}' value='{1}'>{2}<\/option>",items[i].Ext,items[i].Id,items[i].Str))},valuesToJson:function(json,fids,box){for(var i=0;i<fids.length;i++)json[fids[i]]=_iselect.get(fids[i],box);return json},filterByExt:function(fid,value,rows,box,allItem){var obj,len,i,row;for(allItem===undefined&&(allItem=!1),obj=_obj.get(fid,box),obj.empty(),len=rows.length,i=0;i<len;i++)row=rows[i],(allItem===!0&&row.Ext==""||row.Ext==value)&&obj.append(_str.format('<option value="{0}">{1}<\/option>',row.Id,row.Text));len>0&&_iselect.setIndexO(obj,0)}}),_itext=$.extend({},_ibase,{mask:function(box){_obj.getF("[data-mask!='']",box).each(function(){var me=$(this);me.mask(me.data("mask"))})}}),_itextarea=$.extend({},_ibase,{}),_json={copy:function(from,to){var to=to||{};for(var key in from)to[key]=from[key];return to},keyValuesToJson:function(keyValues,keyId,valueId){var data,i,row;if(keyValues===null||keyValues.length===0)return null;for(keyId||(keyId="Key"),valueId||(valueId="Value"),data={},i=0;i<keyValues.length;i++)row=keyValues[i],data["f"+row[keyId]]=row[valueId];return data},toStr:function(json){return _json.isEmpty(json)?"":JSON.stringify(json)},isEmpty:function(json){return json==null||$.isEmptyObject(json)},isKeyValue:function(value){return Object.prototype.toString.call(value)==="[object Object]"},urlToJson:function(url){url.indexOf("?")>-1&&(url=url.split("?")[1]);var pairs=url.split("&"),json={};return pairs.forEach(function(pair){pair=pair.split("=");pair[0]!==""&&(json[pair[0]]=decodeURIComponent(pair[1]||""))}),json},strToArray:function(str){return $.parseJSON(str)},findIndex:function(rows,fid,value){if(rows==null)return-1;for(var i=0;i<rows.length;i++)if(rows[i][fid]==value)return i;return-1},filterRows:function(rows,fid,value){return rows.filter(function(row){return row[fid]===value})},appendRows:function(froms,tos){var len,i;if(froms!=null&&froms.length!=0)for(len=tos.length,i=0;i<froms.length;i++)tos[len+i]=froms[i]},removeNull:function(obj,level){level=level||0;$.each(obj,function(key,value){var len,isEmpty,i;if(value===null)delete obj[key];else if(_json.isKeyValue(value))_json.removeNull(value,level+1);else if($.isArray(value)){if(len=value.length,len==0){delete obj[key];return}if(!_json.isKeyValue(value[0])){for(isEmpty=!0,i=0;i<len;i++)if(!_str.isEmpty(value[i])){isEmpty=!1;break}isEmpty&&delete obj[key];return}for($.each(value,function(k2,v2){_json.removeNull(v2,level+1);_json.isEmpty(v2)&&(v2=null)}),isEmpty=!0,i=len-1;i>=0;i--)_json.isEmpty(value[i])?isEmpty?delete value[i]:value[i]=null:isEmpty=!1;isEmpty&&delete obj[key]}});_json.isEmpty(obj)&&(obj=null)}},_leftmenu={init:function(){_leftmenu.menu=$(".xg-leftmenu");$(".xg-toggle").click(function(e){var me,arrow,clsName;e.preventDefault();me=$(this);me.next().collapse("toggle");arrow=me.find(".xg-arrow");clsName="xg-open";arrow.hasClass(clsName)?arrow.removeClass(clsName):arrow.addClass(clsName)})},onToggleMenu:function(){_leftmenu.menu.toggleClass("xg-close")}},_locale={},_log={_start:0,_now:0,info:function(msg){console.log(msg)},error:function(msg){alert(msg)},logTimeInit:function(name){_start=new Date;_now=_start;name&&console.log(name)},logTime:function(name){var now=new Date,msg=name+":"+(now-_now)+"/"+(now-_start);console.log(msg);_now=new Date}},_modal={show:function(id){$("#"+id).modal("show")},hide:function(id){$("#"+id).modal("hide")},showO:function(obj){obj.modal("show")},hideO:function(obj){obj.modal("hide")},showF:function(filter){$(filter).modal("show")},hideF:function(filter){$(filter).modal("hide")}},_nav={moveLeft:function(obj){obj.insertBefore(obj.prev())},moveRight:function(obj){obj.insertAfter(obj.next())}},_num={isBigZero:function(value,zero){return isNaN(value)?!1:zero||value!=="0"&&value!==0?parseInt(value)<0?!1:!0:!1},isNum:function(value){return!isNaN(value)},toBool:function(value){return value===1},rowToBool:function(row,fids){for(var fid,i=0;i<fids.length;i++)fid=fids[i],row[fid]=_num.toBool(row[fid]);return row},addComma:function(str){str+="";x=str.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";for(var rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1,$2");return x1+x2}},_obj={get:function(fid,box){return _obj.getF(_fun.fidFilter(fid),box)},getF:function(ft,box){var obj=box.find(ft);return obj.length==0?null:obj},getN:function(name,box){return _obj.getF("[name="+name+"]",box)},getV:function(val,box){return _obj.getF("[value="+val+"]",box)},getById:function(id,box){return _obj.getF("#"+id,box)},getId:function(obj){return obj.length>0?obj.attr("id"):""},getName:function(obj){return obj.length>0?obj.attr("name"):""},isShow:function(obj){return obj.is(":visible")},isExist:function(obj){return obj!==undefined&&obj!==null&&obj.length>0},hasAttr:function(obj){return obj.attr(attr)}},_pjax={init:function(boxFt){var docu=$(document);docu.pjax("[data-pjax]",boxFt,{type:"POST"});docu.on("pjax:error",function(event,xhr,textStatus,errorThrown,opts){return opts.success(xhr.responseText,textStatus,xhr),!1})}},_prog={me:null,oriPath:"",init:function(){_prog.me=$(".xg-prog-path");_prog.oriPath=_prog.me.text()},resetPath:function(){_prog.me.text(_prog.oriPath)},setPath:function(fun,updName){var name=fun==_fun.FunC?_BR.Create:fun==_fun.FunV?_BR.View:fun!=_fun.FunU?"??":_str.isEmpty(updName)?_BR.Update:updName;_prog.setFunName(name)},setFunName:function(name){_prog.me.text(_prog.oriPath+"-"+name)}},_qrcode={set:function(id,box,url,width){return _qrcode.setO(_obj.getById(id,box),url,width)},setO:function(obj,url,width){return width=width||128,new QRCode(obj[0],{text:url,width:width,height:width,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})}},_str={colSep:"@@",isEmpty:function(str){return str===undefined||str===null||str===""},notEmpty:function(str){return!_str.isEmpty(str)},emptyToStr:function(str,newStr){return _str.isEmpty(str)?newStr:str},format:function(){for(var reg,str=arguments[0],i=0;i<arguments.length-1;i++)reg=new RegExp("\\{"+i+"\\}","gm"),str=str.replace(reg,arguments[i+1]);return str},getMid:function(str,find1,find2){var pos,pos2;return _str.isEmpty(str)?"":(pos=str.indexOf(find1),pos<0)?str:(pos2=str.indexOf(find2,pos+1),pos2<0?str.substring(pos+find1.length):str.substring(pos+find1.length,pos2))},getTail:function(value,find){var pos=value.lastIndexOf(find);return pos>0?value.substring(pos+1):value},toBool:function(val){return val=="1"||val==!0||val=="True"},colsToStr:function(){for(var str=arguments[0],i=1;i<arguments.length;i++)str+=_str.colSep+arguments[i];return str},trim:function(str){return $.trim(str)}},_switch={getText:function(yes,no,width,status,inline,fid,cls){var inline2=inline?" xg-inline":"",attr=fid?' id="'+fid+'"':"",html;return status&&(attr+=" checked"),cls=cls?" "+cls:"",html='<label class="switch{5}" style="width:{2}px;"><input{3} class="switch-input{4}" type="checkbox" /><span class="switch-label" data-on="{0}" data-off="{1}"><\/span><span class="switch-handle"><\/span><\/label>',_str.format(html,yes,no,width,attr,cls,inline2)}},_tab={moveLeft:function(obj){obj.insertBefore(obj.prev())},moveRight:function(obj){obj.insertAfter(obj.next())}},_table={rowMoveUp:function(btn){var row=$(btn).closest("tr");row.insertBefore(row.prev())},rowMoveDown:function(btn){var row=$(btn).closest("tr");row.insertAfter(row.next())},rowFun:function(){return""+_str.format('<a href="javascript:_crud.onUpdate(\'{0}\');"><i class="ico-delete" title="{0}"><\/i><\/a>',key,_BR.TipUpdate)+_str.format('<a href="javascript:_table.rowMoveUp(this);"><i class="ico-up" title="{0}"><\/i><\/a>',_BR.TipUpdate)+_str.format('<a href="javascript:_table.rowMoveDown(this);"><i class="ico-down" title="{0}"><\/i><\/a>',_BR.TipUpdate)},getRowCount:function(table,fid){return table.find(_fun.fidFilter(fid)).length}},_temp={},_tool={init:function(){_tool.xgAlert=$("#xgAlert");_tool.xgMsg=$("#xgMsg");_tool.xgAns=$("#xgAns");_tool.xgArea=$("#xgArea");_tool.xgImage=$("#xgImage")},msg:function(msg,fnClose){var box=_tool.xgMsg;box.find(".xd-msg").html(msg);_modal.showO(box);_tool._fnOnMsgClose=fnClose},ans:function(msg,fnYes,fnNo){var box=_tool.xgAns;box.find(".xd-msg").html(msg);_modal.showO(box);_tool._fnOnAnsYes=fnYes;_tool._fnOnAnsNo=fnNo===undefined?null:fnNo},alert:function(msg){var box=_tool.xgAlert;box.find(".xd-msg").text(msg);box.fadeIn(500,function(){box.show();setTimeout(function(){_tool.onAlertClose()},5e3)})},showArea:function(title,value,isEdit,fnOk){var box=_tool.xgArea,obj;box.find(".modal-title").text(title);obj=box.find("textarea");obj.val(value);_itextarea.setEditO(obj,isEdit);_btn.setEditO(box.find(".xd-yes"),isEdit);isEdit&&(_tool._fnOnAreaYes=fnOk);_modal.showO(box)},onAreaYes:function(){var box=_tool.xgArea,value;_tool._fnOnAreaYes&&(_modal.hideO(box),value=box.find("textarea").val(),_tool._fnOnAreaYes(value))},showImage:function(fileName,imageSrc){var box=_tool.xgImage;box.find("img").attr("src",imageSrc);box.find("label").text(fileName);_modal.showO(box)},onAlertClose:function(){var box=_tool.xgAlert;box.fadeOut(500,function(){box.hide()})},onAnsYes:function(){_tool._fnOnAnsYes&&(_modal.hideO(_tool.xgAns),_tool._fnOnAnsYes())},onAnsNo:function(){_tool._fnOnAnsNo&&_tool._fnOnAnsNo();_modal.hideO(_tool.xgAns)},onMsgClose:function(){_tool._fnOnMsgClose&&_tool._fnOnMsgClose();_modal.hideO(_tool.xgMsg)}},_valid={init:function(form){form.removeData("validator");var config={ignore:":hidden:not(.xd-valid), .note-editable.panel-body",errorElement:"span",errorPlacement:function(error,elm){return error.insertAfter(_valid._getBox($(elm))),!1},highlight:function(elm,errorClass,validClass){var me=$(elm),box=_valid._getBox(me),obj;return box.removeClass(validClass).addClass(errorClass),obj=_valid._getError(me),obj!=null&&obj.show(),!1},unhighlight:function(elm,errorClass,validClass){var me=$(elm),box=_valid._getBox(me),obj;return box.removeClass(errorClass).addClass(validClass),obj=_valid._getError(me),obj!=null&&obj.hide(),!1}};return form.validate(config)},_getBox:function(obj){return obj.closest(".xi-box")},_getError:function(obj){var error=_valid._getBox(obj).next();return error.length==1&&error.hasClass("error")&&error.is("span")?error:null}},_var={emptyToValue:function(var1,value){return _str.isEmpty(var1)?value:var1},isEmpty:function(var1){return var1===undefined||var1===null},notEmpty:function(var1){return!_var.isEmpty(var1)},isPureData:function(value){return typeof value!="object"&&!Array.isArray(value)}},_openUser={init:function(fn,boxId){boxId=boxId||"ou";var filter="#_"+boxId,box=$(filter),ou={boxId:boxId,filter:filter,fn:fn,isRows:_iText.get("_IsRows",box)==1},config={filter:!0,columns:[{data:"_Fun"},{data:"Account"},{data:"Name"},],columnDefs:[_crudR.dtProp,{targets:[0],render:function(data,type,full){var value=_str.colsToStr(full.Id,full.Name,full.Account);return ou.isRows?_crudR.dtCheck0(value):_crudR.dtRadio1(value)}},]},table=ou.filter+" #_Table";return ou.dt=_datatable.init(table,"../OpenUser/GetPage",config),ou},show:function(ou){_iCheck.setF(ou.filter+" #_Table",!1);_modal.showF(ou.filter)},onClickFind:function(ou){var box=$(ou.filter);_datatable.find(ou.dt,null,_iText.get("Name",box))},onClickOk:function(ou){var box=$(ou.filter),keys,value;ou.isRows?(keys=_iCheck.getCheckeds(box,_icheck.Check0Id),keys.length==0?_tool.msg("請先選取資料。"):(ou.fn(keys),_modal.hideO(box))):(value=_iRadio.get(_iCheck.Check1Id,box),value==""?_tool.msg("請先選取資料。"):(ou.fn(value),_modal.hideO(box)))}},_xp={};